import { __decorate, __metadata, __param } from "tslib";
import { Inject, Injectable, Optional, RendererStyleFlags2, ViewEncapsulation } from '@angular/core';
import { addTaggedAdditionalCSS, Application, ContentView, getViewById, Observable, profile, View } from '@nativescript/core';
import { isKnownView } from './element-registry';
import { getFirstNativeLikeView, TextNode } from './views';
import { NAMESPACE_FILTERS } from './property-filter';
import { APP_ROOT_VIEW, ENABLE_REUSABE_VIEWS, NATIVESCRIPT_ROOT_MODULE_ID } from './tokens';
import { NativeScriptDebug } from './trace';
import { ViewUtil } from './view-util';
import * as i0 from "@angular/core";
import * as i1 from "@nativescript/core";
const addStyleToCss = profile('"renderer".addStyleToCss', function addStyleToCss(style, tag) {
    if (tag) {
        addTaggedAdditionalCSS(style, tag);
    }
    else {
        Application.addCss(style);
    }
});
function runInRootZone(fn) {
    if (typeof Zone === 'undefined') {
        return fn();
    }
    return Zone.root.run(fn);
}
function inRootZone() {
    return function (target, key, descriptor) {
        const childFunction = descriptor.value;
        descriptor.value = function (...args) {
            const fn = childFunction.bind(this);
            return runInRootZone(() => fn(...args));
        };
        return descriptor;
    };
}
let NativeScriptRendererFactory = class NativeScriptRendererFactory {
    constructor(rootView, namespaceFilters, rootModuleID, reuseViews) {
        this.rootView = rootView;
        this.namespaceFilters = namespaceFilters;
        this.rootModuleID = rootModuleID;
        this.reuseViews = reuseViews;
        this.componentRenderers = new Map();
        // backwards compatibility with RadListView
        this.viewUtil = new ViewUtil(this.namespaceFilters, this.reuseViews);
        if (typeof this.reuseViews !== 'boolean') {
            this.reuseViews = false; // default to false
        }
        this.defaultRenderer = new NativeScriptRenderer(rootView, namespaceFilters, this.reuseViews);
    }
    createRenderer(hostElement, type) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRendererFactory.createRenderer ${hostElement}. type.id: ${type.id} type.encapsulation: ${type.encapsulation}`);
        }
        if (!hostElement || !type) {
            return this.defaultRenderer;
        }
        let renderer = this.componentRenderers.get(type.id);
        /**
         *! WARNING
         *! We're reusing the renderer for the components
         *! this might cause unexpected behavior as the "rootView" is an arbitrary hostElement
         *! also, the renderer has it's .destroy() called!
         *! might be useful to create a BaseEmulatedRender and a ProxyEmulatedRender
         *! every component type gets a BaseEmulatedRender (singleton) which is passed to ProxyEmulatedRender
         *! ProxyEmulatedRenderer registers with BaseEmulatedRender so we can clean up things like CSS when it's not needed
         *! this might be useful if we find a way to HMR component styling without a full rebootstrap
         */
        if (renderer) {
            if (renderer instanceof EmulatedRenderer) {
                renderer.applyToHost(hostElement);
            }
            return renderer;
        }
        if (type.encapsulation === ViewEncapsulation.None) {
            type.styles.map((s) => s.toString()).forEach((v) => addStyleToCss(v, this.rootModuleID));
            renderer = this.defaultRenderer;
        }
        else {
            renderer = new EmulatedRenderer(type, hostElement, this.namespaceFilters, this.rootModuleID, this.reuseViews);
            renderer.applyToHost(hostElement);
        }
        this.componentRenderers.set(type.id, renderer);
        return renderer;
    }
    // begin?(): void {
    //     throw new Error("Method not implemented.");
    // }
    // end?(): void {
    //     throw new Error("Method not implemented.");
    // }
    whenRenderingDone() {
        if (!this.rootView) {
            return Promise.resolve();
        }
        return new Promise((resolve) => {
            let interval = 0;
            function scheduleResolve() {
                // iOS really hates synchronous things...
                // Utils.queueMacrotask(resolve);
                setTimeout(resolve, 15);
            }
            function fireWhenLoaded() {
                const view = rootFactory();
                if (view.isLoaded) {
                    scheduleResolve();
                }
                else {
                    view.once('loaded', scheduleResolve);
                }
            }
            const rootFactory = () => (this.rootView instanceof ContentView ? this.rootView.content : this.rootView);
            if (!rootFactory()) {
                interval = setInterval(() => {
                    if (rootFactory()) {
                        clearInterval(interval);
                        fireWhenLoaded();
                    }
                }, 10);
            }
            else {
                fireWhenLoaded();
            }
        });
        // throw new Error("Method not implemented.");
    }
};
NativeScriptRendererFactory = __decorate([
    __param(0, Inject(APP_ROOT_VIEW)),
    __param(1, Inject(NAMESPACE_FILTERS)),
    __param(2, Inject(NATIVESCRIPT_ROOT_MODULE_ID)),
    __param(3, Optional()),
    __param(3, Inject(ENABLE_REUSABE_VIEWS)),
    __metadata("design:paramtypes", [View, Array, Object, Object])
], NativeScriptRendererFactory);
export { NativeScriptRendererFactory };
class NativeScriptRenderer {
    constructor(rootView, namespaceFilters, reuseViews) {
        this.rootView = rootView;
        this.namespaceFilters = namespaceFilters;
        this.reuseViews = reuseViews;
        this.viewUtil = new ViewUtil(this.namespaceFilters, this.reuseViews);
        this.destroyNode = (node) => runInRootZone(() => {
            if (NativeScriptDebug.enabled) {
                NativeScriptDebug.rendererLog(`NativeScriptRenderer.destroyNode node: ${node}`);
            }
            if (node?.destroyNode) {
                node?.destroyNode();
            }
        });
    }
    get data() {
        throw new Error('Method not implemented.');
    }
    destroy() {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog('NativeScriptRenderer.destroy');
        }
    }
    createElement(name, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createElement: ${name}`);
        }
        let oldName;
        if (!isKnownView(name)) {
            oldName = name;
            name = 'ProxyViewContainer';
        }
        const view = this.viewUtil.createView(name);
        if (oldName) {
            view.customCSSName = oldName;
        }
        return view;
    }
    createComment(value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createComment ${value}`);
        }
        return this.viewUtil.createComment(value);
    }
    createText(value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createText ${value}`);
        }
        return this.viewUtil.createText(value);
    }
    appendChild(parent, newChild) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.appendChild child: ${newChild} parent: ${parent}`);
        }
        this.viewUtil.appendChild(parent, newChild);
    }
    insertBefore(parent, newChild, refChild) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.insertBefore child: ${newChild} ` + `parent: ${parent} refChild: ${refChild}`);
        }
        this.viewUtil.insertBefore(parent, newChild, refChild);
    }
    removeChild(parent, oldChild, isHostElement) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeChild child: ${oldChild} parent: ${parent}`);
        }
        this.viewUtil.removeChild(parent, oldChild);
    }
    selectRootElement(selectorOrNode, preserveContent) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.selectRootElement: ${selectorOrNode}`);
        }
        if (selectorOrNode instanceof View) {
            return selectorOrNode;
        }
        if (selectorOrNode && selectorOrNode[0] === '#') {
            const result = getViewById(this.rootView, selectorOrNode.slice(1));
            return (result || this.rootView);
        }
        if (typeof selectorOrNode === 'string') {
            const view = this.viewUtil.createView(selectorOrNode);
            if (getFirstNativeLikeView(view) === view) {
                // view is nativelike!
                this.appendChild(this.rootView, view);
                return view;
            }
        }
        return this.rootView;
    }
    parentNode(node) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.parentNode for node: ${node} is ${node.parentNode}`);
        }
        return node.parentNode;
    }
    nextSibling(node) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.nextSibling of ${node} is ${node.nextSibling}`);
        }
        return node.nextSibling;
    }
    setAttribute(el, name, value, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setAttribute ${namespace ? namespace + ':' : ''}${el}.${name} = ${value}`);
        }
        this.viewUtil.setProperty(el, name, value, namespace);
    }
    removeAttribute(el, name, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeAttribute ${namespace ? namespace + ':' : ''}${el}.${name}`);
        }
    }
    addClass(el, name) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.addClass ${name}`);
        }
        this.viewUtil.addClass(el, name);
    }
    removeClass(el, name) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeClass ${name}`);
        }
        this.viewUtil.removeClass(el, name);
    }
    setStyle(el, style, value, flags) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setStyle: ${el}, ${style} = ${value}`);
        }
        this.viewUtil.setStyle(el, style, value);
    }
    removeStyle(el, style, flags) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog('NativeScriptRenderer.removeStyle: ${styleName}');
        }
        this.viewUtil.removeStyle(el, style);
    }
    setProperty(el, name, value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setProperty ${el}.${name} = ${value}`);
        }
        this.viewUtil.setProperty(el, name, value);
    }
    setValue(node, value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setValue renderNode: ${node}, value: ${value}`);
        }
        if (node instanceof TextNode) {
            node.text = value;
        }
        // throw new Error("Method not implemented.");
    }
    listen(target, eventName, callback) {
        // throw new Error("Method not implemented.");
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.listen: ${eventName}`);
        }
        target.on(eventName, callback);
        if (eventName === View.loadedEvent && target.isLoaded) {
            // we must create a new obervable here to ensure that the event goes through whatever zone patches are applied
            const obs = new Observable();
            obs.once(eventName, callback);
            obs.notify({
                eventName,
                object: target,
            });
        }
        return () => target.off(eventName, callback);
    }
}
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "createElement", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "createComment", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "createText", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [View, View]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "appendChild", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object, Object]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "insertBefore", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object, Boolean]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "removeChild", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setAttribute", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "addClass", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "removeClass", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, Object, Number]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setStyle", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, Number]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "removeStyle", null);
__decorate([
    inRootZone(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, Object]),
    __metadata("design:returntype", void 0)
], NativeScriptRenderer.prototype, "setProperty", null);
// CONTENT_ATTR not exported from nativescript-renderer - we need it for styles application.
const COMPONENT_REGEX = /%COMP%/g;
const ATTR_SANITIZER = /-/g;
export const COMPONENT_VARIABLE = '%COMP%';
export const HOST_ATTR = `_nghost-${COMPONENT_VARIABLE}`;
export const CONTENT_ATTR = `_ngcontent-${COMPONENT_VARIABLE}`;
const replaceNgAttribute = function (input, componentId) {
    return input.replace(COMPONENT_REGEX, componentId);
};
const addScopedStyleToCss = profile(`"renderer".addScopedStyleToCss`, function addScopedStyleToCss(style, tag) {
    if (tag) {
        addTaggedAdditionalCSS(style, tag);
    }
    else {
        Application.addCss(style);
    }
});
class EmulatedRenderer extends NativeScriptRenderer {
    constructor(component, rootView, namespaceFilters, rootModuleId, reuseViews) {
        super(rootView, namespaceFilters, reuseViews);
        this.rootModuleId = rootModuleId;
        const componentId = component.id.replace(ATTR_SANITIZER, '_');
        this.contentAttr = replaceNgAttribute(CONTENT_ATTR, componentId);
        this.hostAttr = replaceNgAttribute(HOST_ATTR, componentId);
        this.addStyles(component.styles, componentId);
    }
    applyToHost(view) {
        super.setAttribute(view, this.hostAttr, '');
    }
    appendChild(parent, newChild) {
        super.appendChild(parent, newChild);
    }
    createElement(parent, name) {
        const view = super.createElement(parent, name);
        // Set an attribute to the view to scope component-specific css.
        // The property name is pre-generated by Angular.
        super.setAttribute(view, this.contentAttr, '');
        return view;
    }
    addStyles(styles, componentId) {
        styles
            .map((s) => s.toString())
            .map((s) => replaceNgAttribute(s, componentId))
            .forEach((s) => addScopedStyleToCss(s, this.rootModuleId));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: EmulatedRenderer, deps: "invalid", target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: EmulatedRenderer }); }
}
__decorate([
    profile,
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Array, String]),
    __metadata("design:returntype", void 0)
], EmulatedRenderer.prototype, "addStyles", null);
export { EmulatedRenderer };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: EmulatedRenderer, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined }, { type: i1.View }, { type: undefined }, { type: undefined }, { type: undefined }]; }, propDecorators: { addStyles: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlc2NyaXB0LXJlbmRlcmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhci9zcmMvbGliL25hdGl2ZXNjcmlwdC1yZW5kZXJlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQVUsUUFBUSxFQUErQixtQkFBbUIsRUFBaUIsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekosT0FBTyxFQUFFLHNCQUFzQixFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQVUsV0FBVyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQVMsSUFBSSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDN0ksT0FBTyxFQUFnQixXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsc0JBQXNCLEVBQVUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRW5FLE9BQU8sRUFBbUIsaUJBQWlCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsYUFBYSxFQUFFLG9CQUFvQixFQUFFLDJCQUEyQixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQzVGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUM1QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDOzs7QUFFdkMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixFQUFFLFNBQVMsYUFBYSxDQUFDLEtBQWEsRUFBRSxHQUFxQjtJQUNuSCxJQUFJLEdBQUcsRUFBRTtRQUNQLHNCQUFzQixDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztLQUNwQztTQUFNO1FBQ0wsV0FBVyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztLQUMzQjtBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxhQUFhLENBQUksRUFBVztJQUNuQyxJQUFJ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Z0JBQWdCO2tCQUQ1QixVQUFVOytLQWlDRCxTQUFTIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBOZ1pvbmUsIE9wdGlvbmFsLCBSZW5kZXJlcjIsIFJlbmRlcmVyRmFjdG9yeTIsIFJlbmRlcmVyU3R5bGVGbGFnczIsIFJlbmRlcmVyVHlwZTIsIFZpZXdFbmNhcHN1bGF0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBhZGRUYWdnZWRBZGRpdGlvbmFsQ1NTLCBBcHBsaWNhdGlvbiwgQ29udGVudFZpZXcsIERldmljZSwgZ2V0Vmlld0J5SWQsIE9ic2VydmFibGUsIHByb2ZpbGUsIFV0aWxzLCBWaWV3IH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcbmltcG9ydCB7IGdldFZpZXdDbGFzcywgaXNLbm93blZpZXcgfSBmcm9tICcuL2VsZW1lbnQtcmVnaXN0cnknO1xuaW1wb3J0IHsgZ2V0Rmlyc3ROYXRpdmVMaWtlVmlldywgTmdWaWV3LCBUZXh0Tm9kZSB9IGZyb20gJy4vdmlld3MnO1xuXG5pbXBvcnQgeyBOYW1lc3BhY2VGaWx0ZXIsIE5BTUVTUEFDRV9GSUxURVJTIH0gZnJvbSAnLi9wcm9wZXJ0eS1maWx0ZXInO1xuaW1wb3J0IHsgQVBQX1JPT1RfVklFVywgRU5BQkxFX1JFVVNBQkVfVklFV1MsIE5BVElWRVNDUklQVF9ST09UX01PRFVMRV9JRCB9IGZyb20gJy4vdG9rZW5zJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi90cmFjZSc7XG5pbXBvcnQgeyBWaWV3VXRpbCB9IGZyb20gJy4vdmlldy11dGlsJztcblxuY29uc3QgYWRkU3R5bGVUb0NzcyA9IHByb2ZpbGUoJ1wicmVuZGVyZXJcIi5hZGRTdHlsZVRvQ3NzJywgZnVuY3Rpb24gYWRkU3R5bGVUb0NzcyhzdHlsZTogc3RyaW5nLCB0YWc/OiBzdHJpbmcgfCBudW1iZXIpOiB2b2lkIHtcbiAgaWYgKHRhZykge1xuICAgIGFkZFRhZ2dlZEFkZGl0aW9uYWxDU1Moc3R5bGUsIHRhZyk7XG4gIH0gZWxzZSB7XG4gICAgQXBwbGljYXRpb24uYWRkQ3NzKHN0eWxlKTtcbiAgfVxufSk7XG5cbmZ1bmN0aW9uIHJ1bkluUm9vdFpvbmU8VD4oZm46ICgpID0+IFQpOiBUIHtcbiAgaWYgKHR5cGVvZiBab25lID09PSAndW5kZWZpbmVkJykge1xuICAgIHJldHVybiBmbigpO1xuICB9XG4gIHJldHVybiBab25lLnJvb3QucnVuKGZuKTtcbn1cblxuZnVuY3Rpb24gaW5Sb290Wm9uZSgpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQ6IHVua25vd24sIGtleTogc3RyaW5nIHwgc3ltYm9sLCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3IpIHtcbiAgICBjb25zdCBjaGlsZEZ1bmN0aW9uID0gZGVzY3JpcHRvci52YWx1ZTtcbiAgICBkZXNjcmlwdG9yLnZhbHVlID0gZnVuY3Rpb24gKC4uLmFyZ3M6IHVua25vd25bXSkge1xuICAgICAgY29uc3QgZm4gPSBjaGlsZEZ1bmN0aW9uLmJpbmQodGhpcyk7XG4gICAgICByZXR1cm4gcnVuSW5Sb290Wm9uZSgoKSA9PiBmbiguLi5hcmdzKSk7XG4gICAgfTtcbiAgICByZXR1cm4gZGVzY3JpcHRvcjtcbiAgfTtcbn1cblxuZXhwb3J0IGNsYXNzIE5hdGl2ZVNjcmlwdFJlbmRlcmVyRmFjdG9yeSBpbXBsZW1lbnRzIFJlbmRlcmVyRmFjdG9yeTIge1xuICBwcml2YXRlIGNvbXBvbmVudFJlbmRlcmVycyA9IG5ldyBNYXA8c3RyaW5nLCBSZW5kZXJlcjI+KCk7XG4gIHByaXZhdGUgZGVmYXVsdFJlbmRlcmVyOiBSZW5kZXJlcjI7XG4gIC8vIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggUmFkTGlzdFZpZXdcbiAgcHJpdmF0ZSB2aWV3VXRpbCA9IG5ldyBWaWV3VXRpbCh0aGlzLm5hbWVzcGFjZUZpbHRlcnMsIHRoaXMucmV1c2VWaWV3cyk7XG5cbiAgY29uc3RydWN0b3IoQEluamVjdChBUFBfUk9PVF9WSUVXKSBwcml2YXRlIHJvb3RWaWV3OiBWaWV3LCBASW5qZWN0KE5BTUVTUEFDRV9GSUxURVJTKSBwcml2YXRlIG5hbWVzcGFjZUZpbHRlcnM6IE5hbWVzcGFjZUZpbHRlcltdLCBASW5qZWN0KE5BVElWRVNDUklQVF9ST09UX01PRFVMRV9JRCkgcHJpdmF0ZSByb290TW9kdWxlSUQ6IHN0cmluZyB8IG51bWJlciwgQE9wdGlvbmFsKCkgQEluamVjdChFTkFCTEVfUkVVU0FCRV9WSUVXUykgcHJpdmF0ZSByZXVzZVZpZXdzKSB7XG4gICAgaWYgKHR5cGVvZiB0aGlzLnJldXNlVmlld3MgIT09ICdib29sZWFuJykge1xuICAgICAgdGhpcy5yZXVzZVZpZXdzID0gZmFsc2U7IC8vIGRlZmF1bHQgdG8gZmFsc2VcbiAgICB9XG4gICAgdGhpcy5kZWZhdWx0UmVuZGVyZXIgPSBuZXcgTmF0aXZlU2NyaXB0UmVuZGVyZXIocm9vdFZpZXcsIG5hbWVzcGFjZUZpbHRlcnMsIHRoaXMucmV1c2VWaWV3cyk7XG4gIH1cbiAgY3JlYXRlUmVuZGVyZXIoaG9zdEVsZW1lbnQ6IGFueSwgdHlwZTogUmVuZGVyZXJUeXBlMik6IFJlbmRlcmVyMiB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlckZhY3RvcnkuY3JlYXRlUmVuZGVyZXIgJHtob3N0RWxlbWVudH0uIHR5cGUuaWQ6ICR7dHlwZS5pZH0gdHlwZS5lbmNhcHN1bGF0aW9uOiAke3R5cGUuZW5jYXBzdWxhdGlvbn1gKTtcbiAgICB9XG4gICAgaWYgKCFob3N0RWxlbWVudCB8fCAhdHlwZSkge1xuICAgICAgcmV0dXJuIHRoaXMuZGVmYXVsdFJlbmRlcmVyO1xuICAgIH1cblxuICAgIGxldCByZW5kZXJlciA9IHRoaXMuY29tcG9uZW50UmVuZGVyZXJzLmdldCh0eXBlLmlkKTtcbiAgICAvKipcbiAgICAgKiEgV0FSTklOR1xuICAgICAqISBXZSdyZSByZXVzaW5nIHRoZSByZW5kZXJlciBmb3IgdGhlIGNvbXBvbmVudHNcbiAgICAgKiEgdGhpcyBtaWdodCBjYXVzZSB1bmV4cGVjdGVkIGJlaGF2aW9yIGFzIHRoZSBcInJvb3RWaWV3XCIgaXMgYW4gYXJiaXRyYXJ5IGhvc3RFbGVtZW50XG4gICAgICohIGFsc28sIHRoZSByZW5kZXJlciBoYXMgaXQncyAuZGVzdHJveSgpIGNhbGxlZCFcbiAgICAgKiEgbWlnaHQgYmUgdXNlZnVsIHRvIGNyZWF0ZSBhIEJhc2VFbXVsYXRlZFJlbmRlciBhbmQgYSBQcm94eUVtdWxhdGVkUmVuZGVyXG4gICAgICohIGV2ZXJ5IGNvbXBvbmVudCB0eXBlIGdldHMgYSBCYXNlRW11bGF0ZWRSZW5kZXIgKHNpbmdsZXRvbikgd2hpY2ggaXMgcGFzc2VkIHRvIFByb3h5RW11bGF0ZWRSZW5kZXJcbiAgICAgKiEgUHJveHlFbXVsYXRlZFJlbmRlcmVyIHJlZ2lzdGVycyB3aXRoIEJhc2VFbXVsYXRlZFJlbmRlciBzbyB3ZSBjYW4gY2xlYW4gdXAgdGhpbmdzIGxpa2UgQ1NTIHdoZW4gaXQncyBub3QgbmVlZGVkXG4gICAgICohIHRoaXMgbWlnaHQgYmUgdXNlZnVsIGlmIHdlIGZpbmQgYSB3YXkgdG8gSE1SIGNvbXBvbmVudCBzdHlsaW5nIHdpdGhvdXQgYSBmdWxsIHJlYm9vdHN0cmFwXG4gICAgICovXG4gICAgaWYgKHJlbmRlcmVyKSB7XG4gICAgICBpZiAocmVuZGVyZXIgaW5zdGFuY2VvZiBFbXVsYXRlZFJlbmRlcmVyKSB7XG4gICAgICAgIHJlbmRlcmVyLmFwcGx5VG9Ib3N0KGhvc3RFbGVtZW50KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlbmRlcmVyO1xuICAgIH1cblxuICAgIGlmICh0eXBlLmVuY2Fwc3VsYXRpb24gPT09IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUpIHtcbiAgICAgIHR5cGUuc3R5bGVzLm1hcCgocykgPT4gcy50b1N0cmluZygpKS5mb3JFYWNoKCh2KSA9PiBhZGRTdHlsZVRvQ3NzKHYsIHRoaXMucm9vdE1vZHVsZUlEKSk7XG4gICAgICByZW5kZXJlciA9IHRoaXMuZGVmYXVsdFJlbmRlcmVyO1xuICAgIH0gZWxzZSB7XG4gICAgICByZW5kZXJlciA9IG5ldyBFbXVsYXRlZFJlbmRlcmVyKHR5cGUsIGhvc3RFbGVtZW50LCB0aGlzLm5hbWVzcGFjZUZpbHRlcnMsIHRoaXMucm9vdE1vZHVsZUlELCB0aGlzLnJldXNlVmlld3MpO1xuICAgICAgKDxFbXVsYXRlZFJlbmRlcmVyPnJlbmRlcmVyKS5hcHBseVRvSG9zdChob3N0RWxlbWVudCk7XG4gICAgfVxuXG4gICAgdGhpcy5jb21wb25lbnRSZW5kZXJlcnMuc2V0KHR5cGUuaWQsIHJlbmRlcmVyKTtcbiAgICByZXR1cm4gcmVuZGVyZXI7XG4gIH1cbiAgLy8gYmVnaW4/KCk6IHZvaWQge1xuICAvLyAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XG4gIC8vIH1cbiAgLy8gZW5kPygpOiB2b2lkIHtcbiAgLy8gICAgIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xuICAvLyB9XG4gIHdoZW5SZW5kZXJpbmdEb25lKCk6IFByb21pc2U8YW55PiB7XG4gICAgaWYgKCF0aGlzLnJvb3RWaWV3KSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSkgPT4ge1xuICAgICAgbGV0IGludGVydmFsOiBhbnkgPSAwO1xuICAgICAgZnVuY3Rpb24gc2NoZWR1bGVSZXNvbHZlKCkge1xuICAgICAgICAvLyBpT1MgcmVhbGx5IGhhdGVzIHN5bmNocm9ub3VzIHRoaW5ncy4uLlxuICAgICAgICAvLyBVdGlscy5xdWV1ZU1hY3JvdGFzayhyZXNvbHZlKTtcbiAgICAgICAgc2V0VGltZW91dChyZXNvbHZlLCAxNSk7XG4gICAgICB9XG4gICAgICBmdW5jdGlvbiBmaXJlV2hlbkxvYWRlZCgpIHtcbiAgICAgICAgY29uc3QgdmlldyA9IHJvb3RGYWN0b3J5KCk7XG4gICAgICAgIGlmICh2aWV3LmlzTG9hZGVkKSB7XG4gICAgICAgICAgc2NoZWR1bGVSZXNvbHZlKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdmlldy5vbmNlKCdsb2FkZWQnLCBzY2hlZHVsZVJlc29sdmUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCByb290RmFjdG9yeSA9ICgpID0+ICh0aGlzLnJvb3RWaWV3IGluc3RhbmNlb2YgQ29udGVudFZpZXcgPyB0aGlzLnJvb3RWaWV3LmNvbnRlbnQgOiB0aGlzLnJvb3RWaWV3KTtcbiAgICAgIGlmICghcm9vdEZhY3RvcnkoKSkge1xuICAgICAgICBpbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgICBpZiAocm9vdEZhY3RvcnkoKSkge1xuICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgICAgICAgICBmaXJlV2hlbkxvYWRlZCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgMTApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmlyZVdoZW5Mb2FkZWQoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICAvLyB0aHJvdyBuZXcgRXJyb3IoXCJNZXRob2Qgbm90IGltcGxlbWVudGVkLlwiKTtcbiAgfVxufVxuXG5jbGFzcyBOYXRpdmVTY3JpcHRSZW5kZXJlciBpbXBsZW1lbnRzIFJlbmRlcmVyMiB7XG4gIHByaXZhdGUgdmlld1V0aWwgPSBuZXcgVmlld1V0aWwodGhpcy5uYW1lc3BhY2VGaWx0ZXJzLCB0aGlzLnJldXNlVmlld3MpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcm9vdFZpZXc6IFZpZXcsIHByaXZhdGUgbmFtZXNwYWNlRmlsdGVycz86IE5hbWVzcGFjZUZpbHRlcltdLCBwcml2YXRlIHJldXNlVmlld3M/OiBib29sZWFuKSB7fVxuICBnZXQgZGF0YSgpOiB7IFtrZXk6IHN0cmluZ106IGFueSB9IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ01ldGhvZCBub3QgaW1wbGVtZW50ZWQuJyk7XG4gIH1cbiAgZGVzdHJveSgpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coJ05hdGl2ZVNjcmlwdFJlbmRlcmVyLmRlc3Ryb3knKTtcbiAgICB9XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICBjcmVhdGVFbGVtZW50KG5hbWU6IHN0cmluZywgbmFtZXNwYWNlPzogc3RyaW5nKSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5jcmVhdGVFbGVtZW50OiAke25hbWV9YCk7XG4gICAgfVxuICAgIGxldCBvbGROYW1lO1xuICAgIGlmICghaXNLbm93blZpZXcobmFtZSkpIHtcbiAgICAgIG9sZE5hbWUgPSBuYW1lO1xuICAgICAgbmFtZSA9ICdQcm94eVZpZXdDb250YWluZXInO1xuICAgIH1cbiAgICBjb25zdCB2aWV3ID0gdGhpcy52aWV3VXRpbC5jcmVhdGVWaWV3KG5hbWUpO1xuICAgIGlmIChvbGROYW1lKSB7XG4gICAgICAodmlldyBhcyBhbnkpLmN1c3RvbUNTU05hbWUgPSBvbGROYW1lO1xuICAgIH1cbiAgICByZXR1cm4gdmlldztcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIGNyZWF0ZUNvbW1lbnQodmFsdWU6IHN0cmluZykge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuY3JlYXRlQ29tbWVudCAke3ZhbHVlfWApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy52aWV3VXRpbC5jcmVhdGVDb21tZW50KHZhbHVlKTtcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIGNyZWF0ZVRleHQodmFsdWU6IHN0cmluZykge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuY3JlYXRlVGV4dCAke3ZhbHVlfWApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy52aWV3VXRpbC5jcmVhdGVUZXh0KHZhbHVlKTtcbiAgfVxuICBkZXN0cm95Tm9kZTogKG5vZGU6IGFueSkgPT4gdm9pZCA9IChub2RlOiBWaWV3KSA9PlxuICAgIHJ1bkluUm9vdFpvbmUoKCkgPT4ge1xuICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmRlc3Ryb3lOb2RlIG5vZGU6ICR7bm9kZX1gKTtcbiAgICAgIH1cbiAgICAgIGlmIChub2RlPy5kZXN0cm95Tm9kZSkge1xuICAgICAgICBub2RlPy5kZXN0cm95Tm9kZSgpO1xuICAgICAgfVxuICAgIH0pO1xuICBAaW5Sb290Wm9uZSgpXG4gIGFwcGVuZENoaWxkKHBhcmVudDogVmlldywgbmV3Q2hpbGQ6IFZpZXcpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmFwcGVuZENoaWxkIGNoaWxkOiAke25ld0NoaWxkfSBwYXJlbnQ6ICR7cGFyZW50fWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLmFwcGVuZENoaWxkKHBhcmVudCwgbmV3Q2hpbGQpO1xuICB9XG4gIEBpblJvb3Rab25lKClcbiAgaW5zZXJ0QmVmb3JlKHBhcmVudDogYW55LCBuZXdDaGlsZDogYW55LCByZWZDaGlsZDogYW55KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5pbnNlcnRCZWZvcmUgY2hpbGQ6ICR7bmV3Q2hpbGR9IGAgKyBgcGFyZW50OiAke3BhcmVudH0gcmVmQ2hpbGQ6ICR7cmVmQ2hpbGR9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwuaW5zZXJ0QmVmb3JlKHBhcmVudCwgbmV3Q2hpbGQsIHJlZkNoaWxkKTtcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIHJlbW92ZUNoaWxkKHBhcmVudDogYW55LCBvbGRDaGlsZDogYW55LCBpc0hvc3RFbGVtZW50PzogYm9vbGVhbik6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIucmVtb3ZlQ2hpbGQgY2hpbGQ6ICR7b2xkQ2hpbGR9IHBhcmVudDogJHtwYXJlbnR9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwucmVtb3ZlQ2hpbGQocGFyZW50LCBvbGRDaGlsZCk7XG4gIH1cbiAgc2VsZWN0Um9vdEVsZW1lbnQoc2VsZWN0b3JPck5vZGU6IGFueSwgcHJlc2VydmVDb250ZW50PzogYm9vbGVhbikge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuc2VsZWN0Um9vdEVsZW1lbnQ6ICR7c2VsZWN0b3JPck5vZGV9YCk7XG4gICAgfVxuICAgIGlmIChzZWxlY3Rvck9yTm9kZSBpbnN0YW5jZW9mIFZpZXcpIHtcbiAgICAgIHJldHVybiBzZWxlY3Rvck9yTm9kZTtcbiAgICB9XG4gICAgaWYgKHNlbGVjdG9yT3JOb2RlICYmIHNlbGVjdG9yT3JOb2RlWzBdID09PSAnIycpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGdldFZpZXdCeUlkKHRoaXMucm9vdFZpZXcsIHNlbGVjdG9yT3JOb2RlLnNsaWNlKDEpKTtcbiAgICAgIHJldHVybiAocmVzdWx0IHx8IHRoaXMucm9vdFZpZXcpIGFzIFZpZXc7XG4gICAgfVxuICAgIGlmICh0eXBlb2Ygc2VsZWN0b3JPck5vZGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICBjb25zdCB2aWV3ID0gdGhpcy52aWV3VXRpbC5jcmVhdGVWaWV3KHNlbGVjdG9yT3JOb2RlKTtcbiAgICAgIGlmIChnZXRGaXJzdE5hdGl2ZUxpa2VWaWV3KHZpZXcpID09PSB2aWV3KSB7XG4gICAgICAgIC8vIHZpZXcgaXMgbmF0aXZlbGlrZSFcbiAgICAgICAgdGhpcy5hcHBlbmRDaGlsZCh0aGlzLnJvb3RWaWV3LCB2aWV3KTtcbiAgICAgICAgcmV0dXJuIHZpZXc7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnJvb3RWaWV3O1xuICB9XG4gIHBhcmVudE5vZGUobm9kZTogTmdWaWV3KSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5wYXJlbnROb2RlIGZvciBub2RlOiAke25vZGV9IGlzICR7bm9kZS5wYXJlbnROb2RlfWApO1xuICAgIH1cbiAgICByZXR1cm4gbm9kZS5wYXJlbnROb2RlO1xuICB9XG4gIG5leHRTaWJsaW5nKG5vZGU6IE5nVmlldykge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIubmV4dFNpYmxpbmcgb2YgJHtub2RlfSBpcyAke25vZGUubmV4dFNpYmxpbmd9YCk7XG4gICAgfVxuICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nO1xuICB9XG4gIEBpblJvb3Rab25lKClcbiAgc2V0QXR0cmlidXRlKGVsOiBhbnksIG5hbWU6IHN0cmluZywgdmFsdWU6IHN0cmluZywgbmFtZXNwYWNlPzogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5zZXRBdHRyaWJ1dGUgJHtuYW1lc3BhY2UgPyBuYW1lc3BhY2UgKyAnOicgOiAnJ30ke2VsfS4ke25hbWV9ID0gJHt2YWx1ZX1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5zZXRQcm9wZXJ0eShlbCwgbmFtZSwgdmFsdWUsIG5hbWVzcGFjZSk7XG4gIH1cbiAgcmVtb3ZlQXR0cmlidXRlKGVsOiBhbnksIG5hbWU6IHN0cmluZywgbmFtZXNwYWNlPzogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5yZW1vdmVBdHRyaWJ1dGUgJHtuYW1lc3BhY2UgPyBuYW1lc3BhY2UgKyAnOicgOiAnJ30ke2VsfS4ke25hbWV9YCk7XG4gICAgfVxuICB9XG4gIEBpblJvb3Rab25lKClcbiAgYWRkQ2xhc3MoZWw6IGFueSwgbmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5hZGRDbGFzcyAke25hbWV9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwuYWRkQ2xhc3MoZWwsIG5hbWUpO1xuICB9XG4gIEBpblJvb3Rab25lKClcbiAgcmVtb3ZlQ2xhc3MoZWw6IGFueSwgbmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5yZW1vdmVDbGFzcyAke25hbWV9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwucmVtb3ZlQ2xhc3MoZWwsIG5hbWUpO1xuICB9XG4gIEBpblJvb3Rab25lKClcbiAgc2V0U3R5bGUoZWw6IGFueSwgc3R5bGU6IHN0cmluZywgdmFsdWU6IGFueSwgZmxhZ3M/OiBSZW5kZXJlclN0eWxlRmxhZ3MyKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5zZXRTdHlsZTogJHtlbH0sICR7c3R5bGV9ID0gJHt2YWx1ZX1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5zZXRTdHlsZShlbCwgc3R5bGUsIHZhbHVlKTtcbiAgfVxuICBAaW5Sb290Wm9uZSgpXG4gIHJlbW92ZVN0eWxlKGVsOiBhbnksIHN0eWxlOiBzdHJpbmcsIGZsYWdzPzogUmVuZGVyZXJTdHlsZUZsYWdzMik6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZygnTmF0aXZlU2NyaXB0UmVuZGVyZXIucmVtb3ZlU3R5bGU6ICR7c3R5bGVOYW1lfScpO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLnJlbW92ZVN0eWxlKGVsLCBzdHlsZSk7XG4gIH1cbiAgQGluUm9vdFpvbmUoKVxuICBzZXRQcm9wZXJ0eShlbDogYW55LCBuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLnNldFByb3BlcnR5ICR7ZWx9LiR7bmFtZX0gPSAke3ZhbHVlfWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLnNldFByb3BlcnR5KGVsLCBuYW1lLCB2YWx1ZSk7XG4gIH1cbiAgc2V0VmFsdWUobm9kZTogYW55LCB2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5zZXRWYWx1ZSByZW5kZXJOb2RlOiAke25vZGV9LCB2YWx1ZTogJHt2YWx1ZX1gKTtcbiAgICB9XG4gICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBUZXh0Tm9kZSkge1xuICAgICAgbm9kZS50ZXh0ID0gdmFsdWU7XG4gICAgfVxuICAgIC8vIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xuICB9XG4gIGxpc3Rlbih0YXJnZXQ6IFZpZXcsIGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsYmFjazogKGV2ZW50OiBhbnkpID0+IGJvb2xlYW4gfCB2b2lkKTogKCkgPT4gdm9pZCB7XG4gICAgLy8gdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5saXN0ZW46ICR7ZXZlbnROYW1lfWApO1xuICAgIH1cbiAgICB0YXJnZXQub24oZXZlbnROYW1lLCBjYWxsYmFjayk7XG4gICAgaWYgKGV2ZW50TmFtZSA9PT0gVmlldy5sb2FkZWRFdmVudCAmJiB0YXJnZXQuaXNMb2FkZWQpIHtcbiAgICAgIC8vIHdlIG11c3QgY3JlYXRlIGEgbmV3IG9iZXJ2YWJsZSBoZXJlIHRvIGVuc3VyZSB0aGF0IHRoZSBldmVudCBnb2VzIHRocm91Z2ggd2hhdGV2ZXIgem9uZSBwYXRjaGVzIGFyZSBhcHBsaWVkXG4gICAgICBjb25zdCBvYnMgPSBuZXcgT2JzZXJ2YWJsZSgpO1xuICAgICAgb2JzLm9uY2UoZXZlbnROYW1lLCBjYWxsYmFjayk7XG4gICAgICBvYnMubm90aWZ5KHtcbiAgICAgICAgZXZlbnROYW1lLFxuICAgICAgICBvYmplY3Q6IHRhcmdldCxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gKCkgPT4gdGFyZ2V0Lm9mZihldmVudE5hbWUsIGNhbGxiYWNrKTtcbiAgfVxufVxuXG4vLyBDT05URU5UX0FUVFIgbm90IGV4cG9ydGVkIGZyb20gbmF0aXZlc2NyaXB0LXJlbmRlcmVyIC0gd2UgbmVlZCBpdCBmb3Igc3R5bGVzIGFwcGxpY2F0aW9uLlxuY29uc3QgQ09NUE9ORU5UX1JFR0VYID0gLyVDT01QJS9nO1xuY29uc3QgQVRUUl9TQU5JVElaRVIgPSAvLS9nO1xuZXhwb3J0IGNvbnN0IENPTVBPTkVOVF9WQVJJQUJMRSA9ICclQ09NUCUnO1xuZXhwb3J0IGNvbnN0IEhPU1RfQVRUUiA9IGBfbmdob3N0LSR7Q09NUE9ORU5UX1ZBUklBQkxFfWA7XG5leHBvcnQgY29uc3QgQ09OVEVOVF9BVFRSID0gYF9uZ2NvbnRlbnQtJHtDT01QT05FTlRfVkFSSUFCTEV9YDtcblxuY29uc3QgcmVwbGFjZU5nQXR0cmlidXRlID0gZnVuY3Rpb24gKGlucHV0OiBzdHJpbmcsIGNvbXBvbmVudElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gaW5wdXQucmVwbGFjZShDT01QT05FTlRfUkVHRVgsIGNvbXBvbmVudElkKTtcbn07XG5cbmNvbnN0IGFkZFNjb3BlZFN0eWxlVG9Dc3MgPSBwcm9maWxlKGBcInJlbmRlcmVyXCIuYWRkU2NvcGVkU3R5bGVUb0Nzc2AsIGZ1bmN0aW9uIGFkZFNjb3BlZFN0eWxlVG9Dc3Moc3R5bGU6IHN0cmluZywgdGFnPzogbnVtYmVyIHwgc3RyaW5nKTogdm9pZCB7XG4gIGlmICh0YWcpIHtcbiAgICBhZGRUYWdnZWRBZGRpdGlvbmFsQ1NTKHN0eWxlLCB0YWcpO1xuICB9IGVsc2Uge1xuICAgIEFwcGxpY2F0aW9uLmFkZENzcyhzdHlsZSk7XG4gIH1cbn0pO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRW11bGF0ZWRSZW5kZXJlciBleHRlbmRzIE5hdGl2ZVNjcmlwdFJlbmRlcmVyIHtcbiAgcHJpdmF0ZSBjb250ZW50QXR0cjogc3RyaW5nO1xuICBwcml2YXRlIGhvc3RBdHRyOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoY29tcG9uZW50OiBSZW5kZXJlclR5cGUyLCByb290VmlldzogVmlldywgbmFtZXNwYWNlRmlsdGVyczogTmFtZXNwYWNlRmlsdGVyW10sIHByaXZhdGUgcm9vdE1vZHVsZUlkOiBzdHJpbmcgfCBudW1iZXIsIHJldXNlVmlld3M6IGJvb2xlYW4pIHtcbiAgICBzdXBlcihyb290VmlldywgbmFtZXNwYWNlRmlsdGVycywgcmV1c2VWaWV3cyk7XG5cbiAgICBjb25zdCBjb21wb25lbnRJZCA9IGNvbXBvbmVudC5pZC5yZXBsYWNlKEFUVFJfU0FOSVRJWkVSLCAnXycpO1xuICAgIHRoaXMuY29udGVudEF0dHIgPSByZXBsYWNlTmdBdHRyaWJ1dGUoQ09OVEVOVF9BVFRSLCBjb21wb25lbnRJZCk7XG4gICAgdGhpcy5ob3N0QXR0ciA9IHJlcGxhY2VOZ0F0dHJpYnV0ZShIT1NUX0FUVFIsIGNvbXBvbmVudElkKTtcbiAgICB0aGlzLmFkZFN0eWxlcyhjb21wb25lbnQuc3R5bGVzLCBjb21wb25lbnRJZCk7XG4gIH1cblxuICBhcHBseVRvSG9zdCh2aWV3OiBOZ1ZpZXcpIHtcbiAgICBzdXBlci5zZXRBdHRyaWJ1dGUodmlldywgdGhpcy5ob3N0QXR0ciwgJycpO1xuICB9XG5cbiAgYXBwZW5kQ2hpbGQocGFyZW50OiBhbnksIG5ld0NoaWxkOiBOZ1ZpZXcpOiB2b2lkIHtcbiAgICBzdXBlci5hcHBlbmRDaGlsZChwYXJlbnQsIG5ld0NoaWxkKTtcbiAgfVxuXG4gIGNyZWF0ZUVsZW1lbnQocGFyZW50OiBhbnksIG5hbWU6IHN0cmluZyk6IE5nVmlldyB7XG4gICAgY29uc3QgdmlldyA9IHN1cGVyLmNyZWF0ZUVsZW1lbnQocGFyZW50LCBuYW1lKTtcblxuICAgIC8vIFNldCBhbiBhdHRyaWJ1dGUgdG8gdGhlIHZpZXcgdG8gc2NvcGUgY29tcG9uZW50LXNwZWNpZmljIGNzcy5cbiAgICAvLyBUaGUgcHJvcGVydHkgbmFtZSBpcyBwcmUtZ2VuZXJhdGVkIGJ5IEFuZ3VsYXIuXG4gICAgc3VwZXIuc2V0QXR0cmlidXRlKHZpZXcsIHRoaXMuY29udGVudEF0dHIsICcnKTtcblxuICAgIHJldHVybiB2aWV3O1xuICB9XG5cbiAgQHByb2ZpbGVcbiAgcHJpdmF0ZSBhZGRTdHlsZXMoc3R5bGVzOiAoc3RyaW5nIHwgYW55W10pW10sIGNvbXBvbmVudElkOiBzdHJpbmcpIHtcbiAgICBzdHlsZXNcbiAgICAgIC5tYXAoKHMpID0+IHMudG9TdHJpbmcoKSlcbiAgICAgIC5tYXAoKHMpID0+IHJlcGxhY2VOZ0F0dHJpYnV0ZShzLCBjb21wb25lbnRJZCkpXG4gICAgICAuZm9yRWFjaCgocykgPT4gYWRkU2NvcGVkU3R5bGVUb0NzcyhzLCB0aGlzLnJvb3RNb2R1bGVJZCkpO1xuICB9XG59XG4iXX0=