import { ProxyViewContainer, eachDescendant, CssAnimationProperty, CSSHelper } from '@nativescript/core';
import { NativeScriptAnimationPlayer } from './animation-player';
import { dashCaseToCamelCase } from './utils';
import { InvisibleNode } from '../views/invisible-nodes';
import { NativeScriptDebug } from '../trace';
class Selector {
    constructor(rawSelector) {
        this.parse(rawSelector);
    }
    match(element) {
        return this.nsSelectorMatch(element) || this.classSelectorsMatch(element);
    }
    parse(rawSelector) {
        const selectors = rawSelector.split(',').map((s) => s.trim());
        this.nsSelectors = selectors.map(CSSHelper.createSelector);
        this.classSelectors = selectors.filter((s) => s.startsWith('.')).map((s) => s.substring(1));
    }
    nsSelectorMatch(element) {
        return this.nsSelectors.some((s) => s.match(element));
    }
    classSelectorsMatch(element) {
        return this.classSelectors.some((s) => this.hasClass(element, s));
    }
    // we're using that instead of match for classes
    // that are dynamically added by the animation engine
    // such as .ng-trigger, that's added for every :enter view
    hasClass(element, cls) {
        return element && element['$$classes'] && element['$$classes'][cls];
    }
}
class NativeScriptAnimationDriver {
    static { this.validProperties = [...CssAnimationProperty._getPropertyNames(), 'transform']; }
    getParentElement(element) {
        return element?.parent;
    }
    validateStyleProperty(property) {
        NativeScriptDebug.animationsLog(`CssAnimationProperty.validateStyleProperty: ${property}`);
        return NativeScriptAnimationDriver.validProperties.indexOf(property) !== -1;
    }
    matchesElement(element, rawSelector) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.matchesElement ` + `element: ${element}, selector: ${rawSelector}`);
        const selector = this.makeSelector(rawSelector);
        return selector.match(element);
    }
    containsElement(elm1, elm2) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.containsElement ` + `element1: ${elm1}, element2: ${elm2}`);
        // Checking if the parent is our fake body object
        if (elm1['isOverride']) {
            return true;
        }
        const params = { originalView: elm2 };
        const result = this.visitDescendants(elm1, viewMatches, params);
        return result.found;
    }
    query(element, rawSelector, multi) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.query ` + `element: ${element}, selector: ${rawSelector} ` + `multi: ${multi}`);
        const selector = this.makeSelector(rawSelector);
        const params = { selector, multi };
        const result = this.visitDescendants(element, queryDescendants, params);
        return result.matches || [];
    }
    computeStyle(element, prop) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.computeStyle ` + `element: ${element}, prop: ${prop}`);
        const camelCaseProp = dashCaseToCamelCase(prop);
        return element.style[camelCaseProp];
    }
    animate(element, keyframes, duration, delay, easing) {
        NativeScriptDebug.animationsLog(`NativeScriptAnimationDriver.animate ` + `element: ${element}, keyframes: ${keyframes} ` + `duration: ${duration}, delay: ${delay} ` + `easing: ${easing}`);
        return new NativeScriptAnimationPlayer(element, keyframes, duration, delay, easing);
    }
    makeSelector(rawSelector) {
        return new Selector(rawSelector);
    }
    visitDescendants(element, cb, cbParams) {
        const result = {};
        // fill the result obj with the result from the callback function
        eachDescendant(element, (child) => cb(child, result, cbParams));
        return result;
    }
}
export { NativeScriptAnimationDriver };
function viewMatches(element, result, params) {
    if (element === params.originalView) {
        result.found = true;
    }
    return !result.found;
}
function queryDescendants(element, result, params) {
    if (!result.matches) {
        result.matches = [];
    }
    const { selector, multi } = params;
    // skip comment and text nodes
    // because they are not actual Views
    // and cannot be animated
    if (element instanceof InvisibleNode || !selector.match(element)) {
        return true;
    }
    if (element instanceof ProxyViewContainer) {
        element.eachChild((child) => {
            result.matches.push(child);
            return true;
        });
    }
    else {
        result.matches.push(element);
    }
    return multi;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5pbWF0aW9uLWRyaXZlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2FuZ3VsYXIvc3JjL2xpYi9hbmltYXRpb25zL2FuaW1hdGlvbi1kcml2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGNBQWMsRUFBRSxvQkFBb0IsRUFBRSxTQUFTLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV6RyxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNqRSxPQUFPLEVBQVksbUJBQW1CLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRXpELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQW1CN0MsTUFBTSxRQUFRO0lBSVosWUFBWSxXQUFtQjtRQUM3QixJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBZTtRQUNuQixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzVFLENBQUM7SUFFTyxLQUFLLENBQUMsV0FBbUI7UUFDL0IsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRTlELElBQUksQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLGNBQWMsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FB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Q3BGLElBQUksT0FBTyxLQUFLLE1BQU0sQ0FBQyxZQUFZLEVBQUU7UUFDbkMsTUFBTSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7S0FDckI7SUFFRCxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztBQUN2QixDQUFDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxPQUFlLEVBQUUsTUFBbUIsRUFBRSxNQUFtQjtJQUNqRixJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRTtRQUNuQixNQUFNLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztLQUNyQjtJQUVELE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxDQUFDO0lBRW5DLDhCQUE4QjtJQUM5QixvQ0FBb0M7SUFDcEMseUJBQXlCO0lBQ3pCLElBQUksT0FBTyxZQUFZLGFBQWEsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDaEUsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUVELElBQUksT0FBTyxZQUFZLGtCQUFrQixFQUFFO1FBQ3pDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFhLEVBQUUsRUFBRTtZQUNsQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMzQixPQUFPLElBQUksQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUFDO0tBQ0o7U0FBTTtRQUNMLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQzlCO0lBRUQsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQW5pbWF0aW9uUGxheWVyIH0gZnJvbSAnQGFuZ3VsYXIvYW5pbWF0aW9ucyc7XG5pbXBvcnQgeyBBbmltYXRpb25Ecml2ZXIgfSBmcm9tICdAYW5ndWxhci9hbmltYXRpb25zL2Jyb3dzZXInO1xuaW1wb3J0IHsgUHJveHlWaWV3Q29udGFpbmVyLCBlYWNoRGVzY2VuZGFudCwgQ3NzQW5pbWF0aW9uUHJvcGVydHksIENTU0hlbHBlciB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5cbmltcG9ydCB7IE5hdGl2ZVNjcmlwdEFuaW1hdGlvblBsYXllciB9IGZyb20gJy4vYW5pbWF0aW9uLXBsYXllcic7XG5pbXBvcnQgeyBLZXlmcmFtZSwgZGFzaENhc2VUb0NhbWVsQ2FzZSB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgSW52aXNpYmxlTm9kZSB9IGZyb20gJy4uL3ZpZXdzL2ludmlzaWJsZS1ub2Rlcyc7XG5pbXBvcnQgeyBOZ1ZpZXcgfSBmcm9tICcuLi92aWV3cy92aWV3LXR5cGVzJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi4vdHJhY2UnO1xuXG5pbnRlcmZhY2UgVmlld01hdGNoUmVzdWx0IHtcbiAgZm91bmQ6IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBWaWV3TWF0Y2hQYXJhbXMge1xuICBvcmlnaW5hbFZpZXc6IE5nVmlldztcbn1cblxuaW50ZXJmYWNlIFF1ZXJ5UGFyYW1zIHtcbiAgc2VsZWN0b3I6IFNlbGVjdG9yO1xuICBtdWx0aTogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIFF1ZXJ5UmVzdWx0IHtcbiAgbWF0Y2hlczogTmdWaWV3W107XG59XG5cbmNsYXNzIFNlbGVjdG9yIHtcbiAgcHJpdmF0ZSBuc1NlbGVjdG9yczogQXJyYXk8YW55PjtcbiAgcHJpdmF0ZSBjbGFzc1NlbGVjdG9yczogc3RyaW5nW107XG5cbiAgY29uc3RydWN0b3IocmF3U2VsZWN0b3I6IHN0cmluZykge1xuICAgIHRoaXMucGFyc2UocmF3U2VsZWN0b3IpO1xuICB9XG5cbiAgbWF0Y2goZWxlbWVudDogTmdWaWV3KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMubnNTZWxlY3Rvck1hdGNoKGVsZW1lbnQpIHx8IHRoaXMuY2xhc3NTZWxlY3RvcnNNYXRjaChlbGVtZW50KTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2UocmF3U2VsZWN0b3I6IHN0cmluZykge1xuICAgIGNvbnN0IHNlbGVjdG9ycyA9IHJhd1NlbGVjdG9yLnNwbGl0KCcsJykubWFwKChzKSA9PiBzLnRyaW0oKSk7XG5cbiAgICB0aGlzLm5zU2VsZWN0b3JzID0gc2VsZWN0b3JzLm1hcChDU1NIZWxwZXIuY3JlYXRlU2VsZWN0b3IpO1xuICAgIHRoaXMuY2xhc3NTZWxlY3RvcnMgPSBzZWxlY3RvcnMuZmlsdGVyKChzKSA9PiBzLnN0YXJ0c1dpdGgoJy4nKSkubWFwKChzKSA9PiBzLnN1YnN0cmluZygxKSk7XG4gIH1cblxuICBwcml2YXRlIG5zU2VsZWN0b3JNYXRjaChlbGVtZW50OiBOZ1ZpZXcpIHtcbiAgICByZXR1cm4gdGhpcy5uc1NlbGVjdG9ycy5zb21lKChzKSA9PiBzLm1hdGNoKGVsZW1lbnQpKTtcbiAgfVxuXG4gIHByaXZhdGUgY2xhc3NTZWxlY3RvcnNNYXRjaChlbGVtZW50OiBOZ1ZpZXcpIHtcbiAgICByZXR1cm4gdGhpcy5jbGFzc1NlbGVjdG9ycy5zb21lKChzKSA9PiB0aGlzLmhhc0NsYXNzKGVsZW1lbnQsIHMpKTtcbiAgfVxuXG4gIC8vIHdlJ3JlIHVzaW5nIHRoYXQgaW5zdGVhZCBvZiBtYXRjaCBmb3IgY2xhc3Nlc1xuICAvLyB0aGF0IGFyZSBkeW5hbWljYWxseSBhZGRlZCBieSB0aGUgYW5pbWF0aW9uIGVuZ2luZVxuICAvLyBzdWNoIGFzIC5uZy10cmlnZ2VyLCB0aGF0J3MgYWRkZWQgZm9yIGV2ZXJ5IDplbnRlciB2aWV3XG4gIHByaXZhdGUgaGFzQ2xhc3MoZWxlbWVudDogTmdWaWV3LCBjbHM6IHN0cmluZykge1xuICAgIHJldHVybiBlbGVtZW50ICYmIGVsZW1lbnRbJyQkY2xhc3NlcyddICYmIGVsZW1lbnRbJyQkY2xhc3NlcyddW2Nsc107XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIE5hdGl2ZVNjcmlwdEFuaW1hdGlvbkRyaXZlciBpbXBsZW1lbnRzIEFuaW1hdGlvbkRyaXZlciB7XG4gIHByaXZhdGUgc3RhdGljIHZhbGlkUHJvcGVydGllcyA9IFsuLi5Dc3NBbmltYXRpb25Qcm9wZXJ0eS5fZ2V0UHJvcGVydHlOYW1lcygpLCAndHJhbnNmb3JtJ107XG5cbiAgZ2V0UGFyZW50RWxlbWVudChlbGVtZW50OiBOZ1ZpZXcpOiBOZ1ZpZXcge1xuICAgIHJldHVybiBlbGVtZW50Py5wYXJlbnQgYXMgTmdWaWV3O1xuICB9XG5cbiAgdmFsaWRhdGVTdHlsZVByb3BlcnR5KHByb3BlcnR5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBOYXRpdmVTY3JpcHREZWJ1Zy5hbmltYXRpb25zTG9nKGBDc3NBbmltYXRpb25Qcm9wZXJ0eS52YWxpZGF0ZVN0eWxlUHJvcGVydHk6ICR7cHJvcGVydHl9YCk7XG4gICAgcmV0dXJuIE5hdGl2ZVNjcmlwdEFuaW1hdGlvbkRyaXZlci52YWxpZFByb3BlcnRpZXMuaW5kZXhPZihwcm9wZXJ0eSkgIT09IC0xO1xuICB9XG5cbiAgbWF0Y2hlc0VsZW1lbnQoZWxlbWVudDogTmdWaWV3LCByYXdTZWxlY3Rvcjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgTmF0aXZlU2NyaXB0RGVidWcuYW5pbWF0aW9uc0xvZyhgTmF0aXZlU2NyaXB0QW5pbWF0aW9uRHJpdmVyLm1hdGNoZXNFbGVtZW50IGAgKyBgZWxlbWVudDogJHtlbGVtZW50fSwgc2VsZWN0b3I6ICR7cmF3U2VsZWN0b3J9YCk7XG5cbiAgICBjb25zdCBzZWxlY3RvciA9IHRoaXMubWFrZVNlbGVjdG9yKHJhd1NlbGVjdG9yKTtcbiAgICByZXR1cm4gc2VsZWN0b3IubWF0Y2goZWxlbWVudCk7XG4gIH1cblxuICBjb250YWluc0VsZW1lbnQoZWxtMTogTmdWaWV3LCBlbG0yOiBOZ1ZpZXcpOiBib29sZWFuIHtcbiAgICBOYXRpdmVTY3JpcHREZWJ1Zy5hbmltYXRpb25zTG9nKGBOYXRpdmVTY3JpcHRBbmltYXRpb25Ecml2ZXIuY29udGFpbnNFbGVtZW50IGAgKyBgZWxlbWVudDE6ICR7ZWxtMX0sIGVsZW1lbnQyOiAke2VsbTJ9YCk7XG5cbiAgICAvLyBDaGVja2luZyBpZiB0aGUgcGFyZW50IGlzIG91ciBmYWtlIGJvZHkgb2JqZWN0XG4gICAgaWYgKGVsbTFbJ2lzT3ZlcnJpZGUnXSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgcGFyYW1zOiBWaWV3TWF0Y2hQYXJhbXMgPSB7IG9yaWdpbmFsVmlldzogZWxtMiB9O1xuICAgIGNvbnN0IHJlc3VsdDogVmlld01hdGNoUmVzdWx0ID0gdGhpcy52aXNpdERlc2NlbmRhbnRzKGVsbTEsIHZpZXdNYXRjaGVzLCBwYXJhbXMpO1xuXG4gICAgcmV0dXJuIHJlc3VsdC5mb3VuZDtcbiAgfVxuXG4gIHF1ZXJ5KGVsZW1lbnQ6IE5nVmlldywgcmF3U2VsZWN0b3I6IHN0cmluZywgbXVsdGk6IGJvb2xlYW4pOiBOZ1ZpZXdbXSB7XG4gICAgTmF0aXZlU2NyaXB0RGVidWcuYW5pbWF0aW9uc0xvZyhgTmF0aXZlU2NyaXB0QW5pbWF0aW9uRHJpdmVyLnF1ZXJ5IGAgKyBgZWxlbWVudDogJHtlbGVtZW50fSwgc2VsZWN0b3I6ICR7cmF3U2VsZWN0b3J9IGAgKyBgbXVsdGk6ICR7bXVsdGl9YCk7XG5cbiAgICBjb25zdCBzZWxlY3RvciA9IHRoaXMubWFrZVNlbGVjdG9yKHJhd1NlbGVjdG9yKTtcbiAgICBjb25zdCBwYXJhbXM6IFF1ZXJ5UGFyYW1zID0geyBzZWxlY3RvciwgbXVsdGkgfTtcbiAgICBjb25zdCByZXN1bHQ6IFF1ZXJ5UmVzdWx0ID0gdGhpcy52aXNpdERlc2NlbmRhbnRzKGVsZW1lbnQsIHF1ZXJ5RGVzY2VuZGFudHMsIHBhcmFtcyk7XG5cbiAgICByZXR1cm4gcmVzdWx0Lm1hdGNoZXMgfHwgW107XG4gIH1cblxuICBjb21wdXRlU3R5bGUoZWxlbWVudDogTmdWaWV3LCBwcm9wOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIE5hdGl2ZVNjcmlwdERlYnVnLmFuaW1hdGlvbnNMb2coYE5hdGl2ZVNjcmlwdEFuaW1hdGlvbkRyaXZlci5jb21wdXRlU3R5bGUgYCArIGBlbGVtZW50OiAke2VsZW1lbnR9LCBwcm9wOiAke3Byb3B9YCk7XG5cbiAgICBjb25zdCBjYW1lbENhc2VQcm9wID0gZGFzaENhc2VUb0NhbWVsQ2FzZShwcm9wKTtcbiAgICByZXR1cm4gZWxlbWVudC5zdHlsZVtjYW1lbENhc2VQcm9wXTtcbiAgfVxuXG4gIGFuaW1hdGUoZWxlbWVudDogTmdWaWV3LCBrZXlmcmFtZXM6IEtleWZyYW1lW10sIGR1cmF0aW9uOiBudW1iZXIsIGRlbGF5OiBudW1iZXIsIGVhc2luZzogc3RyaW5nKTogQW5pbWF0aW9uUGxheWVyIHtcbiAgICBOYXRpdmVTY3JpcHREZWJ1Zy5hbmltYXRpb25zTG9nKGBOYXRpdmVTY3JpcHRBbmltYXRpb25Ecml2ZXIuYW5pbWF0ZSBgICsgYGVsZW1lbnQ6ICR7ZWxlbWVudH0sIGtleWZyYW1lczogJHtrZXlmcmFtZXN9IGAgKyBgZHVyYXRpb246ICR7ZHVyYXRpb259LCBkZWxheTogJHtkZWxheX0gYCArIGBlYXNpbmc6ICR7ZWFzaW5nfWApO1xuXG4gICAgcmV0dXJuIG5ldyBOYXRpdmVTY3JpcHRBbmltYXRpb25QbGF5ZXIoZWxlbWVudCwga2V5ZnJhbWVzLCBkdXJhdGlvbiwgZGVsYXksIGVhc2luZyk7XG4gIH1cblxuICBwcml2YXRlIG1ha2VTZWxlY3RvcihyYXdTZWxlY3Rvcjogc3RyaW5nKTogU2VsZWN0b3Ige1xuICAgIHJldHVybiBuZXcgU2VsZWN0b3IocmF3U2VsZWN0b3IpO1xuICB9XG5cbiAgcHJpdmF0ZSB2aXNpdERlc2NlbmRhbnRzKGVsZW1lbnQ6IE5nVmlldywgY2I6IChjaGlsZDogTmdWaWV3LCByZXN1bHQ6IGFueSwgcGFyYW1zOiBhbnkpID0+IGJvb2xlYW4sIGNiUGFyYW1zOiBhbnkpOiBhbnkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIC8vIGZpbGwgdGhlIHJlc3VsdCBvYmogd2l0aCB0aGUgcmVzdWx0IGZyb20gdGhlIGNhbGxiYWNrIGZ1bmN0aW9uXG4gICAgZWFjaERlc2NlbmRhbnQoZWxlbWVudCwgKGNoaWxkOiBOZ1ZpZXcpID0+IGNiKGNoaWxkLCByZXN1bHQsIGNiUGFyYW1zKSk7XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG59XG5cbmZ1bmN0aW9uIHZpZXdNYXRjaGVzKGVsZW1lbnQ6IE5nVmlldywgcmVzdWx0OiBWaWV3TWF0Y2hSZXN1bHQsIHBhcmFtczogVmlld01hdGNoUGFyYW1zKTogYm9vbGVhbiB7XG4gIGlmIChlbGVtZW50ID09PSBwYXJhbXMub3JpZ2luYWxWaWV3KSB7XG4gICAgcmVzdWx0LmZvdW5kID0gdHJ1ZTtcbiAgfVxuXG4gIHJldHVybiAhcmVzdWx0LmZvdW5kO1xufVxuXG5mdW5jdGlvbiBxdWVyeURlc2NlbmRhbnRzKGVsZW1lbnQ6IE5nVmlldywgcmVzdWx0OiBRdWVyeVJlc3VsdCwgcGFyYW1zOiBRdWVyeVBhcmFtcyk6IGJvb2xlYW4ge1xuICBpZiAoIXJlc3VsdC5tYXRjaGVzKSB7XG4gICAgcmVzdWx0Lm1hdGNoZXMgPSBbXTtcbiAgfVxuXG4gIGNvbnN0IHsgc2VsZWN0b3IsIG11bHRpIH0gPSBwYXJhbXM7XG5cbiAgLy8gc2tpcCBjb21tZW50IGFuZCB0ZXh0IG5vZGVzXG4gIC8vIGJlY2F1c2UgdGhleSBhcmUgbm90IGFjdHVhbCBWaWV3c1xuICAvLyBhbmQgY2Fubm90IGJlIGFuaW1hdGVkXG4gIGlmIChlbGVtZW50IGluc3RhbmNlb2YgSW52aXNpYmxlTm9kZSB8fCAhc2VsZWN0b3IubWF0Y2goZWxlbWVudCkpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGlmIChlbGVtZW50IGluc3RhbmNlb2YgUHJveHlWaWV3Q29udGFpbmVyKSB7XG4gICAgZWxlbWVudC5lYWNoQ2hpbGQoKGNoaWxkOiBOZ1ZpZXcpID0+IHtcbiAgICAgIHJlc3VsdC5tYXRjaGVzLnB1c2goY2hpbGQpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgcmVzdWx0Lm1hdGNoZXMucHVzaChlbGVtZW50KTtcbiAgfVxuXG4gIHJldHVybiBtdWx0aTtcbn1cbiJdfQ==