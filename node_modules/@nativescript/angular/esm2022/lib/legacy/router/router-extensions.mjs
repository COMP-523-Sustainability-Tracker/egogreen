import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { NativeScriptDebug } from '../../trace';
import { FrameService } from '../frame.service';
import { NSLocationStrategy } from './ns-location-strategy';
import { findTopActivatedRouteNodeForOutlet } from './page-router-outlet-utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "./ns-location-strategy";
import * as i3 from "../frame.service";
class RouterExtensions {
    constructor(router, locationStrategy, frameService) {
        this.router = router;
        this.locationStrategy = locationStrategy;
        this.frameService = frameService;
    }
    navigate(commands, extras) {
        return this.router.navigate(commands, extras);
    }
    navigateByUrl(url, options) {
        return this.router.navigateByUrl(url, options);
    }
    back(backNavigationOptions) {
        if (backNavigationOptions) {
            this.backOutlets(backNavigationOptions);
        }
        else {
            this.locationStrategy.back();
        }
    }
    canGoBack(backNavigationOptions) {
        let canGoBack = true;
        if (backNavigationOptions) {
            const { outletsToBack, outlets } = this.findOutletsToBack(backNavigationOptions);
            if (outletsToBack.length !== outlets.length) {
                NativeScriptDebug.routerError('No outlet found relative to activated route');
            }
            else {
                outletsToBack.forEach((outletToBack) => {
                    if (!this.locationStrategy.canGoBack(outletToBack)) {
                        canGoBack = false;
                    }
                });
            }
        }
        else {
            canGoBack = this.locationStrategy.canGoBack();
        }
        return canGoBack;
    }
    backToPreviousPage() {
        this.frameService.getFrame().goBack();
    }
    canGoBackToPreviousPage() {
        return this.frameService.getFrame().canGoBack();
    }
    backOutlets(options) {
        const { outletsToBack, outlets } = this.findOutletsToBack(options);
        if (outletsToBack.length !== outlets.length) {
            NativeScriptDebug.routerError('No outlet found relative to activated route');
        }
        else {
            outletsToBack.forEach((outletToBack) => {
                if (outletToBack.isPageNavigationBack) {
                    NativeScriptDebug.routerError('Attempted to call startGoBack while going back:');
                }
                else {
                    this.locationStrategy.back(outletToBack);
                }
            });
        }
    }
    // tslint:disable-next-line:max-line-length
    findOutletsToBack(options) {
        const rootRoute = this.router.routerState.root;
        let outlets = options.outlets;
        let relativeRoute = options.relativeTo || rootRoute;
        const relativeRouteOutlet = this.findOutletByRoute(relativeRoute);
        const isNSEmptyOutlet = relativeRouteOutlet && relativeRouteOutlet.isNSEmptyOutlet;
        // Lazy named outlet has added 'primary' inner NSEmptyOutlet child.
        // Take parent route when `relativeTo` option points to the outer named outlet.
        if (isNSEmptyOutlet && relativeRoute.outlet !== 'primary') {
            relativeRoute = relativeRoute.parent || relativeRoute;
        }
        outlets = outlets || [relativeRoute.outlet];
        const outletsToBack = this.findOutletsRecursive([...outlets], relativeRoute);
        return { outletsToBack: outletsToBack, outlets: outlets };
    }
    // warning, outlets is mutable!
    findOutletsRecursive(outlets, route) {
        if (!route || outlets.length === 0) {
            return [];
        }
        const outletsToBack = [];
        if (outlets.some((currentOutlet) => currentOutlet === route.outlet)) {
            const outlet = this.findOutletByRoute(route);
            if (outlet) {
                outlets.splice(outlets.indexOf(route.outlet), 1);
                outletsToBack.push(outlet);
            }
        }
        if (!route.children) {
            return outletsToBack;
        }
        for (let index = 0; index < route.children.length; index++) {
            if (outlets.length === 0) {
                break;
            }
            const currentRoute = route.children[index];
            outletsToBack.push(...this.findOutletsRecursive(outlets, currentRoute));
        }
        return outletsToBack;
    }
    findOutletByRoute(currentRoute) {
        const currentRouteSnapshop = findTopActivatedRouteNodeForOutlet(currentRoute.snapshot);
        const outletKey = this.locationStrategy.getRouteFullPath(currentRouteSnapshop);
        const outlet = this.locationStrategy.findOutlet(outletKey, currentRouteSnapshop);
        return outlet;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: RouterExtensions, deps: [{ token: i1.Router }, { token: i2.NSLocationStrategy }, { token: i3.FrameService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: RouterExtensions, providedIn: 'root' }); }
}
export { RouterExtensions };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: RouterExtensions, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.Router }, { type: i2.NSLocationStrategy }, { type: i3.FrameService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLWV4dGVuc2lvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvbGVnYWN5L3JvdXRlci9yb3V0ZXItZXh0ZW5zaW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBK0QsTUFBTSxFQUFXLE1BQU0saUJBQWlCLENBQUM7QUFDL0csT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ2hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUU1RCxPQUFPLEVBQUUsa0NBQWtDLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQzs7Ozs7QUFVaEYsTUFHYSxnQkFBZ0I7SUFDM0IsWUFBbUIsTUFBYyxFQUFTLGdCQUFvQyxFQUFTLFlBQTBCO1FBQTlGLFdBQU0sR0FBTixNQUFNLENBQVE7UUFBUyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQW9CO1FBQVMsaUJBQVksR0FBWixZQUFZLENBQWM7SUFBRyxDQUFDO0lBRTlHLFFBQVEsQ0FBQyxRQUFlLEVBQUUsTUFBaUM7UUFDaEUsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUVNLGFBQWEsQ0FBQyxHQUFxQixFQUFFLE9BQTJDO1FBQ3JGLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFTSxJQUFJLENBQUMscUJBQTZDO1FBQ3ZELElBQUkscUJBQXFCLEVBQUU7WUFDekIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1NB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SUFFTyxpQkFBaUIsQ0FBQyxZQUE0QjtRQUNwRCxNQUFNLG9CQUFvQixHQUFHLGtDQUFrQyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN2RixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUMvRSxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLFNBQVMsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO1FBRWpGLE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7OEdBdEhVLGdCQUFnQjtrSEFBaEIsZ0JBQWdCLGNBRmYsTUFBTTs7U0FFUCxnQkFBZ0I7MkZBQWhCLGdCQUFnQjtrQkFINUIsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgTmF2aWdhdGlvbkJlaGF2aW9yT3B0aW9ucywgTmF2aWdhdGlvbkV4dHJhcywgUm91dGVyLCBVcmxUcmVlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi4vLi4vdHJhY2UnO1xuaW1wb3J0IHsgRnJhbWVTZXJ2aWNlIH0gZnJvbSAnLi4vZnJhbWUuc2VydmljZSc7XG5pbXBvcnQgeyBOU0xvY2F0aW9uU3RyYXRlZ3kgfSBmcm9tICcuL25zLWxvY2F0aW9uLXN0cmF0ZWd5JztcbmltcG9ydCB7IE5hdmlnYXRpb25PcHRpb25zLCBPdXRsZXQgfSBmcm9tICcuL25zLWxvY2F0aW9uLXV0aWxzJztcbmltcG9ydCB7IGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQgfSBmcm9tICcuL3BhZ2Utcm91dGVyLW91dGxldC11dGlscyc7XG5cbmV4cG9ydCB0eXBlIEV4dGVuZGVkTmF2aWdhdGlvbkV4dHJhcyA9IE5hdmlnYXRpb25FeHRyYXMgJiBOYXZpZ2F0aW9uT3B0aW9ucztcbmV4cG9ydCB0eXBlIEV4dGVuZGVkTmF2aWdhdGlvbkJlaGF2aW9yT3B0aW9ucyA9IE5hdmlnYXRpb25CZWhhdmlvck9wdGlvbnMgJiBOYXZpZ2F0aW9uT3B0aW9ucztcblxuZXhwb3J0IGludGVyZmFjZSBCYWNrTmF2aWdhdGlvbk9wdGlvbnMge1xuICBvdXRsZXRzPzogQXJyYXk8c3RyaW5nPjtcbiAgcmVsYXRpdmVUbz86IEFjdGl2YXRlZFJvdXRlIHwgbnVsbDtcbn1cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIFJvdXRlckV4dGVuc2lvbnMge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgcm91dGVyOiBSb3V0ZXIsIHB1YmxpYyBsb2NhdGlvblN0cmF0ZWd5OiBOU0xvY2F0aW9uU3RyYXRlZ3ksIHB1YmxpYyBmcmFtZVNlcnZpY2U6IEZyYW1lU2VydmljZSkge31cblxuICBwdWJsaWMgbmF2aWdhdGUoY29tbWFuZHM6IGFueVtdLCBleHRyYXM/OiBFeHRlbmRlZE5hdmlnYXRpb25FeHRyYXMpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5yb3V0ZXIubmF2aWdhdGUoY29tbWFuZHMsIGV4dHJhcyk7XG4gIH1cblxuICBwdWJsaWMgbmF2aWdhdGVCeVVybCh1cmw6IHN0cmluZyB8IFVybFRyZWUsIG9wdGlvbnM/OiBFeHRlbmRlZE5hdmlnYXRpb25CZWhhdmlvck9wdGlvbnMpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybCh1cmwsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHVibGljIGJhY2soYmFja05hdmlnYXRpb25PcHRpb25zPzogQmFja05hdmlnYXRpb25PcHRpb25zKSB7XG4gICAgaWYgKGJhY2tOYXZpZ2F0aW9uT3B0aW9ucykge1xuICAgICAgdGhpcy5iYWNrT3V0bGV0cyhiYWNrTmF2aWdhdGlvbk9wdGlvbnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuYmFjaygpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjYW5Hb0JhY2soYmFja05hdmlnYXRpb25PcHRpb25zPzogQmFja05hdmlnYXRpb25PcHRpb25zKSB7XG4gICAgbGV0IGNhbkdvQmFjayA9IHRydWU7XG4gICAgaWYgKGJhY2tOYXZpZ2F0aW9uT3B0aW9ucykge1xuICAgICAgY29uc3QgeyBvdXRsZXRzVG9CYWNrLCBvdXRsZXRzIH0gPSB0aGlzLmZpbmRPdXRsZXRzVG9CYWNrKGJhY2tOYXZpZ2F0aW9uT3B0aW9ucyk7XG5cbiAgICAgIGlmIChvdXRsZXRzVG9CYWNrLmxlbmd0aCAhPT0gb3V0bGV0cy5sZW5ndGgpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyRXJyb3IoJ05vIG91dGxldCBmb3VuZCByZWxhdGl2ZSB0byBhY3RpdmF0ZWQgcm91dGUnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG91dGxldHNUb0JhY2suZm9yRWFjaCgob3V0bGV0VG9CYWNrKSA9PiB7XG4gICAgICAgICAgaWYgKCF0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuY2FuR29CYWNrKG91dGxldFRvQmFjaykpIHtcbiAgICAgICAgICAgIGNhbkdvQmFjayA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhbkdvQmFjayA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5jYW5Hb0JhY2soKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2FuR29CYWNrO1xuICB9XG5cbiAgcHVibGljIGJhY2tUb1ByZXZpb3VzUGFnZSgpIHtcbiAgICB0aGlzLmZyYW1lU2VydmljZS5nZXRGcmFtZSgpLmdvQmFjaygpO1xuICB9XG5cbiAgcHVibGljIGNhbkdvQmFja1RvUHJldmlvdXNQYWdlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmZyYW1lU2VydmljZS5nZXRGcmFtZSgpLmNhbkdvQmFjaygpO1xuICB9XG5cbiAgcHJpdmF0ZSBiYWNrT3V0bGV0cyhvcHRpb25zOiBCYWNrTmF2aWdhdGlvbk9wdGlvbnMpIHtcbiAgICBjb25zdCB7IG91dGxldHNUb0JhY2ssIG91dGxldHMgfSA9IHRoaXMuZmluZE91dGxldHNUb0JhY2sob3B0aW9ucyk7XG5cbiAgICBpZiAob3V0bGV0c1RvQmFjay5sZW5ndGggIT09IG91dGxldHMubGVuZ3RoKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJFcnJvcignTm8gb3V0bGV0IGZvdW5kIHJlbGF0aXZlIHRvIGFjdGl2YXRlZCByb3V0ZScpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvdXRsZXRzVG9CYWNrLmZvckVhY2goKG91dGxldFRvQmFjaykgPT4ge1xuICAgICAgICBpZiAob3V0bGV0VG9CYWNrLmlzUGFnZU5hdmlnYXRpb25CYWNrKSB7XG4gICAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyRXJyb3IoJ0F0dGVtcHRlZCB0byBjYWxsIHN0YXJ0R29CYWNrIHdoaWxlIGdvaW5nIGJhY2s6Jyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmJhY2sob3V0bGV0VG9CYWNrKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICBwcml2YXRlIGZpbmRPdXRsZXRzVG9CYWNrKG9wdGlvbnM/OiBCYWNrTmF2aWdhdGlvbk9wdGlvbnMpOiB7IG91dGxldHNUb0JhY2s6IEFycmF5PE91dGxldD47IG91dGxldHM6IEFycmF5PHN0cmluZz4gfSB7XG4gICAgY29uc3Qgcm9vdFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSA9IHRoaXMucm91dGVyLnJvdXRlclN0YXRlLnJvb3Q7XG4gICAgbGV0IG91dGxldHMgPSBvcHRpb25zLm91dGxldHM7XG4gICAgbGV0IHJlbGF0aXZlUm91dGUgPSBvcHRpb25zLnJlbGF0aXZlVG8gfHwgcm9vdFJvdXRlO1xuXG4gICAgY29uc3QgcmVsYXRpdmVSb3V0ZU91dGxldCA9IHRoaXMuZmluZE91dGxldEJ5Um91dGUocmVsYXRpdmVSb3V0ZSk7XG4gICAgY29uc3QgaXNOU0VtcHR5T3V0bGV0ID0gcmVsYXRpdmVSb3V0ZU91dGxldCAmJiByZWxhdGl2ZVJvdXRlT3V0bGV0LmlzTlNFbXB0eU91dGxldDtcblxuICAgIC8vIExhenkgbmFtZWQgb3V0bGV0IGhhcyBhZGRlZCAncHJpbWFyeScgaW5uZXIgTlNFbXB0eU91dGxldCBjaGlsZC5cbiAgICAvLyBUYWtlIHBhcmVudCByb3V0ZSB3aGVuIGByZWxhdGl2ZVRvYCBvcHRpb24gcG9pbnRzIHRvIHRoZSBvdXRlciBuYW1lZCBvdXRsZXQuXG4gICAgaWYgKGlzTlNFbXB0eU91dGxldCAmJiByZWxhdGl2ZVJvdXRlLm91dGxldCAhPT0gJ3ByaW1hcnknKSB7XG4gICAgICByZWxhdGl2ZVJvdXRlID0gcmVsYXRpdmVSb3V0ZS5wYXJlbnQgfHwgcmVsYXRpdmVSb3V0ZTtcbiAgICB9XG5cbiAgICBvdXRsZXRzID0gb3V0bGV0cyB8fCBbcmVsYXRpdmVSb3V0ZS5vdXRsZXRdO1xuXG4gICAgY29uc3Qgb3V0bGV0c1RvQmFjayA9IHRoaXMuZmluZE91dGxldHNSZWN1cnNpdmUoWy4uLm91dGxldHNdLCByZWxhdGl2ZVJvdXRlKTtcblxuICAgIHJldHVybiB7IG91dGxldHNUb0JhY2s6IG91dGxldHNUb0JhY2ssIG91dGxldHM6IG91dGxldHMgfTtcbiAgfVxuXG4gIC8vIHdhcm5pbmcsIG91dGxldHMgaXMgbXV0YWJsZSFcbiAgcHJpdmF0ZSBmaW5kT3V0bGV0c1JlY3Vyc2l2ZShvdXRsZXRzOiBzdHJpbmdbXSwgcm91dGU/OiBBY3RpdmF0ZWRSb3V0ZSkge1xuICAgIGlmICghcm91dGUgfHwgb3V0bGV0cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgY29uc3Qgb3V0bGV0c1RvQmFjayA9IFtdO1xuICAgIGlmIChvdXRsZXRzLnNvbWUoKGN1cnJlbnRPdXRsZXQpID0+IGN1cnJlbnRPdXRsZXQgPT09IHJvdXRlLm91dGxldCkpIHtcbiAgICAgIGNvbnN0IG91dGxldCA9IHRoaXMuZmluZE91dGxldEJ5Um91dGUocm91dGUpO1xuICAgICAgaWYgKG91dGxldCkge1xuICAgICAgICBvdXRsZXRzLnNwbGljZShvdXRsZXRzLmluZGV4T2Yocm91dGUub3V0bGV0KSwgMSk7XG4gICAgICAgIG91dGxldHNUb0JhY2sucHVzaChvdXRsZXQpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIXJvdXRlLmNoaWxkcmVuKSB7XG4gICAgICByZXR1cm4gb3V0bGV0c1RvQmFjaztcbiAgICB9XG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHJvdXRlLmNoaWxkcmVuLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgaWYgKG91dGxldHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY29uc3QgY3VycmVudFJvdXRlID0gcm91dGUuY2hpbGRyZW5baW5kZXhdO1xuICAgICAgb3V0bGV0c1RvQmFjay5wdXNoKC4uLnRoaXMuZmluZE91dGxldHNSZWN1cnNpdmUob3V0bGV0cywgY3VycmVudFJvdXRlKSk7XG4gICAgfVxuICAgIHJldHVybiBvdXRsZXRzVG9CYWNrO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kT3V0bGV0QnlSb3V0ZShjdXJyZW50Um91dGU6IEFjdGl2YXRlZFJvdXRlKTogT3V0bGV0IHtcbiAgICBjb25zdCBjdXJyZW50Um91dGVTbmFwc2hvcCA9IGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQoY3VycmVudFJvdXRlLnNuYXBzaG90KTtcbiAgICBjb25zdCBvdXRsZXRLZXkgPSB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuZ2V0Um91dGVGdWxsUGF0aChjdXJyZW50Um91dGVTbmFwc2hvcCk7XG4gICAgY29uc3Qgb3V0bGV0ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmZpbmRPdXRsZXQob3V0bGV0S2V5LCBjdXJyZW50Um91dGVTbmFwc2hvcCk7XG5cbiAgICByZXR1cm4gb3V0bGV0O1xuICB9XG59XG4iXX0=