import { LocationStrategy } from '@angular/common';
import { Inject, Injectable, Optional } from '@angular/core';
import { DefaultUrlSerializer } from '@angular/router';
import { START_PATH } from '../../tokens';
import { NativeScriptDebug } from '../../trace';
import { FrameService } from '../frame.service';
import { defaultNavOptions, Outlet } from './ns-location-utils';
import * as i0 from "@angular/core";
import * as i1 from "../frame.service";
class NSLocationStrategy extends LocationStrategy {
    constructor(frameService, startPath) {
        super();
        this.frameService = frameService;
        this.startPath = startPath;
        this.outlets = [];
        this.popStateCallbacks = new Array();
        this._modalNavigationDepth = 0;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.constructor()');
        }
    }
    getState() {
        return this.currentOutlet && this.currentOutlet.peekState();
    }
    path() {
        if (!this.currentUrlTree) {
            return this.startPath || '/';
        }
        const state = this.currentOutlet && this.currentOutlet.peekState();
        if (!state) {
            return '/';
        }
        const tree = this.currentUrlTree;
        const changedOutlet = this.getSegmentGroupByOutlet(this.currentOutlet);
        // Handle case where the user declares a component at path "/".
        // The url serializer doesn't parse this url as having a primary outlet.
        if (state.isRootSegmentGroup) {
            tree.root = state.segmentGroup;
        }
        else if (changedOutlet) {
            this.updateSegmentGroup(tree.root, changedOutlet, state.segmentGroup);
        }
        const urlSerializer = new DefaultUrlSerializer();
        tree.queryParams = state.queryParams;
        const url = urlSerializer.serialize(tree);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.path(): ' + url);
        }
        return url;
    }
    prepareExternalUrl(internal) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.prepareExternalUrl() internal: ' + internal);
        }
        return internal;
    }
    pushState(state, title, url, queryParams) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.pushState state: ' + `${state}, title: ${title}, url: ${url}, queryParams: ${queryParams}`);
        }
        this.pushStateInternal(state, title, url, queryParams);
    }
    pushStateInternal(state, title, url, queryParams, replace = false) {
        const urlSerializer = new DefaultUrlSerializer();
        this.currentUrlTree = urlSerializer.parse(url);
        const urlTreeRoot = this.currentUrlTree.root;
        // Handle case where the user declares a component at path "/".
        // The url serializer doesn't parse this url as having a primary outlet.
        if (!Object.keys(urlTreeRoot.children).length) {
            const segmentGroup = this.currentUrlTree && this.currentUrlTree.root;
            const outletKey = this.getOutletKey(this.getSegmentGroupFullPath(segmentGroup), 'primary');
            const outlet = this.findOutlet(outletKey);
            if (outlet && this.updateStates(outlet, segmentGroup, this.currentUrlTree.queryParams, replace)) {
                this.currentOutlet = outlet; // If states updated
            }
            else if (!outlet) {
                // tslint:disable-next-line:max-line-length
                const rootOutlet = this.createOutlet('primary', null, segmentGroup, null, null, this.currentUrlTree.queryParams);
                this.currentOutlet = rootOutlet;
            }
            this.currentOutlet.peekState().isRootSegmentGroup = true;
            return;
        }
        const queue = [];
        let currentTree = urlTreeRoot;
        while (currentTree) {
            Object.keys(currentTree.children).forEach((outletName) => {
                const currentSegmentGroup = currentTree.children[outletName];
                currentSegmentGroup.outlet = outletName;
                currentSegmentGroup.root = urlTreeRoot;
                const outletPath = this.getSegmentGroupFullPath(currentTree);
                const outletKey = this.getOutletKey(outletPath, outletName);
                let outlet = this.findOutlet(outletKey);
                const parentOutletName = currentTree.outlet || '';
                const parentOutletPath = this.getSegmentGroupFullPath(currentTree.parent);
                const parentOutletKey = this.getOutletKey(parentOutletPath, parentOutletName);
                const parentOutlet = this.findOutlet(parentOutletKey);
                const containsLastState = outlet && outlet.containsTopState(currentSegmentGroup.toString());
                if (!outlet) {
                    // tslint:disable-next-line:max-line-length
                    outlet = this.createOutlet(outletKey, outletPath, currentSegmentGroup, parentOutlet, this._modalNavigationDepth, this.currentUrlTree.queryParams);
                    this.currentOutlet = outlet;
                }
                else if (this._modalNavigationDepth > 0 && outlet.showingModal && !containsLastState) {
                    // Navigation inside modal view.
                    this.upsertModalOutlet(outlet, currentSegmentGroup, this.currentUrlTree.queryParams, replace);
                }
                else {
                    outlet.parent = parentOutlet;
                    if (this.updateStates(outlet, currentSegmentGroup, this.currentUrlTree.queryParams, replace)) {
                        this.currentOutlet = outlet; // If states updated
                    }
                }
                queue.push(currentSegmentGroup);
            });
            currentTree = queue.shift();
        }
    }
    replaceState(state, title, url, queryParams) {
        const states = this.currentOutlet && this.currentOutlet.states;
        if (states && states.length > 0) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('NSLocationStrategy.replaceState changing existing state: ' + `${state}, title: ${title}, url: ${url}, queryParams: ${queryParams}`);
            }
            this.pushStateInternal(state, title, url, queryParams, true);
        }
        else {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('NSLocationStrategy.replaceState pushing new state: ' + `${state}, title: ${title}, url: ${url}, queryParams: ${queryParams}`);
            }
            this.pushStateInternal(state, title, url, queryParams);
        }
    }
    forward() {
        throw new Error('NSLocationStrategy.forward() - not implemented');
    }
    back(outlet, frame) {
        this.currentOutlet = outlet || this.currentOutlet;
        if (this.currentOutlet.isPageNavigationBack) {
            const states = this.currentOutlet.states;
            // We are navigating to the previous page
            // clear the stack until we get to a page navigation state
            let state = states.pop();
            let count = 1;
            if (frame) {
                while (state.frame && state.frame !== frame) {
                    state = states.pop();
                    count++;
                }
            }
            while (!state.isPageNavigation) {
                state = states.pop();
                count++;
            }
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog(`NSLocationStrategy.back() while navigating back. States popped: ${count}`);
            }
            this.callPopState(state, true);
        }
        else {
            const state = this.currentOutlet.peekState();
            if (state && state.isPageNavigation) {
                // This was a page navigation - so navigate through frame.
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog('NSLocationStrategy.back() while not navigating back but top' + ' state is page - will call frame.goBack()');
                }
                if (!outlet) {
                    const topmostFrame = this.frameService.getFrame();
                    this.currentOutlet = this.getOutletByFrame(topmostFrame) || this.currentOutlet;
                }
                const frameToBack = this.currentOutlet.getFrameToBack();
                if (frameToBack) {
                    frameToBack.goBack();
                }
            }
            else {
                // Nested navigation - just pop the state
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog('NSLocationStrategy.back() while not navigating back but top' + ' state is not page - just pop');
                }
                this.callPopState(this.currentOutlet.states.pop(), true);
            }
        }
    }
    canGoBack(outlet) {
        outlet = outlet || this.currentOutlet;
        return outlet.states.length > 1;
    }
    onPopState(fn) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.onPopState');
        }
        this.popStateCallbacks.push(fn);
    }
    getBaseHref() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.getBaseHref()');
        }
        return '';
    }
    callPopState(state, pop = true, outlet) {
        outlet = outlet || this.currentOutlet;
        const urlSerializer = new DefaultUrlSerializer();
        const changedOutlet = this.getSegmentGroupByOutlet(outlet);
        if (state && changedOutlet) {
            this.updateSegmentGroup(this.currentUrlTree.root, changedOutlet, state.segmentGroup);
        }
        else if (changedOutlet) {
            // when closing modal view there are scenarios (e.g. root viewContainerRef) when we need
            // to clean up the named page router outlet to make sure we will open the modal properly again if needed.
            this.updateSegmentGroup(this.currentUrlTree.root, changedOutlet, null);
        }
        const url = urlSerializer.serialize(this.currentUrlTree);
        const change = { state, type: 'popstate' };
        for (const fn of this.popStateCallbacks) {
            fn(change);
        }
    }
    toString() {
        let result = [];
        this.outlets.forEach((outlet) => {
            const outletStates = outlet.states;
            const outletLog = outletStates
                // tslint:disable-next-line:max-line-length
                .map((v, i) => `${outlet.outletKeys}.${i}.[${v.isPageNavigation ? 'PAGE' : 'INTERNAL'}].[${outlet.modalNavigationDepth ? 'MODAL' : 'BASE'}] "${v.segmentGroup.toString()}"`)
                .reverse();
            result = result.concat(outletLog);
        });
        return result.join('\n');
    }
    // Methods for syncing with page navigation in PageRouterOutlet
    _beginBackPageNavigation(frame, outletKey) {
        const outlet = this.getOutletByFrame(frame);
        if (!outlet || outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerError('Attempted to call startGoBack while going back.');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.startGoBack()');
        }
        outlet.setOutletKeyNavigatingBack(outletKey);
        // outlet.isPageNavigationBack = true;
        // we find all the children and also set their isPageNavigationBack
        this.outlets
            .filter((o) => {
            let parent = o.parent;
            while (parent) {
                if (parent === outlet) {
                    return true;
                }
                parent = parent.parent;
            }
            return false;
        })
            .forEach((o) => (o.isPageNavigationBack = true));
        this.currentOutlet = outlet;
    }
    _finishBackPageNavigation(frame) {
        const outlet = this.getOutletByFrame(frame);
        if (!outlet || !outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerError('Attempted to call endGoBack while not going back.');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.finishBackPageNavigation()');
        }
        outlet.isPageNavigationBack = false;
    }
    _beginModalNavigation(frame) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy._beginModalNavigation()');
        }
        this.currentOutlet = this.getOutletByFrame(frame) || this.currentOutlet;
        // It is possible to have frame, but not corresponding Outlet, if
        // showing modal dialog on app.component.ts ngOnInit() e.g. In that case
        // the modal is treated as none modal navigation.
        if (this.currentOutlet) {
            this.currentOutlet.showingModal = true;
            this._modalNavigationDepth++;
        }
    }
    _closeModalNavigation() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.closeModalNavigation()');
        }
        const isShowingModal = this._modalNavigationDepth > 0;
        if (isShowingModal) {
            this._modalNavigationDepth--;
        }
        // currentOutlet should be the one that corresponds to the topmost frame
        const topmostOutlet = this.getOutletByFrame(this.frameService.getFrame());
        const outlet = this.findOutletByModal(this._modalNavigationDepth, isShowingModal) || topmostOutlet;
        if (outlet) {
            this.currentOutlet = outlet;
            this.currentOutlet.showingModal = false;
            this.callPopState(this.currentOutlet.peekState(), false);
            // this is needed because angular does a setTimeout on onPopState, so if we don't do this we might end up with inconsistent state
            return new Promise((resolve) => setTimeout(resolve, 0));
        }
    }
    _beginPageNavigation(frame, options) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy._beginPageNavigation()');
        }
        this.currentOutlet = this.getOutletByFrame(frame) || this.currentOutlet;
        const lastState = this.currentOutlet.peekState();
        if (lastState) {
            lastState.isPageNavigation = true;
        }
        const navOptions = options || defaultNavOptions;
        if (navOptions.clearHistory) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('NSLocationStrategy._beginPageNavigation clearing states history');
            }
            this.currentOutlet.states = [lastState];
        }
        return navOptions;
    }
    _getOutlets() {
        return this.outlets;
    }
    updateOutletFrame(outlet, frame, isEmptyOutletFrame) {
        const lastState = outlet.peekState();
        if (lastState && !lastState.frame && !isEmptyOutletFrame) {
            lastState.frame = frame;
        }
        if (!outlet.containsFrame(frame)) {
            outlet.frames.push(frame);
        }
        this.currentOutlet = outlet;
    }
    clearOutlet(frame) {
        this.outlets = this.outlets.filter((currentOutlet) => {
            let isEqualToCurrent;
            if (this.currentOutlet) {
                isEqualToCurrent = currentOutlet.pathByOutlets === this.currentOutlet.pathByOutlets;
            }
            // Remove outlet from the url tree.
            if (currentOutlet.containsFrame(frame) && !isEqualToCurrent) {
                this.callPopState(null, true, currentOutlet);
            }
            // Skip frames filtering since currentOutlet is <router-outlet> when no frames available.
            if (currentOutlet.frames.length && !currentOutlet.isNSEmptyOutlet) {
                currentOutlet.frames = currentOutlet.frames.filter((currentFrame) => currentFrame !== frame);
                return currentOutlet.frames.length;
            }
            return !currentOutlet.containsFrame(frame);
        });
    }
    getSegmentGroupFullPath(segmentGroup) {
        let fullPath = '';
        while (segmentGroup) {
            const url = segmentGroup.toString();
            if (fullPath) {
                fullPath = (url ? url + '/' : '') + fullPath;
            }
            else {
                fullPath = url;
            }
            segmentGroup = segmentGroup.parent;
        }
        return fullPath;
    }
    getRouteFullPath(currentRoute) {
        const outletName = currentRoute.outlet;
        let fullPath;
        currentRoute = currentRoute.parent;
        while (currentRoute) {
            const urls = currentRoute.url.value || currentRoute.url;
            let url = urls;
            if (Array.isArray(urls)) {
                url = url.join('/');
            }
            fullPath = fullPath ? (url ? url + '/' : url) + fullPath : url;
            currentRoute = currentRoute.parent;
        }
        return fullPath ? fullPath + '-' + outletName : outletName;
    }
    getPathByOutlets(urlSegmentGroup) {
        if (!urlSegmentGroup) {
            return '';
        }
        let pathToOutlet;
        let lastPath = urlSegmentGroup.outlet || 'primary';
        let parent = urlSegmentGroup.parent;
        while (parent && urlSegmentGroup.root !== parent) {
            if (parent && parent.outlet !== lastPath) {
                if (lastPath === 'primary') {
                    lastPath = parent.outlet;
                }
                else {
                    lastPath = parent.outlet;
                    pathToOutlet = lastPath + '-' + (pathToOutlet || urlSegmentGroup.outlet);
                }
            }
            parent = parent.parent;
        }
        return pathToOutlet || lastPath;
    }
    findOutlet(outletKey, activatedRouteSnapshot) {
        let outlet = this.outlets.find((currentOutlet) => {
            const equalModalDepth = currentOutlet.modalNavigationDepth === this._modalNavigationDepth;
            return equalModalDepth && currentOutlet.outletKeys.indexOf(outletKey) > -1;
        });
        // No Outlet with the given outletKey could happen when using nested unnamed p-r-o
        // primary -> primary -> prymary
        if (!outlet && activatedRouteSnapshot) {
            const pathByOutlets = this.getPathByOutlets(activatedRouteSnapshot);
            outlet = this.outlets.find((currentOutlet) => {
                const equalModalDepth = currentOutlet.modalNavigationDepth === this._modalNavigationDepth;
                return equalModalDepth && currentOutlet.pathByOutlets === pathByOutlets;
            });
        }
        return outlet;
    }
    findOutletByModal(modalNavigation, isShowingModal) {
        return this.outlets.find((outlet) => {
            const equalModalDepth = outlet.modalNavigationDepth === modalNavigation;
            return isShowingModal ? equalModalDepth && outlet.showingModal : equalModalDepth;
        });
    }
    getOutletByFrame(frame) {
        let outlet;
        for (let index = 0; index < this.outlets.length; index++) {
            const currentOutlet = this.outlets[index];
            if (currentOutlet.containsFrame(frame)) {
                outlet = currentOutlet;
                break;
            }
        }
        return outlet;
    }
    updateStates(outlet, currentSegmentGroup, queryParams, replace = false) {
        const isNewPage = outlet.states.length === 0;
        const lastState = outlet.states[outlet.states.length - 1];
        const equalStateUrls = outlet.containsTopState(currentSegmentGroup.toString());
        const locationState = {
            segmentGroup: currentSegmentGroup,
            isRootSegmentGroup: false,
            isPageNavigation: isNewPage,
            queryParams: { ...queryParams },
        };
        if (!lastState || !equalStateUrls) {
            if (replace) {
                outlet.states.pop();
            }
            outlet.states.push(locationState);
            // Update last state segmentGroup of parent Outlet.
            if (this._modalNavigationDepth === 0 && !outlet.showingModal) {
                this.updateParentsStates(outlet, currentSegmentGroup.parent);
            }
            return true;
        }
        else {
            if (lastState && equalStateUrls) {
                // update query params for last state
                lastState.queryParams = { ...queryParams };
            }
        }
        return false;
    }
    updateParentsStates(outlet, newSegmentGroup) {
        let parentOutlet = outlet.parent;
        // Update parents lastState segmentGroups
        while (parentOutlet && newSegmentGroup) {
            const state = parentOutlet.peekState();
            if (state) {
                state.segmentGroup = newSegmentGroup;
                newSegmentGroup = newSegmentGroup.parent;
                parentOutlet = parentOutlet.parent;
            }
        }
    }
    // tslint:disable-next-line:max-line-length
    createOutlet(outletKey, path, segmentGroup, parent, modalNavigation, queryParams = {}) {
        const pathByOutlets = this.getPathByOutlets(segmentGroup);
        const newOutlet = new Outlet(outletKey, path, pathByOutlets, modalNavigation);
        const locationState = {
            segmentGroup: segmentGroup,
            isRootSegmentGroup: false,
            isPageNavigation: true,
            queryParams: { ...queryParams },
        };
        newOutlet.states = [locationState];
        newOutlet.parent = parent;
        this.outlets.push(newOutlet);
        // Update last state segmentGroup of parent Outlet.
        if (this._modalNavigationDepth === 0 && !newOutlet.showingModal) {
            this.updateParentsStates(newOutlet, segmentGroup.parent);
        }
        return newOutlet;
    }
    getSegmentGroupByOutlet(outlet) {
        const pathList = outlet.pathByOutlets.split('-');
        let segmentGroup = this.currentUrlTree.root;
        let pathToOutlet;
        for (let index = 0; index < pathList.length; index++) {
            const currentPath = pathList[index];
            const childrenCount = Object.keys(segmentGroup.children).length;
            if (childrenCount && segmentGroup.children[currentPath]) {
                const url = segmentGroup.toString();
                pathToOutlet = pathToOutlet ? pathToOutlet + '/' + url : url;
                segmentGroup = segmentGroup.children[currentPath];
            }
            else {
                // If no child outlet found with the given name - forget about all previously found outlets.
                // example: seaching for 'primary-second-primary' shouldn't return 'primary-second'
                // if no 'primary' child available on 'second'.
                segmentGroup = null;
                break;
            }
        }
        // Paths should also match since there could be another Outlet
        // with the same pathByOutlets but different url path.
        if (segmentGroup && outlet.path && pathToOutlet && outlet.path !== pathToOutlet) {
            segmentGroup = null;
        }
        return segmentGroup;
    }
    // Traversal and replacement of segmentGroup.
    updateSegmentGroup(rootNode, oldSegmentGroup, newSegmentGroup) {
        const queue = [];
        let currentTree = rootNode;
        while (currentTree) {
            Object.keys(currentTree.children).forEach((outletName) => {
                if (currentTree.children[outletName] === oldSegmentGroup) {
                    if (newSegmentGroup) {
                        currentTree.children[outletName] = newSegmentGroup;
                    }
                    else {
                        delete currentTree.children[outletName];
                    }
                }
                queue.push(currentTree.children[outletName]);
            });
            currentTree = queue.shift();
        }
    }
    upsertModalOutlet(parentOutlet, segmentedGroup, queryParams, replace = false) {
        let currentModalOutlet = this.findOutletByModal(this._modalNavigationDepth);
        // We want to treat every p-r-o as a standalone Outlet.
        if (!currentModalOutlet) {
            if (this._modalNavigationDepth > 1) {
                // The parent of the current Outlet should be the previous opened modal (if any).
                parentOutlet = this.findOutletByModal(this._modalNavigationDepth - 1);
            }
            // No currentModalOutlet available when opening 'primary' p-r-o.
            const outletName = 'primary';
            const outletPath = parentOutlet.peekState().segmentGroup.toString();
            const outletKey = this.getOutletKey(outletPath, outletName);
            // tslint:disable-next-line:max-line-length
            currentModalOutlet = this.createOutlet(outletKey, outletPath, segmentedGroup, parentOutlet, this._modalNavigationDepth, queryParams);
            this.currentOutlet = currentModalOutlet;
        }
        else if (this.updateStates(currentModalOutlet, segmentedGroup, queryParams, replace)) {
            this.currentOutlet = currentModalOutlet; // If states updated
        }
    }
    getOutletKey(path, outletName) {
        return path ? path + '-' + outletName : outletName;
    }
    ngOnDestroy() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('NSLocationStrategy.ngOnDestroy()');
        }
        this.outlets = [];
        this.currentOutlet = null;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: NSLocationStrategy, deps: [{ token: i1.FrameService }, { token: START_PATH, optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: NSLocationStrategy, providedIn: 'root' }); }
}
export { NSLocationStrategy };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: NSLocationStrategy, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.FrameService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [START_PATH]
                }, {
                    type: Optional
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnMtbG9jYXRpb24tc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvbGVnYWN5L3JvdXRlci9ucy1sb2NhdGlvbi1zdHJhdGVneS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQXVCLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDeEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBMEIsb0JBQW9CLEVBQW9DLE1BQU0saUJBQWlCLENBQUM7QUFFakgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMxQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDaEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxpQkFBaUIsRUFBb0MsTUFBTSxFQUFFLE1BQU0scUJBQXFCLENBQUM7OztBQUVsRyxNQUdhLGtCQUFtQixTQUFRLGdCQUFnQjtJQVN0RCxZQUFvQixZQUEwQixFQUEwQyxTQUFrQjtRQUN4RyxLQUFLLEVBQUUsQ0FBQztRQURVLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQTBDLGNBQVMsR0FBVCxTQUFTLENBQVM7UUFSbEcsWUFBTyxHQUFrQixFQUFFLENBQUM7UUFHNUIsc0JBQWlCLEdBQUcsSUFBSSxLQUFLLEVBQW1CLENBQUM7UUFHbEQsMEJBQXFCLEdBQUcsQ0FBQyxDQUFDO1FBSS9CLElBQUksaUJBQWlCLENBQUMsWUFBWSxFQUFFLEVBQUU7WUFDcEMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7U0FDakU7SUFDSCxDQUFDO0lBRUQsUUFBUTtRQUNOLE9BQU8sSUFBSSxDQUFDLGFBQWEsSUFBSSxJQUFJLENBQUMsYUFB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LE1BQU07MkJBQUMsVUFBVTs7MEJBQUcsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvY2F0aW9uQ2hhbmdlRXZlbnQsIExvY2F0aW9uU3RyYXRlZ3kgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgRGVmYXVsdFVybFNlcmlhbGl6ZXIsIFBhcmFtcywgVXJsU2VnbWVudEdyb3VwLCBVcmxUcmVlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IEZyYW1lIH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcbmltcG9ydCB7IFNUQVJUX1BBVEggfSBmcm9tICcuLi8uLi90b2tlbnMnO1xuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RGVidWcgfSBmcm9tICcuLi8uLi90cmFjZSc7XG5pbXBvcnQgeyBGcmFtZVNlcnZpY2UgfSBmcm9tICcuLi9mcmFtZS5zZXJ2aWNlJztcbmltcG9ydCB7IGRlZmF1bHROYXZPcHRpb25zLCBMb2NhdGlvblN0YXRlLCBOYXZpZ2F0aW9uT3B0aW9ucywgT3V0bGV0IH0gZnJvbSAnLi9ucy1sb2NhdGlvbi11dGlscyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBOU0xvY2F0aW9uU3RyYXRlZ3kgZXh0ZW5kcyBMb2NhdGlvblN0cmF0ZWd5IHtcbiAgcHJpdmF0ZSBvdXRsZXRzOiBBcnJheTxPdXRsZXQ+ID0gW107XG4gIHByaXZhdGUgY3VycmVudE91dGxldDogT3V0bGV0O1xuXG4gIHByaXZhdGUgcG9wU3RhdGVDYWxsYmFja3MgPSBuZXcgQXJyYXk8KF86IGFueSkgPT4gYW55PigpO1xuICBwcml2YXRlIGN1cnJlbnRVcmxUcmVlOiBVcmxUcmVlO1xuXG4gIHB1YmxpYyBfbW9kYWxOYXZpZ2F0aW9uRGVwdGggPSAwO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZnJhbWVTZXJ2aWNlOiBGcmFtZVNlcnZpY2UsIEBJbmplY3QoU1RBUlRfUEFUSCkgQE9wdGlvbmFsKCkgcHJpdmF0ZSBzdGFydFBhdGg/OiBzdHJpbmcpIHtcbiAgICBzdXBlcigpO1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuY29uc3RydWN0b3IoKScpO1xuICAgIH1cbiAgfVxuXG4gIGdldFN0YXRlKCk6IHVua25vd24ge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRPdXRsZXQgJiYgdGhpcy5jdXJyZW50T3V0bGV0LnBlZWtTdGF0ZSgpO1xuICB9XG5cbiAgcGF0aCgpOiBzdHJpbmcge1xuICAgIGlmICghdGhpcy5jdXJyZW50VXJsVHJlZSkge1xuICAgICAgcmV0dXJuIHRoaXMuc3RhcnRQYXRoIHx8ICcvJztcbiAgICB9XG5cbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuY3VycmVudE91dGxldCAmJiB0aGlzLmN1cnJlbnRPdXRsZXQucGVla1N0YXRlKCk7XG4gICAgaWYgKCFzdGF0ZSkge1xuICAgICAgcmV0dXJuICcvJztcbiAgICB9XG5cbiAgICBjb25zdCB0cmVlID0gdGhpcy5jdXJyZW50VXJsVHJlZTtcbiAgICBjb25zdCBjaGFuZ2VkT3V0bGV0ID0gdGhpcy5nZXRTZWdtZW50R3JvdXBCeU91dGxldCh0aGlzLmN1cnJlbnRPdXRsZXQpO1xuXG4gICAgLy8gSGFuZGxlIGNhc2Ugd2hlcmUgdGhlIHVzZXIgZGVjbGFyZXMgYSBjb21wb25lbnQgYXQgcGF0aCBcIi9cIi5cbiAgICAvLyBUaGUgdXJsIHNlcmlhbGl6ZXIgZG9lc24ndCBwYXJzZSB0aGlzIHVybCBhcyBoYXZpbmcgYSBwcmltYXJ5IG91dGxldC5cbiAgICBpZiAoc3RhdGUuaXNSb290U2VnbWVudEdyb3VwKSB7XG4gICAgICB0cmVlLnJvb3QgPSBzdGF0ZS5zZWdtZW50R3JvdXA7XG4gICAgfSBlbHNlIGlmIChjaGFuZ2VkT3V0bGV0KSB7XG4gICAgICB0aGlzLnVwZGF0ZVNlZ21lbnRHcm91cCh0cmVlLnJvb3QsIGNoYW5nZWRPdXRsZXQsIHN0YXRlLnNlZ21lbnRHcm91cCk7XG4gICAgfVxuXG4gICAgY29uc3QgdXJsU2VyaWFsaXplciA9IG5ldyBEZWZhdWx0VXJsU2VyaWFsaXplcigpO1xuICAgIHRyZWUucXVlcnlQYXJhbXMgPSBzdGF0ZS5xdWVyeVBhcmFtcztcbiAgICBjb25zdCB1cmwgPSB1cmxTZXJpYWxpemVyLnNlcmlhbGl6ZSh0cmVlKTtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LnBhdGgoKTogJyArIHVybCk7XG4gICAgfVxuICAgIHJldHVybiB1cmw7XG4gIH1cblxuICBwcmVwYXJlRXh0ZXJuYWxVcmwoaW50ZXJuYWw6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5wcmVwYXJlRXh0ZXJuYWxVcmwoKSBpbnRlcm5hbDogJyArIGludGVybmFsKTtcbiAgICB9XG4gICAgcmV0dXJuIGludGVybmFsO1xuICB9XG5cbiAgcHVzaFN0YXRlKHN0YXRlOiBhbnksIHRpdGxlOiBzdHJpbmcsIHVybDogc3RyaW5nLCBxdWVyeVBhcmFtczogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5wdXNoU3RhdGUgc3RhdGU6ICcgKyBgJHtzdGF0ZX0sIHRpdGxlOiAke3RpdGxlfSwgdXJsOiAke3VybH0sIHF1ZXJ5UGFyYW1zOiAke3F1ZXJ5UGFyYW1zfWApO1xuICAgIH1cbiAgICB0aGlzLnB1c2hTdGF0ZUludGVybmFsKHN0YXRlLCB0aXRsZSwgdXJsLCBxdWVyeVBhcmFtcyk7XG4gIH1cblxuICBwdXNoU3RhdGVJbnRlcm5hbChzdGF0ZTogYW55LCB0aXRsZTogc3RyaW5nLCB1cmw6IHN0cmluZywgcXVlcnlQYXJhbXM6IHN0cmluZywgcmVwbGFjZSA9IGZhbHNlKTogdm9pZCB7XG4gICAgY29uc3QgdXJsU2VyaWFsaXplciA9IG5ldyBEZWZhdWx0VXJsU2VyaWFsaXplcigpO1xuICAgIHRoaXMuY3VycmVudFVybFRyZWUgPSB1cmxTZXJpYWxpemVyLnBhcnNlKHVybCk7XG4gICAgY29uc3QgdXJsVHJlZVJvb3QgPSB0aGlzLmN1cnJlbnRVcmxUcmVlLnJvb3Q7XG5cbiAgICAvLyBIYW5kbGUgY2FzZSB3aGVyZSB0aGUgdXNlciBkZWNsYXJlcyBhIGNvbXBvbmVudCBhdCBwYXRoIFwiL1wiLlxuICAgIC8vIFRoZSB1cmwgc2VyaWFsaXplciBkb2Vzbid0IHBhcnNlIHRoaXMgdXJsIGFzIGhhdmluZyBhIHByaW1hcnkgb3V0bGV0LlxuICAgIGlmICghT2JqZWN0LmtleXModXJsVHJlZVJvb3QuY2hpbGRyZW4pLmxlbmd0aCkge1xuICAgICAgY29uc3Qgc2VnbWVudEdyb3VwID0gdGhpcy5jdXJyZW50VXJsVHJlZSAmJiB0aGlzLmN1cnJlbnRVcmxUcmVlLnJvb3Q7XG4gICAgICBjb25zdCBvdXRsZXRLZXkgPSB0aGlzLmdldE91dGxldEtleSh0aGlzLmdldFNlZ21lbnRHcm91cEZ1bGxQYXRoKHNlZ21lbnRHcm91cCksICdwcmltYXJ5Jyk7XG4gICAgICBjb25zdCBvdXRsZXQgPSB0aGlzLmZpbmRPdXRsZXQob3V0bGV0S2V5KTtcblxuICAgICAgaWYgKG91dGxldCAmJiB0aGlzLnVwZGF0ZVN0YXRlcyhvdXRsZXQsIHNlZ21lbnRHcm91cCwgdGhpcy5jdXJyZW50VXJsVHJlZS5xdWVyeVBhcmFtcywgcmVwbGFjZSkpIHtcbiAgICAgICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gb3V0bGV0OyAvLyBJZiBzdGF0ZXMgdXBkYXRlZFxuICAgICAgfSBlbHNlIGlmICghb3V0bGV0KSB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICAgY29uc3Qgcm9vdE91dGxldCA9IHRoaXMuY3JlYXRlT3V0bGV0KCdwcmltYXJ5JywgbnVsbCwgc2VnbWVudEdyb3VwLCBudWxsLCBudWxsLCB0aGlzLmN1cnJlbnRVcmxUcmVlLnF1ZXJ5UGFyYW1zKTtcbiAgICAgICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gcm9vdE91dGxldDtcbiAgICAgIH1cblxuICAgICAgdGhpcy5jdXJyZW50T3V0bGV0LnBlZWtTdGF0ZSgpLmlzUm9vdFNlZ21lbnRHcm91cCA9IHRydWU7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcXVldWUgPSBbXTtcbiAgICBsZXQgY3VycmVudFRyZWUgPSA8YW55PnVybFRyZWVSb290O1xuXG4gICAgd2hpbGUgKGN1cnJlbnRUcmVlKSB7XG4gICAgICBPYmplY3Qua2V5cyhjdXJyZW50VHJlZS5jaGlsZHJlbikuZm9yRWFjaCgob3V0bGV0TmFtZSkgPT4ge1xuICAgICAgICBjb25zdCBjdXJyZW50U2VnbWVudEdyb3VwID0gY3VycmVudFRyZWUuY2hpbGRyZW5bb3V0bGV0TmFtZV07XG4gICAgICAgIGN1cnJlbnRTZWdtZW50R3JvdXAub3V0bGV0ID0gb3V0bGV0TmFtZTtcbiAgICAgICAgY3VycmVudFNlZ21lbnRHcm91cC5yb290ID0gdXJsVHJlZVJvb3Q7XG5cbiAgICAgICAgY29uc3Qgb3V0bGV0UGF0aCA9IHRoaXMuZ2V0U2VnbWVudEdyb3VwRnVsbFBhdGgoY3VycmVudFRyZWUpO1xuICAgICAgICBjb25zdCBvdXRsZXRLZXkgPSB0aGlzLmdldE91dGxldEtleShvdXRsZXRQYXRoLCBvdXRsZXROYW1lKTtcbiAgICAgICAgbGV0IG91dGxldCA9IHRoaXMuZmluZE91dGxldChvdXRsZXRLZXkpO1xuXG4gICAgICAgIGNvbnN0IHBhcmVudE91dGxldE5hbWUgPSBjdXJyZW50VHJlZS5vdXRsZXQgfHwgJyc7XG4gICAgICAgIGNvbnN0IHBhcmVudE91dGxldFBhdGggPSB0aGlzLmdldFNlZ21lbnRHcm91cEZ1bGxQYXRoKGN1cnJlbnRUcmVlLnBhcmVudCk7XG4gICAgICAgIGNvbnN0IHBhcmVudE91dGxldEtleSA9IHRoaXMuZ2V0T3V0bGV0S2V5KHBhcmVudE91dGxldFBhdGgsIHBhcmVudE91dGxldE5hbWUpO1xuICAgICAgICBjb25zdCBwYXJlbnRPdXRsZXQgPSB0aGlzLmZpbmRPdXRsZXQocGFyZW50T3V0bGV0S2V5KTtcblxuICAgICAgICBjb25zdCBjb250YWluc0xhc3RTdGF0ZSA9IG91dGxldCAmJiBvdXRsZXQuY29udGFpbnNUb3BTdGF0ZShjdXJyZW50U2VnbWVudEdyb3VwLnRvU3RyaW5nKCkpO1xuICAgICAgICBpZiAoIW91dGxldCkge1xuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICAgICBvdXRsZXQgPSB0aGlzLmNyZWF0ZU91dGxldChvdXRsZXRLZXksIG91dGxldFBhdGgsIGN1cnJlbnRTZWdtZW50R3JvdXAsIHBhcmVudE91dGxldCwgdGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGgsIHRoaXMuY3VycmVudFVybFRyZWUucXVlcnlQYXJhbXMpO1xuICAgICAgICAgIHRoaXMuY3VycmVudE91dGxldCA9IG91dGxldDtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCA+IDAgJiYgb3V0bGV0LnNob3dpbmdNb2RhbCAmJiAhY29udGFpbnNMYXN0U3RhdGUpIHtcbiAgICAgICAgICAvLyBOYXZpZ2F0aW9uIGluc2lkZSBtb2RhbCB2aWV3LlxuICAgICAgICAgIHRoaXMudXBzZXJ0TW9kYWxPdXRsZXQob3V0bGV0LCBjdXJyZW50U2VnbWVudEdyb3VwLCB0aGlzLmN1cnJlbnRVcmxUcmVlLnF1ZXJ5UGFyYW1zLCByZXBsYWNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvdXRsZXQucGFyZW50ID0gcGFyZW50T3V0bGV0O1xuXG4gICAgICAgICAgaWYgKHRoaXMudXBkYXRlU3RhdGVzKG91dGxldCwgY3VycmVudFNlZ21lbnRHcm91cCwgdGhpcy5jdXJyZW50VXJsVHJlZS5xdWVyeVBhcmFtcywgcmVwbGFjZSkpIHtcbiAgICAgICAgICAgIHRoaXMuY3VycmVudE91dGxldCA9IG91dGxldDsgLy8gSWYgc3RhdGVzIHVwZGF0ZWRcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBxdWV1ZS5wdXNoKGN1cnJlbnRTZWdtZW50R3JvdXApO1xuICAgICAgfSk7XG5cbiAgICAgIGN1cnJlbnRUcmVlID0gcXVldWUuc2hpZnQoKTtcbiAgICB9XG4gIH1cblxuICByZXBsYWNlU3RhdGUoc3RhdGU6IGFueSwgdGl0bGU6IHN0cmluZywgdXJsOiBzdHJpbmcsIHF1ZXJ5UGFyYW1zOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBzdGF0ZXMgPSB0aGlzLmN1cnJlbnRPdXRsZXQgJiYgdGhpcy5jdXJyZW50T3V0bGV0LnN0YXRlcztcblxuICAgIGlmIChzdGF0ZXMgJiYgc3RhdGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5yZXBsYWNlU3RhdGUgY2hhbmdpbmcgZXhpc3Rpbmcgc3RhdGU6ICcgKyBgJHtzdGF0ZX0sIHRpdGxlOiAke3RpdGxlfSwgdXJsOiAke3VybH0sIHF1ZXJ5UGFyYW1zOiAke3F1ZXJ5UGFyYW1zfWApO1xuICAgICAgfVxuICAgICAgdGhpcy5wdXNoU3RhdGVJbnRlcm5hbChzdGF0ZSwgdGl0bGUsIHVybCwgcXVlcnlQYXJhbXMsIHRydWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kucmVwbGFjZVN0YXRlIHB1c2hpbmcgbmV3IHN0YXRlOiAnICsgYCR7c3RhdGV9LCB0aXRsZTogJHt0aXRsZX0sIHVybDogJHt1cmx9LCBxdWVyeVBhcmFtczogJHtxdWVyeVBhcmFtc31gKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucHVzaFN0YXRlSW50ZXJuYWwoc3RhdGUsIHRpdGxlLCB1cmwsIHF1ZXJ5UGFyYW1zKTtcbiAgICB9XG4gIH1cblxuICBmb3J3YXJkKCk6IHZvaWQge1xuICAgIHRocm93IG5ldyBFcnJvcignTlNMb2NhdGlvblN0cmF0ZWd5LmZvcndhcmQoKSAtIG5vdCBpbXBsZW1lbnRlZCcpO1xuICB9XG5cbiAgYmFjayhvdXRsZXQ/OiBPdXRsZXQsIGZyYW1lPzogRnJhbWUpOiB2b2lkIHtcbiAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBvdXRsZXQgfHwgdGhpcy5jdXJyZW50T3V0bGV0O1xuXG4gICAgaWYgKHRoaXMuY3VycmVudE91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjaykge1xuICAgICAgY29uc3Qgc3RhdGVzID0gdGhpcy5jdXJyZW50T3V0bGV0LnN0YXRlcztcbiAgICAgIC8vIFdlIGFyZSBuYXZpZ2F0aW5nIHRvIHRoZSBwcmV2aW91cyBwYWdlXG4gICAgICAvLyBjbGVhciB0aGUgc3RhY2sgdW50aWwgd2UgZ2V0IHRvIGEgcGFnZSBuYXZpZ2F0aW9uIHN0YXRlXG4gICAgICBsZXQgc3RhdGUgPSBzdGF0ZXMucG9wKCk7XG4gICAgICBsZXQgY291bnQgPSAxO1xuXG4gICAgICBpZiAoZnJhbWUpIHtcbiAgICAgICAgd2hpbGUgKHN0YXRlLmZyYW1lICYmIHN0YXRlLmZyYW1lICE9PSBmcmFtZSkge1xuICAgICAgICAgIHN0YXRlID0gc3RhdGVzLnBvcCgpO1xuICAgICAgICAgIGNvdW50Kys7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgd2hpbGUgKCFzdGF0ZS5pc1BhZ2VOYXZpZ2F0aW9uKSB7XG4gICAgICAgIHN0YXRlID0gc3RhdGVzLnBvcCgpO1xuICAgICAgICBjb3VudCsrO1xuICAgICAgfVxuXG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBOU0xvY2F0aW9uU3RyYXRlZ3kuYmFjaygpIHdoaWxlIG5hdmlnYXRpbmcgYmFjay4gU3RhdGVzIHBvcHBlZDogJHtjb3VudH1gKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuY2FsbFBvcFN0YXRlKHN0YXRlLCB0cnVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLmN1cnJlbnRPdXRsZXQucGVla1N0YXRlKCk7XG4gICAgICBpZiAoc3RhdGUgJiYgc3RhdGUuaXNQYWdlTmF2aWdhdGlvbikge1xuICAgICAgICAvLyBUaGlzIHdhcyBhIHBhZ2UgbmF2aWdhdGlvbiAtIHNvIG5hdmlnYXRlIHRocm91Z2ggZnJhbWUuXG4gICAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LmJhY2soKSB3aGlsZSBub3QgbmF2aWdhdGluZyBiYWNrIGJ1dCB0b3AnICsgJyBzdGF0ZSBpcyBwYWdlIC0gd2lsbCBjYWxsIGZyYW1lLmdvQmFjaygpJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIW91dGxldCkge1xuICAgICAgICAgIGNvbnN0IHRvcG1vc3RGcmFtZSA9IHRoaXMuZnJhbWVTZXJ2aWNlLmdldEZyYW1lKCk7XG4gICAgICAgICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gdGhpcy5nZXRPdXRsZXRCeUZyYW1lKHRvcG1vc3RGcmFtZSkgfHwgdGhpcy5jdXJyZW50T3V0bGV0O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZnJhbWVUb0JhY2s6IEZyYW1lID0gdGhpcy5jdXJyZW50T3V0bGV0LmdldEZyYW1lVG9CYWNrKCk7XG4gICAgICAgIGlmIChmcmFtZVRvQmFjaykge1xuICAgICAgICAgIGZyYW1lVG9CYWNrLmdvQmFjaygpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBOZXN0ZWQgbmF2aWdhdGlvbiAtIGp1c3QgcG9wIHRoZSBzdGF0ZVxuICAgICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5iYWNrKCkgd2hpbGUgbm90IG5hdmlnYXRpbmcgYmFjayBidXQgdG9wJyArICcgc3RhdGUgaXMgbm90IHBhZ2UgLSBqdXN0IHBvcCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jYWxsUG9wU3RhdGUodGhpcy5jdXJyZW50T3V0bGV0LnN0YXRlcy5wb3AoKSwgdHJ1ZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY2FuR29CYWNrKG91dGxldD86IE91dGxldCkge1xuICAgIG91dGxldCA9IG91dGxldCB8fCB0aGlzLmN1cnJlbnRPdXRsZXQ7XG4gICAgcmV0dXJuIG91dGxldC5zdGF0ZXMubGVuZ3RoID4gMTtcbiAgfVxuXG4gIG9uUG9wU3RhdGUoZm46IChfOiBhbnkpID0+IGFueSk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kub25Qb3BTdGF0ZScpO1xuICAgIH1cbiAgICB0aGlzLnBvcFN0YXRlQ2FsbGJhY2tzLnB1c2goZm4pO1xuICB9XG5cbiAgZ2V0QmFzZUhyZWYoKTogc3RyaW5nIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LmdldEJhc2VIcmVmKCknKTtcbiAgICB9XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxsUG9wU3RhdGUoc3RhdGU6IExvY2F0aW9uU3RhdGUsIHBvcDogYm9vbGVhbiA9IHRydWUsIG91dGxldD86IE91dGxldCkge1xuICAgIG91dGxldCA9IG91dGxldCB8fCB0aGlzLmN1cnJlbnRPdXRsZXQ7XG4gICAgY29uc3QgdXJsU2VyaWFsaXplciA9IG5ldyBEZWZhdWx0VXJsU2VyaWFsaXplcigpO1xuICAgIGNvbnN0IGNoYW5nZWRPdXRsZXQgPSB0aGlzLmdldFNlZ21lbnRHcm91cEJ5T3V0bGV0KG91dGxldCk7XG5cbiAgICBpZiAoc3RhdGUgJiYgY2hhbmdlZE91dGxldCkge1xuICAgICAgdGhpcy51cGRhdGVTZWdtZW50R3JvdXAodGhpcy5jdXJyZW50VXJsVHJlZS5yb290LCBjaGFuZ2VkT3V0bGV0LCBzdGF0ZS5zZWdtZW50R3JvdXApO1xuICAgIH0gZWxzZSBpZiAoY2hhbmdlZE91dGxldCkge1xuICAgICAgLy8gd2hlbiBjbG9zaW5nIG1vZGFsIHZpZXcgdGhlcmUgYXJlIHNjZW5hcmlvcyAoZS5nLiByb290IHZpZXdDb250YWluZXJSZWYpIHdoZW4gd2UgbmVlZFxuICAgICAgLy8gdG8gY2xlYW4gdXAgdGhlIG5hbWVkIHBhZ2Ugcm91dGVyIG91dGxldCB0byBtYWtlIHN1cmUgd2Ugd2lsbCBvcGVuIHRoZSBtb2RhbCBwcm9wZXJseSBhZ2FpbiBpZiBuZWVkZWQuXG4gICAgICB0aGlzLnVwZGF0ZVNlZ21lbnRHcm91cCh0aGlzLmN1cnJlbnRVcmxUcmVlLnJvb3QsIGNoYW5nZWRPdXRsZXQsIG51bGwpO1xuICAgIH1cblxuICAgIGNvbnN0IHVybCA9IHVybFNlcmlhbGl6ZXIuc2VyaWFsaXplKHRoaXMuY3VycmVudFVybFRyZWUpO1xuICAgIGNvbnN0IGNoYW5nZTogTG9jYXRpb25DaGFuZ2VFdmVudCA9IHsgc3RhdGUsIHR5cGU6ICdwb3BzdGF0ZScgfTtcbiAgICBmb3IgKGNvbnN0IGZuIG9mIHRoaXMucG9wU3RhdGVDYWxsYmFja3MpIHtcbiAgICAgIGZuKGNoYW5nZSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHRvU3RyaW5nKCkge1xuICAgIGxldCByZXN1bHQgPSBbXTtcblxuICAgIHRoaXMub3V0bGV0cy5mb3JFYWNoKChvdXRsZXQpID0+IHtcbiAgICAgIGNvbnN0IG91dGxldFN0YXRlcyA9IG91dGxldC5zdGF0ZXM7XG4gICAgICBjb25zdCBvdXRsZXRMb2cgPSBvdXRsZXRTdGF0ZXNcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgICAubWFwKCh2LCBpKSA9PiBgJHtvdXRsZXQub3V0bGV0S2V5c30uJHtpfS5bJHt2LmlzUGFnZU5hdmlnYXRpb24gPyAnUEFHRScgOiAnSU5URVJOQUwnfV0uWyR7b3V0bGV0Lm1vZGFsTmF2aWdhdGlvbkRlcHRoID8gJ01PREFMJyA6ICdCQVNFJ31dIFwiJHt2LnNlZ21lbnRHcm91cC50b1N0cmluZygpfVwiYClcbiAgICAgICAgLnJldmVyc2UoKTtcblxuICAgICAgcmVzdWx0ID0gcmVzdWx0LmNvbmNhdChvdXRsZXRMb2cpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJlc3VsdC5qb2luKCdcXG4nKTtcbiAgfVxuXG4gIC8vIE1ldGhvZHMgZm9yIHN5bmNpbmcgd2l0aCBwYWdlIG5hdmlnYXRpb24gaW4gUGFnZVJvdXRlck91dGxldFxuICBwdWJsaWMgX2JlZ2luQmFja1BhZ2VOYXZpZ2F0aW9uKGZyYW1lOiBGcmFtZSwgb3V0bGV0S2V5OiBzdHJpbmcpIHtcbiAgICBjb25zdCBvdXRsZXQ6IE91dGxldCA9IHRoaXMuZ2V0T3V0bGV0QnlGcmFtZShmcmFtZSk7XG5cbiAgICBpZiAoIW91dGxldCB8fCBvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2spIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJFcnJvcignQXR0ZW1wdGVkIHRvIGNhbGwgc3RhcnRHb0JhY2sgd2hpbGUgZ29pbmcgYmFjay4nKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnTlNMb2NhdGlvblN0cmF0ZWd5LnN0YXJ0R29CYWNrKCknKTtcbiAgICB9XG4gICAgb3V0bGV0LnNldE91dGxldEtleU5hdmlnYXRpbmdCYWNrKG91dGxldEtleSk7XG4gICAgLy8gb3V0bGV0LmlzUGFnZU5hdmlnYXRpb25CYWNrID0gdHJ1ZTtcbiAgICAvLyB3ZSBmaW5kIGFsbCB0aGUgY2hpbGRyZW4gYW5kIGFsc28gc2V0IHRoZWlyIGlzUGFnZU5hdmlnYXRpb25CYWNrXG4gICAgdGhpcy5vdXRsZXRzXG4gICAgICAuZmlsdGVyKChvKSA9PiB7XG4gICAgICAgIGxldCBwYXJlbnQgPSBvLnBhcmVudDtcbiAgICAgICAgd2hpbGUgKHBhcmVudCkge1xuICAgICAgICAgIGlmIChwYXJlbnQgPT09IG91dGxldCkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSlcbiAgICAgIC5mb3JFYWNoKChvKSA9PiAoby5pc1BhZ2VOYXZpZ2F0aW9uQmFjayA9IHRydWUpKTtcblxuICAgIHRoaXMuY3VycmVudE91dGxldCA9IG91dGxldDtcbiAgfVxuXG4gIHB1YmxpYyBfZmluaXNoQmFja1BhZ2VOYXZpZ2F0aW9uKGZyYW1lOiBGcmFtZSkge1xuICAgIGNvbnN0IG91dGxldDogT3V0bGV0ID0gdGhpcy5nZXRPdXRsZXRCeUZyYW1lKGZyYW1lKTtcblxuICAgIGlmICghb3V0bGV0IHx8ICFvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2spIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJFcnJvcignQXR0ZW1wdGVkIHRvIGNhbGwgZW5kR29CYWNrIHdoaWxlIG5vdCBnb2luZyBiYWNrLicpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuZmluaXNoQmFja1BhZ2VOYXZpZ2F0aW9uKCknKTtcbiAgICB9XG4gICAgb3V0bGV0LmlzUGFnZU5hdmlnYXRpb25CYWNrID0gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgX2JlZ2luTW9kYWxOYXZpZ2F0aW9uKGZyYW1lOiBGcmFtZSk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuX2JlZ2luTW9kYWxOYXZpZ2F0aW9uKCknKTtcbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSB0aGlzLmdldE91dGxldEJ5RnJhbWUoZnJhbWUpIHx8IHRoaXMuY3VycmVudE91dGxldDtcblxuICAgIC8vIEl0IGlzIHBvc3NpYmxlIHRvIGhhdmUgZnJhbWUsIGJ1dCBub3QgY29ycmVzcG9uZGluZyBPdXRsZXQsIGlmXG4gICAgLy8gc2hvd2luZyBtb2RhbCBkaWFsb2cgb24gYXBwLmNvbXBvbmVudC50cyBuZ09uSW5pdCgpIGUuZy4gSW4gdGhhdCBjYXNlXG4gICAgLy8gdGhlIG1vZGFsIGlzIHRyZWF0ZWQgYXMgbm9uZSBtb2RhbCBuYXZpZ2F0aW9uLlxuICAgIGlmICh0aGlzLmN1cnJlbnRPdXRsZXQpIHtcbiAgICAgIHRoaXMuY3VycmVudE91dGxldC5zaG93aW5nTW9kYWwgPSB0cnVlO1xuICAgICAgdGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGgrKztcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgX2Nsb3NlTW9kYWxOYXZpZ2F0aW9uKCkge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuY2xvc2VNb2RhbE5hdmlnYXRpb24oKScpO1xuICAgIH1cblxuICAgIGNvbnN0IGlzU2hvd2luZ01vZGFsID0gdGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGggPiAwO1xuXG4gICAgaWYgKGlzU2hvd2luZ01vZGFsKSB7XG4gICAgICB0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aC0tO1xuICAgIH1cblxuICAgIC8vIGN1cnJlbnRPdXRsZXQgc2hvdWxkIGJlIHRoZSBvbmUgdGhhdCBjb3JyZXNwb25kcyB0byB0aGUgdG9wbW9zdCBmcmFtZVxuICAgIGNvbnN0IHRvcG1vc3RPdXRsZXQgPSB0aGlzLmdldE91dGxldEJ5RnJhbWUodGhpcy5mcmFtZVNlcnZpY2UuZ2V0RnJhbWUoKSk7XG4gICAgY29uc3Qgb3V0bGV0ID0gdGhpcy5maW5kT3V0bGV0QnlNb2RhbCh0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCwgaXNTaG93aW5nTW9kYWwpIHx8IHRvcG1vc3RPdXRsZXQ7XG5cbiAgICBpZiAob3V0bGV0KSB7XG4gICAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBvdXRsZXQ7XG4gICAgICB0aGlzLmN1cnJlbnRPdXRsZXQuc2hvd2luZ01vZGFsID0gZmFsc2U7XG4gICAgICB0aGlzLmNhbGxQb3BTdGF0ZSh0aGlzLmN1cnJlbnRPdXRsZXQucGVla1N0YXRlKCksIGZhbHNlKTtcbiAgICAgIC8vIHRoaXMgaXMgbmVlZGVkIGJlY2F1c2UgYW5ndWxhciBkb2VzIGEgc2V0VGltZW91dCBvbiBvblBvcFN0YXRlLCBzbyBpZiB3ZSBkb24ndCBkbyB0aGlzIHdlIG1pZ2h0IGVuZCB1cCB3aXRoIGluY29uc2lzdGVudCBzdGF0ZVxuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDApKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgX2JlZ2luUGFnZU5hdmlnYXRpb24oZnJhbWU6IEZyYW1lLCBvcHRpb25zPzogTmF2aWdhdGlvbk9wdGlvbnMpOiBOYXZpZ2F0aW9uT3B0aW9ucyB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5fYmVnaW5QYWdlTmF2aWdhdGlvbigpJyk7XG4gICAgfVxuXG4gICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gdGhpcy5nZXRPdXRsZXRCeUZyYW1lKGZyYW1lKSB8fCB0aGlzLmN1cnJlbnRPdXRsZXQ7XG4gICAgY29uc3QgbGFzdFN0YXRlID0gdGhpcy5jdXJyZW50T3V0bGV0LnBlZWtTdGF0ZSgpO1xuXG4gICAgaWYgKGxhc3RTdGF0ZSkge1xuICAgICAgbGFzdFN0YXRlLmlzUGFnZU5hdmlnYXRpb24gPSB0cnVlO1xuICAgIH1cblxuICAgIGNvbnN0IG5hdk9wdGlvbnMgPSBvcHRpb25zIHx8IGRlZmF1bHROYXZPcHRpb25zO1xuXG4gICAgaWYgKG5hdk9wdGlvbnMuY2xlYXJIaXN0b3J5KSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdOU0xvY2F0aW9uU3RyYXRlZ3kuX2JlZ2luUGFnZU5hdmlnYXRpb24gY2xlYXJpbmcgc3RhdGVzIGhpc3RvcnknKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuY3VycmVudE91dGxldC5zdGF0ZXMgPSBbbGFzdFN0YXRlXTtcbiAgICB9XG4gICAgcmV0dXJuIG5hdk9wdGlvbnM7XG4gIH1cblxuICBwdWJsaWMgX2dldE91dGxldHMoKTogQXJyYXk8T3V0bGV0PiB7XG4gICAgcmV0dXJuIHRoaXMub3V0bGV0cztcbiAgfVxuXG4gIHVwZGF0ZU91dGxldEZyYW1lKG91dGxldDogT3V0bGV0LCBmcmFtZTogRnJhbWUsIGlzRW1wdHlPdXRsZXRGcmFtZTogYm9vbGVhbikge1xuICAgIGNvbnN0IGxhc3RTdGF0ZSA9IG91dGxldC5wZWVrU3RhdGUoKTtcblxuICAgIGlmIChsYXN0U3RhdGUgJiYgIWxhc3RTdGF0ZS5mcmFtZSAmJiAhaXNFbXB0eU91dGxldEZyYW1lKSB7XG4gICAgICBsYXN0U3RhdGUuZnJhbWUgPSBmcmFtZTtcbiAgICB9XG5cbiAgICBpZiAoIW91dGxldC5jb250YWluc0ZyYW1lKGZyYW1lKSkge1xuICAgICAgb3V0bGV0LmZyYW1lcy5wdXNoKGZyYW1lKTtcbiAgICB9XG4gICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gb3V0bGV0O1xuICB9XG5cbiAgY2xlYXJPdXRsZXQoZnJhbWU6IEZyYW1lKSB7XG4gICAgdGhpcy5vdXRsZXRzID0gdGhpcy5vdXRsZXRzLmZpbHRlcigoY3VycmVudE91dGxldCkgPT4ge1xuICAgICAgbGV0IGlzRXF1YWxUb0N1cnJlbnQ7XG5cbiAgICAgIGlmICh0aGlzLmN1cnJlbnRPdXRsZXQpIHtcbiAgICAgICAgaXNFcXVhbFRvQ3VycmVudCA9IGN1cnJlbnRPdXRsZXQucGF0aEJ5T3V0bGV0cyA9PT0gdGhpcy5jdXJyZW50T3V0bGV0LnBhdGhCeU91dGxldHM7XG4gICAgICB9XG5cbiAgICAgIC8vIFJlbW92ZSBvdXRsZXQgZnJvbSB0aGUgdXJsIHRyZWUuXG4gICAgICBpZiAoY3VycmVudE91dGxldC5jb250YWluc0ZyYW1lKGZyYW1lKSAmJiAhaXNFcXVhbFRvQ3VycmVudCkge1xuICAgICAgICB0aGlzLmNhbGxQb3BTdGF0ZShudWxsLCB0cnVlLCBjdXJyZW50T3V0bGV0KTtcbiAgICAgIH1cblxuICAgICAgLy8gU2tpcCBmcmFtZXMgZmlsdGVyaW5nIHNpbmNlIGN1cnJlbnRPdXRsZXQgaXMgPHJvdXRlci1vdXRsZXQ+IHdoZW4gbm8gZnJhbWVzIGF2YWlsYWJsZS5cbiAgICAgIGlmIChjdXJyZW50T3V0bGV0LmZyYW1lcy5sZW5ndGggJiYgIWN1cnJlbnRPdXRsZXQuaXNOU0VtcHR5T3V0bGV0KSB7XG4gICAgICAgIGN1cnJlbnRPdXRsZXQuZnJhbWVzID0gY3VycmVudE91dGxldC5mcmFtZXMuZmlsdGVyKChjdXJyZW50RnJhbWUpID0+IGN1cnJlbnRGcmFtZSAhPT0gZnJhbWUpO1xuICAgICAgICByZXR1cm4gY3VycmVudE91dGxldC5mcmFtZXMubGVuZ3RoO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gIWN1cnJlbnRPdXRsZXQuY29udGFpbnNGcmFtZShmcmFtZSk7XG4gICAgfSk7XG4gIH1cblxuICBnZXRTZWdtZW50R3JvdXBGdWxsUGF0aChzZWdtZW50R3JvdXA6IFVybFNlZ21lbnRHcm91cCk6IHN0cmluZyB7XG4gICAgbGV0IGZ1bGxQYXRoID0gJyc7XG5cbiAgICB3aGlsZSAoc2VnbWVudEdyb3VwKSB7XG4gICAgICBjb25zdCB1cmwgPSBzZWdtZW50R3JvdXAudG9TdHJpbmcoKTtcblxuICAgICAgaWYgKGZ1bGxQYXRoKSB7XG4gICAgICAgIGZ1bGxQYXRoID0gKHVybCA/IHVybCArICcvJyA6ICcnKSArIGZ1bGxQYXRoO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZnVsbFBhdGggPSB1cmw7XG4gICAgICB9XG5cbiAgICAgIHNlZ21lbnRHcm91cCA9IHNlZ21lbnRHcm91cC5wYXJlbnQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZ1bGxQYXRoO1xuICB9XG5cbiAgZ2V0Um91dGVGdWxsUGF0aChjdXJyZW50Um91dGU6IGFueSk6IHN0cmluZyB7XG4gICAgY29uc3Qgb3V0bGV0TmFtZSA9IGN1cnJlbnRSb3V0ZS5vdXRsZXQ7XG4gICAgbGV0IGZ1bGxQYXRoO1xuXG4gICAgY3VycmVudFJvdXRlID0gY3VycmVudFJvdXRlLnBhcmVudDtcbiAgICB3aGlsZSAoY3VycmVudFJvdXRlKSB7XG4gICAgICBjb25zdCB1cmxzID0gY3VycmVudFJvdXRlLnVybC52YWx1ZSB8fCBjdXJyZW50Um91dGUudXJsO1xuICAgICAgbGV0IHVybCA9IHVybHM7XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHVybHMpKSB7XG4gICAgICAgIHVybCA9IHVybC5qb2luKCcvJyk7XG4gICAgICB9XG5cbiAgICAgIGZ1bGxQYXRoID0gZnVsbFBhdGggPyAodXJsID8gdXJsICsgJy8nIDogdXJsKSArIGZ1bGxQYXRoIDogdXJsO1xuICAgICAgY3VycmVudFJvdXRlID0gY3VycmVudFJvdXRlLnBhcmVudDtcbiAgICB9XG5cbiAgICByZXR1cm4gZnVsbFBhdGggPyBmdWxsUGF0aCArICctJyArIG91dGxldE5hbWUgOiBvdXRsZXROYW1lO1xuICB9XG5cbiAgZ2V0UGF0aEJ5T3V0bGV0cyh1cmxTZWdtZW50R3JvdXA6IGFueSk6IHN0cmluZyB7XG4gICAgaWYgKCF1cmxTZWdtZW50R3JvdXApIHtcbiAgICAgIHJldHVybiAnJztcbiAgICB9XG5cbiAgICBsZXQgcGF0aFRvT3V0bGV0O1xuICAgIGxldCBsYXN0UGF0aCA9IHVybFNlZ21lbnRHcm91cC5vdXRsZXQgfHwgJ3ByaW1hcnknO1xuICAgIGxldCBwYXJlbnQgPSB1cmxTZWdtZW50R3JvdXAucGFyZW50O1xuXG4gICAgd2hpbGUgKHBhcmVudCAmJiB1cmxTZWdtZW50R3JvdXAucm9vdCAhPT0gcGFyZW50KSB7XG4gICAgICBpZiAocGFyZW50ICYmIHBhcmVudC5vdXRsZXQgIT09IGxhc3RQYXRoKSB7XG4gICAgICAgIGlmIChsYXN0UGF0aCA9PT0gJ3ByaW1hcnknKSB7XG4gICAgICAgICAgbGFzdFBhdGggPSBwYXJlbnQub3V0bGV0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxhc3RQYXRoID0gcGFyZW50Lm91dGxldDtcbiAgICAgICAgICBwYXRoVG9PdXRsZXQgPSBsYXN0UGF0aCArICctJyArIChwYXRoVG9PdXRsZXQgfHwgdXJsU2VnbWVudEdyb3VwLm91dGxldCk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudDtcbiAgICB9XG5cbiAgICByZXR1cm4gcGF0aFRvT3V0bGV0IHx8IGxhc3RQYXRoO1xuICB9XG5cbiAgZmluZE91dGxldChvdXRsZXRLZXk6IHN0cmluZywgYWN0aXZhdGVkUm91dGVTbmFwc2hvdD86IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBPdXRsZXQge1xuICAgIGxldCBvdXRsZXQ6IE91dGxldCA9IHRoaXMub3V0bGV0cy5maW5kKChjdXJyZW50T3V0bGV0KSA9PiB7XG4gICAgICBjb25zdCBlcXVhbE1vZGFsRGVwdGggPSBjdXJyZW50T3V0bGV0Lm1vZGFsTmF2aWdhdGlvbkRlcHRoID09PSB0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aDtcbiAgICAgIHJldHVybiBlcXVhbE1vZGFsRGVwdGggJiYgY3VycmVudE91dGxldC5vdXRsZXRLZXlzLmluZGV4T2Yob3V0bGV0S2V5KSA+IC0xO1xuICAgIH0pO1xuXG4gICAgLy8gTm8gT3V0bGV0IHdpdGggdGhlIGdpdmVuIG91dGxldEtleSBjb3VsZCBoYXBwZW4gd2hlbiB1c2luZyBuZXN0ZWQgdW5uYW1lZCBwLXItb1xuICAgIC8vIHByaW1hcnkgLT4gcHJpbWFyeSAtPiBwcnltYXJ5XG4gICAgaWYgKCFvdXRsZXQgJiYgYWN0aXZhdGVkUm91dGVTbmFwc2hvdCkge1xuICAgICAgY29uc3QgcGF0aEJ5T3V0bGV0cyA9IHRoaXMuZ2V0UGF0aEJ5T3V0bGV0cyhhY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTtcbiAgICAgIG91dGxldCA9IHRoaXMub3V0bGV0cy5maW5kKChjdXJyZW50T3V0bGV0KSA9PiB7XG4gICAgICAgIGNvbnN0IGVxdWFsTW9kYWxEZXB0aCA9IGN1cnJlbnRPdXRsZXQubW9kYWxOYXZpZ2F0aW9uRGVwdGggPT09IHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoO1xuICAgICAgICByZXR1cm4gZXF1YWxNb2RhbERlcHRoICYmIGN1cnJlbnRPdXRsZXQucGF0aEJ5T3V0bGV0cyA9PT0gcGF0aEJ5T3V0bGV0cztcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBvdXRsZXQ7XG4gIH1cblxuICBwcml2YXRlIGZpbmRPdXRsZXRCeU1vZGFsKG1vZGFsTmF2aWdhdGlvbjogbnVtYmVyLCBpc1Nob3dpbmdNb2RhbD86IGJvb2xlYW4pOiBPdXRsZXQge1xuICAgIHJldHVybiB0aGlzLm91dGxldHMuZmluZCgob3V0bGV0KSA9PiB7XG4gICAgICBjb25zdCBlcXVhbE1vZGFsRGVwdGggPSBvdXRsZXQubW9kYWxOYXZpZ2F0aW9uRGVwdGggPT09IG1vZGFsTmF2aWdhdGlvbjtcbiAgICAgIHJldHVybiBpc1Nob3dpbmdNb2RhbCA/IGVxdWFsTW9kYWxEZXB0aCAmJiBvdXRsZXQuc2hvd2luZ01vZGFsIDogZXF1YWxNb2RhbERlcHRoO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRPdXRsZXRCeUZyYW1lKGZyYW1lOiBGcmFtZSk6IE91dGxldCB7XG4gICAgbGV0IG91dGxldDtcblxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0aGlzLm91dGxldHMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCBjdXJyZW50T3V0bGV0ID0gdGhpcy5vdXRsZXRzW2luZGV4XTtcblxuICAgICAgaWYgKGN1cnJlbnRPdXRsZXQuY29udGFpbnNGcmFtZShmcmFtZSkpIHtcbiAgICAgICAgb3V0bGV0ID0gY3VycmVudE91dGxldDtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG91dGxldDtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlU3RhdGVzKG91dGxldDogT3V0bGV0LCBjdXJyZW50U2VnbWVudEdyb3VwOiBVcmxTZWdtZW50R3JvdXAsIHF1ZXJ5UGFyYW1zOiBQYXJhbXMsIHJlcGxhY2UgPSBmYWxzZSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGlzTmV3UGFnZSA9IG91dGxldC5zdGF0ZXMubGVuZ3RoID09PSAwO1xuICAgIGNvbnN0IGxhc3RTdGF0ZSA9IG91dGxldC5zdGF0ZXNbb3V0bGV0LnN0YXRlcy5sZW5ndGggLSAxXTtcbiAgICBjb25zdCBlcXVhbFN0YXRlVXJscyA9IG91dGxldC5jb250YWluc1RvcFN0YXRlKGN1cnJlbnRTZWdtZW50R3JvdXAudG9TdHJpbmcoKSk7XG5cbiAgICBjb25zdCBsb2NhdGlvblN0YXRlOiBMb2NhdGlvblN0YXRlID0ge1xuICAgICAgc2VnbWVudEdyb3VwOiBjdXJyZW50U2VnbWVudEdyb3VwLFxuICAgICAgaXNSb290U2VnbWVudEdyb3VwOiBmYWxzZSxcbiAgICAgIGlzUGFnZU5hdmlnYXRpb246IGlzTmV3UGFnZSxcbiAgICAgIHF1ZXJ5UGFyYW1zOiB7IC4uLnF1ZXJ5UGFyYW1zIH0sXG4gICAgfTtcblxuICAgIGlmICghbGFzdFN0YXRlIHx8ICFlcXVhbFN0YXRlVXJscykge1xuICAgICAgaWYgKHJlcGxhY2UpIHtcbiAgICAgICAgb3V0bGV0LnN0YXRlcy5wb3AoKTtcbiAgICAgIH1cbiAgICAgIG91dGxldC5zdGF0ZXMucHVzaChsb2NhdGlvblN0YXRlKTtcblxuICAgICAgLy8gVXBkYXRlIGxhc3Qgc3RhdGUgc2VnbWVudEdyb3VwIG9mIHBhcmVudCBPdXRsZXQuXG4gICAgICBpZiAodGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGggPT09IDAgJiYgIW91dGxldC5zaG93aW5nTW9kYWwpIHtcbiAgICAgICAgdGhpcy51cGRhdGVQYXJlbnRzU3RhdGVzKG91dGxldCwgY3VycmVudFNlZ21lbnRHcm91cC5wYXJlbnQpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGxhc3RTdGF0ZSAmJiBlcXVhbFN0YXRlVXJscykge1xuICAgICAgICAvLyB1cGRhdGUgcXVlcnkgcGFyYW1zIGZvciBsYXN0IHN0YXRlXG4gICAgICAgIGxhc3RTdGF0ZS5xdWVyeVBhcmFtcyA9IHsgLi4ucXVlcnlQYXJhbXMgfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVBhcmVudHNTdGF0ZXMob3V0bGV0OiBPdXRsZXQsIG5ld1NlZ21lbnRHcm91cDogVXJsU2VnbWVudEdyb3VwKSB7XG4gICAgbGV0IHBhcmVudE91dGxldCA9IG91dGxldC5wYXJlbnQ7XG5cbiAgICAvLyBVcGRhdGUgcGFyZW50cyBsYXN0U3RhdGUgc2VnbWVudEdyb3Vwc1xuICAgIHdoaWxlIChwYXJlbnRPdXRsZXQgJiYgbmV3U2VnbWVudEdyb3VwKSB7XG4gICAgICBjb25zdCBzdGF0ZSA9IHBhcmVudE91dGxldC5wZWVrU3RhdGUoKTtcblxuICAgICAgaWYgKHN0YXRlKSB7XG4gICAgICAgIHN0YXRlLnNlZ21lbnRHcm91cCA9IG5ld1NlZ21lbnRHcm91cDtcbiAgICAgICAgbmV3U2VnbWVudEdyb3VwID0gbmV3U2VnbWVudEdyb3VwLnBhcmVudDtcbiAgICAgICAgcGFyZW50T3V0bGV0ID0gcGFyZW50T3V0bGV0LnBhcmVudDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gIHByaXZhdGUgY3JlYXRlT3V0bGV0KG91dGxldEtleTogc3RyaW5nLCBwYXRoOiBzdHJpbmcsIHNlZ21lbnRHcm91cDogYW55LCBwYXJlbnQ6IE91dGxldCwgbW9kYWxOYXZpZ2F0aW9uPzogbnVtYmVyLCBxdWVyeVBhcmFtczogUGFyYW1zID0ge30pOiBPdXRsZXQge1xuICAgIGNvbnN0IHBhdGhCeU91dGxldHMgPSB0aGlzLmdldFBhdGhCeU91dGxldHMoc2VnbWVudEdyb3VwKTtcbiAgICBjb25zdCBuZXdPdXRsZXQgPSBuZXcgT3V0bGV0KG91dGxldEtleSwgcGF0aCwgcGF0aEJ5T3V0bGV0cywgbW9kYWxOYXZpZ2F0aW9uKTtcblxuICAgIGNvbnN0IGxvY2F0aW9uU3RhdGU6IExvY2F0aW9uU3RhdGUgPSB7XG4gICAgICBzZWdtZW50R3JvdXA6IHNlZ21lbnRHcm91cCxcbiAgICAgIGlzUm9vdFNlZ21lbnRHcm91cDogZmFsc2UsXG4gICAgICBpc1BhZ2VOYXZpZ2F0aW9uOiB0cnVlLCAvLyBJdCBpcyBhIG5ldyBPdXRsZXROb2RlLlxuICAgICAgcXVlcnlQYXJhbXM6IHsgLi4ucXVlcnlQYXJhbXMgfSxcbiAgICB9O1xuXG4gICAgbmV3T3V0bGV0LnN0YXRlcyA9IFtsb2NhdGlvblN0YXRlXTtcbiAgICBuZXdPdXRsZXQucGFyZW50ID0gcGFyZW50O1xuICAgIHRoaXMub3V0bGV0cy5wdXNoKG5ld091dGxldCk7XG5cbiAgICAvLyBVcGRhdGUgbGFzdCBzdGF0ZSBzZWdtZW50R3JvdXAgb2YgcGFyZW50IE91dGxldC5cbiAgICBpZiAodGhpcy5fbW9kYWxOYXZpZ2F0aW9uRGVwdGggPT09IDAgJiYgIW5ld091dGxldC5zaG93aW5nTW9kYWwpIHtcbiAgICAgIHRoaXMudXBkYXRlUGFyZW50c1N0YXRlcyhuZXdPdXRsZXQsIHNlZ21lbnRHcm91cC5wYXJlbnQpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXdPdXRsZXQ7XG4gIH1cblxuICBwcml2YXRlIGdldFNlZ21lbnRHcm91cEJ5T3V0bGV0KG91dGxldDogT3V0bGV0KTogVXJsU2VnbWVudEdyb3VwIHtcbiAgICBjb25zdCBwYXRoTGlzdCA9IG91dGxldC5wYXRoQnlPdXRsZXRzLnNwbGl0KCctJyk7XG4gICAgbGV0IHNlZ21lbnRHcm91cCA9IHRoaXMuY3VycmVudFVybFRyZWUucm9vdDtcbiAgICBsZXQgcGF0aFRvT3V0bGV0O1xuXG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHBhdGhMaXN0Lmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgY29uc3QgY3VycmVudFBhdGggPSBwYXRoTGlzdFtpbmRleF07XG4gICAgICBjb25zdCBjaGlsZHJlbkNvdW50ID0gT2JqZWN0LmtleXMoc2VnbWVudEdyb3VwLmNoaWxkcmVuKS5sZW5ndGg7XG5cbiAgICAgIGlmIChjaGlsZHJlbkNvdW50ICYmIHNlZ21lbnRHcm91cC5jaGlsZHJlbltjdXJyZW50UGF0aF0pIHtcbiAgICAgICAgY29uc3QgdXJsID0gc2VnbWVudEdyb3VwLnRvU3RyaW5nKCk7XG4gICAgICAgIHBhdGhUb091dGxldCA9IHBhdGhUb091dGxldCA/IHBhdGhUb091dGxldCArICcvJyArIHVybCA6IHVybDtcbiAgICAgICAgc2VnbWVudEdyb3VwID0gc2VnbWVudEdyb3VwLmNoaWxkcmVuW2N1cnJlbnRQYXRoXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIElmIG5vIGNoaWxkIG91dGxldCBmb3VuZCB3aXRoIHRoZSBnaXZlbiBuYW1lIC0gZm9yZ2V0IGFib3V0IGFsbCBwcmV2aW91c2x5IGZvdW5kIG91dGxldHMuXG4gICAgICAgIC8vIGV4YW1wbGU6IHNlYWNoaW5nIGZvciAncHJpbWFyeS1zZWNvbmQtcHJpbWFyeScgc2hvdWxkbid0IHJldHVybiAncHJpbWFyeS1zZWNvbmQnXG4gICAgICAgIC8vIGlmIG5vICdwcmltYXJ5JyBjaGlsZCBhdmFpbGFibGUgb24gJ3NlY29uZCcuXG4gICAgICAgIHNlZ21lbnRHcm91cCA9IG51bGw7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFBhdGhzIHNob3VsZCBhbHNvIG1hdGNoIHNpbmNlIHRoZXJlIGNvdWxkIGJlIGFub3RoZXIgT3V0bGV0XG4gICAgLy8gd2l0aCB0aGUgc2FtZSBwYXRoQnlPdXRsZXRzIGJ1dCBkaWZmZXJlbnQgdXJsIHBhdGguXG4gICAgaWYgKHNlZ21lbnRHcm91cCAmJiBvdXRsZXQucGF0aCAmJiBwYXRoVG9PdXRsZXQgJiYgb3V0bGV0LnBhdGggIT09IHBhdGhUb091dGxldCkge1xuICAgICAgc2VnbWVudEdyb3VwID0gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gc2VnbWVudEdyb3VwO1xuICB9XG5cbiAgLy8gVHJhdmVyc2FsIGFuZCByZXBsYWNlbWVudCBvZiBzZWdtZW50R3JvdXAuXG4gIHByaXZhdGUgdXBkYXRlU2VnbWVudEdyb3VwKHJvb3ROb2RlOiBhbnksIG9sZFNlZ21lbnRHcm91cDogVXJsU2VnbWVudEdyb3VwLCBuZXdTZWdtZW50R3JvdXA6IFVybFNlZ21lbnRHcm91cCkge1xuICAgIGNvbnN0IHF1ZXVlID0gW107XG4gICAgbGV0IGN1cnJlbnRUcmVlID0gcm9vdE5vZGU7XG5cbiAgICB3aGlsZSAoY3VycmVudFRyZWUpIHtcbiAgICAgIE9iamVjdC5rZXlzKGN1cnJlbnRUcmVlLmNoaWxkcmVuKS5mb3JFYWNoKChvdXRsZXROYW1lKSA9PiB7XG4gICAgICAgIGlmIChjdXJyZW50VHJlZS5jaGlsZHJlbltvdXRsZXROYW1lXSA9PT0gb2xkU2VnbWVudEdyb3VwKSB7XG4gICAgICAgICAgaWYgKG5ld1NlZ21lbnRHcm91cCkge1xuICAgICAgICAgICAgY3VycmVudFRyZWUuY2hpbGRyZW5bb3V0bGV0TmFtZV0gPSBuZXdTZWdtZW50R3JvdXA7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRlbGV0ZSBjdXJyZW50VHJlZS5jaGlsZHJlbltvdXRsZXROYW1lXTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcXVldWUucHVzaChjdXJyZW50VHJlZS5jaGlsZHJlbltvdXRsZXROYW1lXSk7XG4gICAgICB9KTtcblxuICAgICAgY3VycmVudFRyZWUgPSBxdWV1ZS5zaGlmdCgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBzZXJ0TW9kYWxPdXRsZXQocGFyZW50T3V0bGV0OiBPdXRsZXQsIHNlZ21lbnRlZEdyb3VwOiBVcmxTZWdtZW50R3JvdXAsIHF1ZXJ5UGFyYW1zOiBQYXJhbXMsIHJlcGxhY2UgPSBmYWxzZSkge1xuICAgIGxldCBjdXJyZW50TW9kYWxPdXRsZXQgPSB0aGlzLmZpbmRPdXRsZXRCeU1vZGFsKHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoKTtcblxuICAgIC8vIFdlIHdhbnQgdG8gdHJlYXQgZXZlcnkgcC1yLW8gYXMgYSBzdGFuZGFsb25lIE91dGxldC5cbiAgICBpZiAoIWN1cnJlbnRNb2RhbE91dGxldCkge1xuICAgICAgaWYgKHRoaXMuX21vZGFsTmF2aWdhdGlvbkRlcHRoID4gMSkge1xuICAgICAgICAvLyBUaGUgcGFyZW50IG9mIHRoZSBjdXJyZW50IE91dGxldCBzaG91bGQgYmUgdGhlIHByZXZpb3VzIG9wZW5lZCBtb2RhbCAoaWYgYW55KS5cbiAgICAgICAgcGFyZW50T3V0bGV0ID0gdGhpcy5maW5kT3V0bGV0QnlNb2RhbCh0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCAtIDEpO1xuICAgICAgfVxuXG4gICAgICAvLyBObyBjdXJyZW50TW9kYWxPdXRsZXQgYXZhaWxhYmxlIHdoZW4gb3BlbmluZyAncHJpbWFyeScgcC1yLW8uXG4gICAgICBjb25zdCBvdXRsZXROYW1lID0gJ3ByaW1hcnknO1xuICAgICAgY29uc3Qgb3V0bGV0UGF0aCA9IHBhcmVudE91dGxldC5wZWVrU3RhdGUoKS5zZWdtZW50R3JvdXAudG9TdHJpbmcoKTtcbiAgICAgIGNvbnN0IG91dGxldEtleSA9IHRoaXMuZ2V0T3V0bGV0S2V5KG91dGxldFBhdGgsIG91dGxldE5hbWUpO1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgY3VycmVudE1vZGFsT3V0bGV0ID0gdGhpcy5jcmVhdGVPdXRsZXQob3V0bGV0S2V5LCBvdXRsZXRQYXRoLCBzZWdtZW50ZWRHcm91cCwgcGFyZW50T3V0bGV0LCB0aGlzLl9tb2RhbE5hdmlnYXRpb25EZXB0aCwgcXVlcnlQYXJhbXMpO1xuICAgICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gY3VycmVudE1vZGFsT3V0bGV0O1xuICAgIH0gZWxzZSBpZiAodGhpcy51cGRhdGVTdGF0ZXMoY3VycmVudE1vZGFsT3V0bGV0LCBzZWdtZW50ZWRHcm91cCwgcXVlcnlQYXJhbXMsIHJlcGxhY2UpKSB7XG4gICAgICB0aGlzLmN1cnJlbnRPdXRsZXQgPSBjdXJyZW50TW9kYWxPdXRsZXQ7IC8vIElmIHN0YXRlcyB1cGRhdGVkXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRPdXRsZXRLZXkocGF0aDogc3RyaW5nLCBvdXRsZXROYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBwYXRoID8gcGF0aCArICctJyArIG91dGxldE5hbWUgOiBvdXRsZXROYW1lO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ05TTG9jYXRpb25TdHJhdGVneS5uZ09uRGVzdHJveSgpJyk7XG4gICAgfVxuXG4gICAgdGhpcy5vdXRsZXRzID0gW107XG4gICAgdGhpcy5jdXJyZW50T3V0bGV0ID0gbnVsbDtcbiAgfVxufVxuIl19