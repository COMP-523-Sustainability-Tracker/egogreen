import { __decorate, __metadata } from "tslib";
import { Attribute, ChangeDetectorRef, ComponentFactoryResolver, ComponentRef, Directive, Inject, Injector, EventEmitter, Output, ViewContainerRef, ElementRef, InjectFlags, NgZone, EnvironmentInjector } from '@angular/core';
import { ActivatedRoute, ChildrenOutletContexts, PRIMARY_OUTLET, Router } from '@angular/router';
import { Frame, Page, profile } from '@nativescript/core';
import { BehaviorSubject } from 'rxjs';
import { PAGE_FACTORY } from '../../tokens';
import { NativeScriptDebug } from '../../trace';
import { DetachedLoader } from '../../cdk/detached-loader';
import { ViewUtil } from '../../view-util';
import { NSLocationStrategy } from './ns-location-strategy';
import { defaultNavOptions } from './ns-location-utils';
import { NSRouteReuseStrategy } from './ns-route-reuse-strategy';
import { findTopActivatedRouteNodeForOutlet, pageRouterActivatedSymbol, loaderRefSymbol, destroyComponentRef } from './page-router-outlet-utils';
import { registerElement } from '../../element-registry';
import { PageService } from '../../cdk/frame-page/page.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "./ns-location-strategy";
import * as i3 from "./ns-route-reuse-strategy";
import * as i4 from "../../view-util";
export class PageRoute {
    constructor(startRoute) {
        this.activatedRoute = new BehaviorSubject(startRoute);
    }
}
function isComponentFactoryResolver(item) {
    return !!item.resolveComponentFactory;
}
function callableOnce(fn) {
    let called = false;
    return (...args) => {
        if (called) {
            return;
        }
        called = true;
        return fn(...args);
    };
}
export class DestructibleInjector {
    constructor(destructibleProviders, parent) {
        this.destructibleProviders = destructibleProviders;
        this.parent = parent;
        this.refs = new Set();
    }
    get(token, notFoundValue, flags) {
        const ref = this.parent.get(token, notFoundValue, flags);
        // if we're skipping ourselves then it's not our responsibility to destroy
        if (typeof flags === 'number') {
            if (!(flags & InjectFlags.SkipSelf) && this.destructibleProviders.has(token)) {
                this.refs.add(ref);
            }
        }
        else {
            if (!flags?.skipSelf && this.destructibleProviders.has(token)) {
                this.refs.add(ref);
            }
        }
        return ref;
    }
    destroy() {
        this.refs.forEach((ref) => {
            if (ref.ngOnDestroy instanceof Function) {
                ref.ngOnDestroy();
            }
        });
        this.refs.clear();
    }
}
const routeToString = function (activatedRoute) {
    return activatedRoute.pathFromRoot.join('->');
};
registerElement('page-router-outlet', () => Frame);
// eslint-disable-next-line @angular-eslint/directive-selector
class PageRouterOutlet {
    /** @deprecated from Angular since v4 */
    get locationInjector() {
        return this.location.injector;
    }
    /** @deprecated from Angular since v4 */
    get locationFactoryResolver() {
        return this.resolver;
    }
    get isActivated() {
        return !!this.activated;
    }
    get component() {
        if (!this.activated) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Outlet is not activated');
            }
            return;
        }
        return this.activated.instance;
    }
    get activatedRoute() {
        if (!this.activated) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Outlet is not activated');
            }
            return;
        }
        return this._activatedRoute;
    }
    get activatedRouteData() {
        if (this._activatedRoute) {
            return this._activatedRoute.snapshot.data;
        }
        return {};
    }
    constructor(parentContexts, location, name, actionBarVisibility, isEmptyOutlet, locationStrategy, componentFactoryResolver, resolver, changeDetector, pageFactory, routeReuseStrategy, ngZone, router, elRef, viewUtil, environmentInjector) {
        this.parentContexts = parentContexts;
        this.location = location;
        this.locationStrategy = locationStrategy;
        this.componentFactoryResolver = componentFactoryResolver;
        this.resolver = resolver;
        this.changeDetector = changeDetector;
        this.pageFactory = pageFactory;
        this.routeReuseStrategy = routeReuseStrategy;
        this.ngZone = ngZone;
        this.router = router;
        this.environmentInjector = environmentInjector;
        // tslint:disable-line:directive-class-suffix
        this.activated = null;
        this._activatedRoute = null;
        this.attachEvents = new EventEmitter();
        this.detachEvents = new EventEmitter();
        // eslint-disable-next-line @angular-eslint/no-output-rename
        this.activateEvents = new EventEmitter(); // tslint:disable-line:no-output-rename
        // eslint-disable-next-line @angular-eslint/no-output-rename
        this.deactivateEvents = new EventEmitter(); // tslint:disable-line:no-output-rename
        this.isEmptyOutlet = isEmptyOutlet;
        this.frame = elRef.nativeElement;
        this.setActionBarVisibility(actionBarVisibility);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.constructor frame: ${this.frame}`);
        }
        this.name = name || PRIMARY_OUTLET;
        parentContexts.onChildOutletCreated(this.name, this);
        this.viewUtil = viewUtil;
        this.detachedLoaderFactory = resolver.resolveComponentFactory(DetachedLoader);
    }
    setActionBarVisibility(actionBarVisibility) {
        switch (actionBarVisibility) {
            case 'always':
            case 'never':
                this.frame.actionBarVisibility = actionBarVisibility;
                return;
            default:
                this.frame.actionBarVisibility = 'auto';
        }
    }
    ngOnDestroy() {
        // In the event that the `parentContexts` has changed the outlet
        // via the creation of another outlet, the `onChildOutletDestroyed`
        // will be skipped
        if (this.parentContexts.getContext(this.name)?.outlet === this) {
            // Clear accumulated modal view page cache when page-router-outlet
            // destroyed on modal view closing
            this.parentContexts.onChildOutletDestroyed(this.name);
        }
        if (this.outlet) {
            this.outlet.outletKeys.forEach((key) => {
                this.routeReuseStrategy.clearModalCache(key);
            });
            this.locationStrategy.clearOutlet(this.frame);
        }
        else {
            NativeScriptDebug.routerLog('PageRouterOutlet.ngOnDestroy: no outlet available for page-router-outlet');
        }
        if (this.isActivated) {
            const c = this.activated.instance;
            this.activated.hostView.detach();
            destroyComponentRef(this.activated);
            this.deactivateEvents.emit(c);
            this.activated = null;
        }
    }
    deactivate() {
        if (!this.outlet || !this.outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Currently not in page back navigation - component should be detached instead of deactivated.');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('PageRouterOutlet.deactivate() while going back - should destroy');
        }
        if (!this.isActivated) {
            return;
        }
        this.postNavFunction?.();
        const c = this.activated.instance;
        destroyComponentRef(this.activated);
        this.activated = null;
        this._activatedRoute = null;
        this.deactivateEvents.emit(c);
    }
    /**
     * Called when the `RouteReuseStrategy` instructs to detach the subtree
     */
    detach() {
        if (!this.isActivated) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Outlet is not activated');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.detach() - ${routeToString(this._activatedRoute)}`);
        }
        this.postNavFunction?.();
        // Detach from ChangeDetection
        this.activated.hostView.detach();
        const component = this.activated;
        this.activated = null;
        this._activatedRoute = null;
        this.detachEvents.emit(component.instance);
        return component;
    }
    /**
     * Called when the `RouteReuseStrategy` instructs to re-attach a previously detached subtree
     */
    attach(ref, activatedRoute) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.attach() - ${routeToString(activatedRoute)}`);
        }
        this.activated = ref;
        // reattach to ChangeDetection
        this.activated.hostView.markForCheck();
        this.activated.hostView.reattach();
        this._activatedRoute = activatedRoute;
        this.markActivatedRoute(activatedRoute);
        // we have a child with the same name, so we don't finish the back nav
        if (this.isFinalPageRouterOutlet()) {
            this.locationStrategy._finishBackPageNavigation(this.frame);
        }
        this.attachEvents.emit(ref.instance);
    }
    isFinalPageRouterOutlet() {
        let children = this.parentContexts.getContext(this.name)?.children;
        while (children) {
            const childContext = children.getContext(this.name);
            if (!childContext || !childContext.outlet) {
                return true;
            }
            if (childContext.outlet instanceof PageRouterOutlet) {
                return false;
            }
            children = childContext.children;
        }
        return true;
    }
    /**
     * Called by the Router to instantiate a new component during the commit phase of a navigation.
     * This method in turn is responsible for calling the `routerOnActivate` hook of its child.
     */
    activateWith(activatedRoute, resolver) {
        this.outlet = this.outlet || this.getOutlet(activatedRoute.snapshot);
        if (!this.outlet) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerError('No outlet found relative to activated route');
            }
            return;
        }
        this.outlet.isNSEmptyOutlet = this.isEmptyOutlet;
        this.locationStrategy.updateOutletFrame(this.outlet, this.frame, this.isEmptyOutlet);
        if (this.outlet && this.outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Currently in page back navigation - component should be reattached instead of activated.');
            }
            if (this.isFinalPageRouterOutlet()) {
                this.locationStrategy._finishBackPageNavigation(this.frame);
            }
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.activateWith() - ${routeToString(activatedRoute)}`);
        }
        this._activatedRoute = activatedRoute;
        this.markActivatedRoute(activatedRoute);
        this.activateOnGoForward(activatedRoute, resolver || this.environmentInjector);
        this.activateEvents.emit(this.activated.instance);
    }
    activateOnGoForward(activatedRoute, resolverOrInjector) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('PageRouterOutlet.activate() forward navigation - ' + 'create detached loader in the loader container');
        }
        const component = this.getComponentType(activatedRoute);
        const page = this.pageFactory({
            isNavigation: true,
            componentType: component,
        });
        const location = this.location;
        const destructibles = new Set([PageService]);
        const parentInjector = Injector.create({
            providers: [
                { provide: Page, useValue: page },
                { provide: Frame, useValue: this.frame },
                { provide: PageRoute, useValue: new PageRoute(activatedRoute) },
                { provide: ActivatedRoute, useValue: activatedRoute },
                { provide: ChildrenOutletContexts, useValue: this.parentContexts.getOrCreateContext(this.name).children },
                { provide: PageService, useClass: PageService },
            ],
            parent: location.injector,
        });
        const injector = new DestructibleInjector(destructibles, parentInjector);
        let loaderRef;
        if (isComponentFactoryResolver(resolverOrInjector)) {
            const factory = resolverOrInjector.resolveComponentFactory(DetachedLoader);
            loaderRef = location.createComponent(factory, location.length, injector);
        }
        else {
            const environmentInjector = resolverOrInjector;
            loaderRef = location.createComponent(DetachedLoader, { index: location.length, injector, environmentInjector });
        }
        loaderRef.onDestroy(() => injector.destroy());
        this.changeDetector.markForCheck();
        this.activated = loaderRef.instance.loadComponentInLocation(component);
        this.activated.changeDetectorRef.detectChanges();
        this.loadComponentInPage(page, this.activated, { activatedRoute });
        this.activated[loaderRefSymbol] = loaderRef;
    }
    loadComponentInPage(page, componentRef, navigationContext) {
        // Component loaded. Find its root native view.
        const componentView = componentRef.location.nativeElement;
        // Remove it from original native parent.
        this.viewUtil.removeChild(componentView.parent, componentView);
        // Add it to the new page
        this.viewUtil.appendChild(page, componentView);
        let topActivatedRoute = findTopActivatedRouteNodeForOutlet(this._activatedRoute.snapshot);
        let outletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute);
        const thisRouteKey = outletKey;
        while (!this.locationStrategy.findOutlet(outletKey)) {
            topActivatedRoute = topActivatedRoute.parent;
            if (!topActivatedRoute) {
                NativeScriptDebug.routerError('Could not find outlet for route: ' + thisRouteKey);
                break;
            }
            outletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute);
        }
        const navigatedFromCallback = global.Zone.current.wrap((args) => {
            if (args.isBackNavigation) {
                this.locationStrategy._beginBackPageNavigation(this.frame, outletKey);
                this.locationStrategy.back(null, this.frame);
            }
        });
        // TODO: experiment with using NgZone instead of global above
        // const navigatedFromCallback = (args: NavigatedData) => {
        // 	if (args.isBackNavigation) {
        //     this.ngZone.run(() => {
        //       this.locationStrategy._beginBackPageNavigation(this.frame);
        //       this.locationStrategy.back(null, this.frame);
        //     });
        // 	}
        // };
        page.on(Page.navigatedFromEvent, navigatedFromCallback);
        componentRef.onDestroy(() => {
            if (page) {
                page.off(Page.navigatedFromEvent, navigatedFromCallback);
                page = null;
            }
        });
        const navOptions = { ...defaultNavOptions, ...(this.router.getCurrentNavigation().extras || {}) };
        this.locationStrategy._beginPageNavigation(this.frame, navOptions);
        const isReplace = navOptions.replaceUrl && !navOptions.clearHistory;
        const currentRoute = this.activatedRoute;
        // Clear refCache if navigation with clearHistory
        if (navOptions.clearHistory) {
            this.outlet.outletKeys.forEach((key) => this.routeReuseStrategy.markCacheForClear(key));
            const wipeCache = callableOnce(() => {
                if (this.postNavFunction === wipeCache) {
                    this.postNavFunction = null;
                }
                if (this.outlet && this.activatedRoute === currentRoute) {
                    // potential alternative fix (only fix children of the current outlet)
                    // const nests = outletKey.split('/');
                    // this.outlet.outletKeys.filter((k) => k.split('/').length >= nests.length).forEach((key) => this.routeReuseStrategy.clearCache(key));
                    this.outlet.outletKeys.forEach((key) => this.routeReuseStrategy.clearMarkedCache(key));
                }
            });
            this.postNavFunction = wipeCache;
            const clearCallback = () => setTimeout(() => {
                wipeCache();
            });
            page.once(Page.navigatedToEvent, clearCallback);
        }
        else if (navOptions.replaceUrl) {
            this.outlet.outletKeys.forEach((key) => this.routeReuseStrategy.markCacheForPop(key));
            const popCache = callableOnce(() => {
                if (this.postNavFunction === popCache) {
                    this.postNavFunction = null;
                }
                if (this.outlet && this.activatedRoute === currentRoute) {
                    // potential alternative fix (only fix children of the current outlet)
                    // const nests = outletKey.split('/');
                    // this.outlet.outletKeys.filter((k) => k.split('/').length >= nests.length).forEach((key) => this.routeReuseStrategy.popCache(key));
                    this.outlet.outletKeys.forEach((key) => this.routeReuseStrategy.clearMarkedCache(key));
                }
            });
            this.postNavFunction = popCache;
            const clearCallback = () => setTimeout(() => {
                popCache();
            });
            page.once(Page.navigatedToEvent, clearCallback);
        }
        const navigationEntry = {
            create() {
                return page;
            },
            context: navigationContext,
            clearHistory: navOptions.clearHistory,
            animated: navOptions.animated,
            transition: navOptions.transition,
        };
        if (isReplace && this.frame.currentPage) {
            this.frame.replacePage(navigationEntry);
        }
        else {
            this.frame.navigate(navigationEntry);
        }
    }
    // Find and mark the top activated route as an activated one.
    // In ns-location-strategy we are reusing components only if their corresponing routes
    // are marked as activated from this method.
    markActivatedRoute(activatedRoute) {
        const queue = [];
        queue.push(activatedRoute.snapshot);
        let currentRoute = queue.shift();
        while (currentRoute) {
            currentRoute.children.forEach((childRoute) => {
                queue.push(childRoute);
            });
            const topActivatedRoute = findTopActivatedRouteNodeForOutlet(currentRoute);
            const outletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute);
            const outlet = this.locationStrategy.findOutlet(outletKey, topActivatedRoute);
            if (outlet && outlet.frames.length) {
                topActivatedRoute[pageRouterActivatedSymbol] = true;
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog('Activated route marked as page: ' + routeToString(topActivatedRoute));
                }
            }
            currentRoute = queue.shift();
        }
    }
    getComponentType(activatedRoute) {
        return activatedRoute.routeConfig.component || activatedRoute.component;
    }
    getOutlet(activatedRouteSnapshot) {
        const topActivatedRoute = findTopActivatedRouteNodeForOutlet(activatedRouteSnapshot);
        const outletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute);
        let outlet = this.locationStrategy.findOutlet(outletKey, topActivatedRoute);
        // Named lazy loaded outlet.
        if (!outlet && this.isEmptyOutlet) {
            const parentOutletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute.parent);
            outlet = this.locationStrategy.findOutlet(parentOutletKey, topActivatedRoute.parent);
            if (outlet) {
                outlet.outletKeys.push(outletKey);
            }
        }
        return outlet;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: PageRouterOutlet, deps: [{ token: i1.ChildrenOutletContexts }, { token: i0.ViewContainerRef }, { token: 'name', attribute: true }, { token: 'actionBarVisibility', attribute: true }, { token: 'isEmptyOutlet', attribute: true }, { token: i2.NSLocationStrategy }, { token: i0.ComponentFactoryResolver }, { token: i0.ComponentFactoryResolver }, { token: i0.ChangeDetectorRef }, { token: PAGE_FACTORY }, { token: i3.NSRouteReuseStrategy }, { token: i0.NgZone }, { token: i1.Router }, { token: i0.ElementRef }, { token: i4.ViewUtil }, { token: i0.EnvironmentInjector }], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.0.1", type: PageRouterOutlet, selector: "page-router-outlet", outputs: { activateEvents: "activate", deactivateEvents: "deactivate" }, ngImport: i0 }); }
}
__decorate([
    profile,
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [ActivatedRoute, Object]),
    __metadata("design:returntype", void 0)
], PageRouterOutlet.prototype, "activateWith", null);
__decorate([
    profile,
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Page, ComponentRef, Object]),
    __metadata("design:returntype", void 0)
], PageRouterOutlet.prototype, "loadComponentInPage", null);
export { PageRouterOutlet };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: PageRouterOutlet, decorators: [{
            type: Directive,
            args: [{ selector: 'page-router-outlet' }]
        }], ctorParameters: function () { return [{ type: i1.ChildrenOutletContexts }, { type: i0.ViewContainerRef }, { type: undefined, decorators: [{
                    type: Attribute,
                    args: ['name']
                }] }, { type: undefined, decorators: [{
                    type: Attribute,
                    args: ['actionBarVisibility']
                }] }, { type: undefined, decorators: [{
                    type: Attribute,
                    args: ['isEmptyOutlet']
                }] }, { type: i2.NSLocationStrategy }, { type: i0.ComponentFactoryResolver }, { type: i0.ComponentFactoryResolver }, { type: i0.ChangeDetectorRef }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PAGE_FACTORY]
                }] }, { type: i3.NSRouteReuseStrategy }, { type: i0.NgZone }, { type: i1.Router }, { type: i0.ElementRef }, { type: i4.ViewUtil }, { type: i0.EnvironmentInjector }]; }, propDecorators: { activateEvents: [{
                type: Output,
                args: ['activate']
            }], deactivateEvents: [{
                type: Output,
                args: ['deactivate']
            }], activateWith: [], loadComponentInPage: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnZS1yb3V0ZXItb3V0bGV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhci9zcmMvbGliL2xlZ2FjeS9yb3V0ZXIvcGFnZS1yb3V0ZXItb3V0bGV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFvQix3QkFBd0IsRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBa0IsUUFBUSxFQUFhLFlBQVksRUFBRSxNQUFNLEVBQVEsZ0JBQWdCLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsbUJBQW1CLEVBQXlCLE1BQU0sZUFBZSxDQUFDO0FBQzFTLE9BQU8sRUFBRSxjQUFjLEVBQTBCLHNCQUFzQixFQUFRLGNBQWMsRUFBRSxNQUFNLEVBQXdCLE1BQU0saUJBQWlCLENBQUM7QUFFckosT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQWlCLE9BQU8sRUFBbUIsTUFBTSxvQkFBb0IsQ0FBQztBQUUxRixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXZDLE9BQU8sRUFBRSxZQUFZLEVBQWUsTUFBTSxjQUFjLENBQUM7QUFDekQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ2hELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGlCQUFpQixFQUFVLE1BQU0scUJBQXFCLENBQUM7QUFDaEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakUsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLHlCQUF5QixFQUFFLGVBQWUsRUFBRSxt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QWlCLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFckYsSUFBSSxNQUFNLEVBQUU7Z0JBQ1YsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDbkM7U0FDRjtRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7OEdBcmRVLGdCQUFnQix3RkFvRWQsTUFBTSw4QkFDTixxQkFBcUIsOEJBQ3JCLGVBQWUsaUxBS2xCLFlBQVk7a0dBM0VYLGdCQUFnQjs7QUEwTzNCO0lBREMsT0FBTzs7cUNBQ3FCLGNBQWM7O29EQStCMUM7QUErQ087SUFEUCxPQUFPOztxQ0FDMEIsSUFBSSxFQUFnQixZQUFZOzsyREEyR2pFO1NBbmFVLGdCQUFnQjsyRkFBaEIsZ0JBQWdCO2tCQUQ1QixTQUFTO21CQUFDLEVBQUUsUUFBUSxFQUFFLG9CQUFvQixFQUFFOzswQkFxRXhDLFNBQVM7MkJBQUMsTUFBTTs7MEJBQ2hCLFNBQVM7MkJBQUMscUJBQXFCOzswQkFDL0IsU0FBUzsyQkFBQyxlQUFlOzswQkFLekIsTUFBTTsyQkFBQyxZQUFZOzJNQXZERixjQUFjO3NCQUFqQyxNQUFNO3VCQUFDLFVBQVU7Z0JBRUksZ0JBQWdCO3NCQUFyQyxNQUFNO3VCQUFDLFlBQVk7Z0JBb05wQixZQUFZLE1BOEVKLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEF0dHJpYnV0ZSwgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudEZhY3RvcnksIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBEaXJlY3RpdmUsIEluamVjdCwgSW5qZWN0aW9uVG9rZW4sIEluamVjdG9yLCBPbkRlc3Ryb3ksIEV2ZW50RW1pdHRlciwgT3V0cHV0LCBUeXBlLCBWaWV3Q29udGFpbmVyUmVmLCBFbGVtZW50UmVmLCBJbmplY3RGbGFncywgTmdab25lLCBFbnZpcm9ubWVudEluamVjdG9yLCBpbmplY3QsIEluamVjdE9wdGlvbnMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBDaGlsZHJlbk91dGxldENvbnRleHRzLCBEYXRhLCBQUklNQVJZX09VVExFVCwgUm91dGVyLCBSb3V0ZXJPdXRsZXRDb250cmFjdCB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5cbmltcG9ydCB7IEZyYW1lLCBQYWdlLCBOYXZpZ2F0ZWREYXRhLCBwcm9maWxlLCBOYXZpZ2F0aW9uRW50cnkgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgUEFHRV9GQUNUT1JZLCBQYWdlRmFjdG9yeSB9IGZyb20gJy4uLy4uL3Rva2Vucyc7XG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREZWJ1ZyB9IGZyb20gJy4uLy4uL3RyYWNlJztcbmltcG9ydCB7IERldGFjaGVkTG9hZGVyIH0gZnJvbSAnLi4vLi4vY2RrL2RldGFjaGVkLWxvYWRlcic7XG5pbXBvcnQgeyBWaWV3VXRpbCB9IGZyb20gJy4uLy4uL3ZpZXctdXRpbCc7XG5pbXBvcnQgeyBOU0xvY2F0aW9uU3RyYXRlZ3kgfSBmcm9tICcuL25zLWxvY2F0aW9uLXN0cmF0ZWd5JztcbmltcG9ydCB7IGRlZmF1bHROYXZPcHRpb25zLCBPdXRsZXQgfSBmcm9tICcuL25zLWxvY2F0aW9uLXV0aWxzJztcbmltcG9ydCB7IE5TUm91dGVSZXVzZVN0cmF0ZWd5IH0gZnJvbSAnLi9ucy1yb3V0ZS1yZXVzZS1zdHJhdGVneSc7XG5pbXBvcnQgeyBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0LCBwYWdlUm91dGVyQWN0aXZhdGVkU3ltYm9sLCBsb2FkZXJSZWZTeW1ib2wsIGRlc3Ryb3lDb21wb25lbnRSZWYgfSBmcm9tICcuL3BhZ2Utcm91dGVyLW91dGxldC11dGlscyc7XG5pbXBvcnQgeyByZWdpc3RlckVsZW1lbnQgfSBmcm9tICcuLi8uLi9lbGVtZW50LXJlZ2lzdHJ5JztcbmltcG9ydCB7IFBhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vY2RrL2ZyYW1lLXBhZ2UvcGFnZS5zZXJ2aWNlJztcbmltcG9ydCB7IEV4dGVuZGVkTmF2aWdhdGlvbkV4dHJhcyB9IGZyb20gJy4vcm91dGVyLWV4dGVuc2lvbnMnO1xuXG5leHBvcnQgY2xhc3MgUGFnZVJvdXRlIHtcbiAgYWN0aXZhdGVkUm91dGU6IEJlaGF2aW9yU3ViamVjdDxBY3RpdmF0ZWRSb3V0ZT47XG5cbiAgY29uc3RydWN0b3Ioc3RhcnRSb3V0ZTogQWN0aXZhdGVkUm91dGUpIHtcbiAgICB0aGlzLmFjdGl2YXRlZFJvdXRlID0gbmV3IEJlaGF2aW9yU3ViamVjdChzdGFydFJvdXRlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0NvbXBvbmVudEZhY3RvcnlSZXNvbHZlcihpdGVtOiBhbnkpOiBpdGVtIGlzIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciB7XG4gIHJldHVybiAhIWl0ZW0ucmVzb2x2ZUNvbXBvbmVudEZhY3Rvcnk7XG59XG5cbmZ1bmN0aW9uIGNhbGxhYmxlT25jZTxUPihmbjogKC4uLmFyZ3M6IFRbXSkgPT4gdm9pZCkge1xuICBsZXQgY2FsbGVkID0gZmFsc2U7XG4gIHJldHVybiAoLi4uYXJnczogVFtdKSA9PiB7XG4gICAgaWYgKGNhbGxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjYWxsZWQgPSB0cnVlO1xuICAgIHJldHVybiBmbiguLi5hcmdzKTtcbiAgfTtcbn1cblxuZXhwb3J0IGNsYXNzIERlc3RydWN0aWJsZUluamVjdG9yIGltcGxlbWVudHMgSW5qZWN0b3Ige1xuICBwcml2YXRlIHJlZnMgPSBuZXcgU2V0PGFueT4oKTtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkZXN0cnVjdGlibGVQcm92aWRlcnM6IFByb3ZpZGVyU2V0LCBwcml2YXRlIHBhcmVudDogSW5qZWN0b3IpIHt9XG4gIGdldDxUPih0b2tlbjogVHlwZTxUPiB8IEluamVjdGlvblRva2VuPFQ+LCBub3RGb3VuZFZhbHVlPzogVCwgZmxhZ3M/OiBJbmplY3RPcHRpb25zIHwgSW5qZWN0RmxhZ3MpOiBUIHtcbiAgICBjb25zdCByZWYgPSB0aGlzLnBhcmVudC5nZXQodG9rZW4sIG5vdEZvdW5kVmFsdWUsIGZsYWdzKTtcblxuICAgIC8vIGlmIHdlJ3JlIHNraXBwaW5nIG91cnNlbHZlcyB0aGVuIGl0J3Mgbm90IG91ciByZXNwb25zaWJpbGl0eSB0byBkZXN0cm95XG4gICAgaWYgKHR5cGVvZiBmbGFncyA9PT0gJ251bWJlcicpIHtcbiAgICAgIGlmICghKGZsYWdzICYgSW5qZWN0RmxhZ3MuU2tpcFNlbGYpICYmIHRoaXMuZGVzdHJ1Y3RpYmxlUHJvdmlkZXJzLmhhcyh0b2tlbikpIHtcbiAgICAgICAgdGhpcy5yZWZzLmFkZChyZWYpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIWZsYWdzPy5za2lwU2VsZiAmJiB0aGlzLmRlc3RydWN0aWJsZVByb3ZpZGVycy5oYXModG9rZW4pKSB7XG4gICAgICAgIHRoaXMucmVmcy5hZGQocmVmKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVmO1xuICB9XG4gIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5yZWZzLmZvckVhY2goKHJlZikgPT4ge1xuICAgICAgaWYgKHJlZi5uZ09uRGVzdHJveSBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7XG4gICAgICAgIHJlZi5uZ09uRGVzdHJveSgpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMucmVmcy5jbGVhcigpO1xuICB9XG59XG5cbnR5cGUgUHJvdmlkZXJTZXQgPSBTZXQ8VHlwZTxhbnk+IHwgSW5qZWN0aW9uVG9rZW48YW55Pj47XG5cbmNvbnN0IHJvdXRlVG9TdHJpbmcgPSBmdW5jdGlvbiAoYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlIHwgQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IHN0cmluZyB7XG4gIHJldHVybiBhY3RpdmF0ZWRSb3V0ZS5wYXRoRnJvbVJvb3Quam9pbignLT4nKTtcbn07XG5cbnJlZ2lzdGVyRWxlbWVudCgncGFnZS1yb3V0ZXItb3V0bGV0JywgKCkgPT4gRnJhbWUpO1xuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9kaXJlY3RpdmUtc2VsZWN0b3JcbkBEaXJlY3RpdmUoeyBzZWxlY3RvcjogJ3BhZ2Utcm91dGVyLW91dGxldCcgfSkgLy8gdHNsaW50OmRpc2FibGUtbGluZTpkaXJlY3RpdmUtc2VsZWN0b3JcbmV4cG9ydCBjbGFzcyBQYWdlUm91dGVyT3V0bGV0IGltcGxlbWVudHMgT25EZXN0cm95LCBSb3V0ZXJPdXRsZXRDb250cmFjdCB7XG4gIC8vIHRzbGludDpkaXNhYmxlLWxpbmU6ZGlyZWN0aXZlLWNsYXNzLXN1ZmZpeFxuICBwcml2YXRlIGFjdGl2YXRlZDogQ29tcG9uZW50UmVmPGFueT4gfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBfYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgZGV0YWNoZWRMb2FkZXJGYWN0b3J5OiBDb21wb25lbnRGYWN0b3J5PERldGFjaGVkTG9hZGVyPjtcblxuICBwcml2YXRlIG91dGxldDogT3V0bGV0O1xuICBwcml2YXRlIG5hbWU6IHN0cmluZztcbiAgcHJpdmF0ZSBpc0VtcHR5T3V0bGV0OiBib29sZWFuO1xuICBwcml2YXRlIHZpZXdVdGlsOiBWaWV3VXRpbDtcbiAgcHJpdmF0ZSBmcmFtZTogRnJhbWU7XG4gIC8vIHRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBjbGVhciB0aGUgb3V0bGV0IGNhY2hlIChjbGVhciBoaXN0b3J5KVxuICAvLyB1c3VhbGx5IGl0J3MgY2xlYXJlZCBpbiBgbmF2aWdhdGVkVG9gLCBidXQgb24gcXVpY2sgbmF2aWdhdGlvbiwgdGhlIGV2ZW50IHdpbGwgYmUgZmlyZWQgYWZ0ZXIgYW5ndWxhciBhbHJlYWR5IGFkZGVkIG1vcmUgdGhpbmdzIHRvIHRoZSBjYWNoZVxuICAvLyBzbyBub3cgd2UgY2FsbCB0aGlzIGlmIHRoZSBjb21wb25lbnQgaXMgZGV0YWNoZWQgb3IgZGVhY3RpdmF0ZWQgKG1lYW5pbmcgaXQncyBtaWQtbmF2aWdhdGlvbiwgYmVmb3JlIGNhY2hlIG1hbmlwdWxhdGlvbilcbiAgcHJpdmF0ZSBwb3N0TmF2RnVuY3Rpb246ICgpID0+IHZvaWQ7XG5cbiAgYXR0YWNoRXZlbnRzOiBFdmVudEVtaXR0ZXI8dW5rbm93bj4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIGRldGFjaEV2ZW50czogRXZlbnRFbWl0dGVyPHVua25vd24+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8tb3V0cHV0LXJlbmFtZVxuICBAT3V0cHV0KCdhY3RpdmF0ZScpIGFjdGl2YXRlRXZlbnRzID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7IC8vIHRzbGludDpkaXNhYmxlLWxpbmU6bm8tb3V0cHV0LXJlbmFtZVxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L25vLW91dHB1dC1yZW5hbWVcbiAgQE91dHB1dCgnZGVhY3RpdmF0ZScpIGRlYWN0aXZhdGVFdmVudHMgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTsgLy8gdHNsaW50OmRpc2FibGUtbGluZTpuby1vdXRwdXQtcmVuYW1lXG5cbiAgLyoqIEBkZXByZWNhdGVkIGZyb20gQW5ndWxhciBzaW5jZSB2NCAqL1xuICBnZXQgbG9jYXRpb25JbmplY3RvcigpOiBJbmplY3RvciB7XG4gICAgcmV0dXJuIHRoaXMubG9jYXRpb24uaW5qZWN0b3I7XG4gIH1cbiAgLyoqIEBkZXByZWNhdGVkIGZyb20gQW5ndWxhciBzaW5jZSB2NCAqL1xuICBnZXQgbG9jYXRpb25GYWN0b3J5UmVzb2x2ZXIoKTogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyIHtcbiAgICByZXR1cm4gdGhpcy5yZXNvbHZlcjtcbiAgfVxuXG4gIGdldCBpc0FjdGl2YXRlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISF0aGlzLmFjdGl2YXRlZDtcbiAgfVxuXG4gIGdldCBjb21wb25lbnQoKTogdW5rbm93biB7XG4gICAgaWYgKCF0aGlzLmFjdGl2YXRlZCkge1xuICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnT3V0bGV0IGlzIG5vdCBhY3RpdmF0ZWQnKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5hY3RpdmF0ZWQuaW5zdGFuY2U7XG4gIH1cbiAgZ2V0IGFjdGl2YXRlZFJvdXRlKCk6IEFjdGl2YXRlZFJvdXRlIHtcbiAgICBpZiAoIXRoaXMuYWN0aXZhdGVkKSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdPdXRsZXQgaXMgbm90IGFjdGl2YXRlZCcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9hY3RpdmF0ZWRSb3V0ZTtcbiAgfVxuXG4gIGdldCBhY3RpdmF0ZWRSb3V0ZURhdGEoKTogRGF0YSB7XG4gICAgaWYgKHRoaXMuX2FjdGl2YXRlZFJvdXRlKSB7XG4gICAgICByZXR1cm4gdGhpcy5fYWN0aXZhdGVkUm91dGUuc25hcHNob3QuZGF0YTtcbiAgICB9XG4gICAgcmV0dXJuIHt9O1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBwYXJlbnRDb250ZXh0czogQ2hpbGRyZW5PdXRsZXRDb250ZXh0cyxcbiAgICBwcml2YXRlIGxvY2F0aW9uOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgIEBBdHRyaWJ1dGUoJ25hbWUnKSBuYW1lOiBzdHJpbmcsXG4gICAgQEF0dHJpYnV0ZSgnYWN0aW9uQmFyVmlzaWJpbGl0eScpIGFjdGlvbkJhclZpc2liaWxpdHk6IHN0cmluZyxcbiAgICBAQXR0cmlidXRlKCdpc0VtcHR5T3V0bGV0JykgaXNFbXB0eU91dGxldDogYm9vbGVhbixcbiAgICBwcml2YXRlIGxvY2F0aW9uU3RyYXRlZ3k6IE5TTG9jYXRpb25TdHJhdGVneSxcbiAgICBwcml2YXRlIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIHByaXZhdGUgcmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBASW5qZWN0KFBBR0VfRkFDVE9SWSkgcHJpdmF0ZSBwYWdlRmFjdG9yeTogUGFnZUZhY3RvcnksXG4gICAgcHJpdmF0ZSByb3V0ZVJldXNlU3RyYXRlZ3k6IE5TUm91dGVSZXVzZVN0cmF0ZWd5LFxuICAgIHByaXZhdGUgbmdab25lOiBOZ1pvbmUsXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBlbFJlZjogRWxlbWVudFJlZixcbiAgICB2aWV3VXRpbDogVmlld1V0aWwsXG4gICAgcHJpdmF0ZSBlbnZpcm9ubWVudEluamVjdG9yOiBFbnZpcm9ubWVudEluamVjdG9yXG4gICkge1xuICAgIHRoaXMuaXNFbXB0eU91dGxldCA9IGlzRW1wdHlPdXRsZXQ7XG4gICAgdGhpcy5mcmFtZSA9IGVsUmVmLm5hdGl2ZUVsZW1lbnQ7XG4gICAgdGhpcy5zZXRBY3Rpb25CYXJWaXNpYmlsaXR5KGFjdGlvbkJhclZpc2liaWxpdHkpO1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmNvbnN0cnVjdG9yIGZyYW1lOiAke3RoaXMuZnJhbWV9YCk7XG4gICAgfVxuXG4gICAgdGhpcy5uYW1lID0gbmFtZSB8fCBQUklNQVJZX09VVExFVDtcbiAgICBwYXJlbnRDb250ZXh0cy5vbkNoaWxkT3V0bGV0Q3JlYXRlZCh0aGlzLm5hbWUsIDxhbnk+dGhpcyk7XG5cbiAgICB0aGlzLnZpZXdVdGlsID0gdmlld1V0aWw7XG4gICAgdGhpcy5kZXRhY2hlZExvYWRlckZhY3RvcnkgPSByZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShEZXRhY2hlZExvYWRlcik7XG4gIH1cblxuICBzZXRBY3Rpb25CYXJWaXNpYmlsaXR5KGFjdGlvbkJhclZpc2liaWxpdHk6IHN0cmluZyk6IHZvaWQge1xuICAgIHN3aXRjaCAoYWN0aW9uQmFyVmlzaWJpbGl0eSkge1xuICAgICAgY2FzZSAnYWx3YXlzJzpcbiAgICAgIGNhc2UgJ25ldmVyJzpcbiAgICAgICAgdGhpcy5mcmFtZS5hY3Rpb25CYXJWaXNpYmlsaXR5ID0gYWN0aW9uQmFyVmlzaWJpbGl0eTtcbiAgICAgICAgcmV0dXJuO1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aGlzLmZyYW1lLmFjdGlvbkJhclZpc2liaWxpdHkgPSAnYXV0byc7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgLy8gSW4gdGhlIGV2ZW50IHRoYXQgdGhlIGBwYXJlbnRDb250ZXh0c2AgaGFzIGNoYW5nZWQgdGhlIG91dGxldFxuICAgIC8vIHZpYSB0aGUgY3JlYXRpb24gb2YgYW5vdGhlciBvdXRsZXQsIHRoZSBgb25DaGlsZE91dGxldERlc3Ryb3llZGBcbiAgICAvLyB3aWxsIGJlIHNraXBwZWRcbiAgICBpZiAodGhpcy5wYXJlbnRDb250ZXh0cy5nZXRDb250ZXh0KHRoaXMubmFtZSk/Lm91dGxldCA9PT0gPGFueT50aGlzKSB7XG4gICAgICAvLyBDbGVhciBhY2N1bXVsYXRlZCBtb2RhbCB2aWV3IHBhZ2UgY2FjaGUgd2hlbiBwYWdlLXJvdXRlci1vdXRsZXRcbiAgICAgIC8vIGRlc3Ryb3llZCBvbiBtb2RhbCB2aWV3IGNsb3NpbmdcbiAgICAgIHRoaXMucGFyZW50Q29udGV4dHMub25DaGlsZE91dGxldERlc3Ryb3llZCh0aGlzLm5hbWUpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm91dGxldCkge1xuICAgICAgdGhpcy5vdXRsZXQub3V0bGV0S2V5cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgdGhpcy5yb3V0ZVJldXNlU3RyYXRlZ3kuY2xlYXJNb2RhbENhY2hlKGtleSk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMubG9jYXRpb25TdHJhdGVneS5jbGVhck91dGxldCh0aGlzLmZyYW1lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdQYWdlUm91dGVyT3V0bGV0Lm5nT25EZXN0cm95OiBubyBvdXRsZXQgYXZhaWxhYmxlIGZvciBwYWdlLXJvdXRlci1vdXRsZXQnKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc0FjdGl2YXRlZCkge1xuICAgICAgY29uc3QgYyA9IHRoaXMuYWN0aXZhdGVkLmluc3RhbmNlO1xuICAgICAgdGhpcy5hY3RpdmF0ZWQuaG9zdFZpZXcuZGV0YWNoKCk7XG4gICAgICBkZXN0cm95Q29tcG9uZW50UmVmKHRoaXMuYWN0aXZhdGVkKTtcblxuICAgICAgdGhpcy5kZWFjdGl2YXRlRXZlbnRzLmVtaXQoYyk7XG4gICAgICB0aGlzLmFjdGl2YXRlZCA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgZGVhY3RpdmF0ZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMub3V0bGV0IHx8ICF0aGlzLm91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjaykge1xuICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnQ3VycmVudGx5IG5vdCBpbiBwYWdlIGJhY2sgbmF2aWdhdGlvbiAtIGNvbXBvbmVudCBzaG91bGQgYmUgZGV0YWNoZWQgaW5zdGVhZCBvZiBkZWFjdGl2YXRlZC4nKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnUGFnZVJvdXRlck91dGxldC5kZWFjdGl2YXRlKCkgd2hpbGUgZ29pbmcgYmFjayAtIHNob3VsZCBkZXN0cm95Jyk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmlzQWN0aXZhdGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMucG9zdE5hdkZ1bmN0aW9uPy4oKTtcblxuICAgIGNvbnN0IGMgPSB0aGlzLmFjdGl2YXRlZC5pbnN0YW5jZTtcbiAgICBkZXN0cm95Q29tcG9uZW50UmVmKHRoaXMuYWN0aXZhdGVkKTtcblxuICAgIHRoaXMuYWN0aXZhdGVkID0gbnVsbDtcbiAgICB0aGlzLl9hY3RpdmF0ZWRSb3V0ZSA9IG51bGw7XG5cbiAgICB0aGlzLmRlYWN0aXZhdGVFdmVudHMuZW1pdChjKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxsZWQgd2hlbiB0aGUgYFJvdXRlUmV1c2VTdHJhdGVneWAgaW5zdHJ1Y3RzIHRvIGRldGFjaCB0aGUgc3VidHJlZVxuICAgKi9cbiAgZGV0YWNoKCk6IENvbXBvbmVudFJlZjxhbnk+IHtcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmF0ZWQpIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ091dGxldCBpcyBub3QgYWN0aXZhdGVkJyk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coYFBhZ2VSb3V0ZXJPdXRsZXQuZGV0YWNoKCkgLSAke3JvdXRlVG9TdHJpbmcodGhpcy5fYWN0aXZhdGVkUm91dGUpfWApO1xuICAgIH1cblxuICAgIHRoaXMucG9zdE5hdkZ1bmN0aW9uPy4oKTtcblxuICAgIC8vIERldGFjaCBmcm9tIENoYW5nZURldGVjdGlvblxuICAgIHRoaXMuYWN0aXZhdGVkLmhvc3RWaWV3LmRldGFjaCgpO1xuXG4gICAgY29uc3QgY29tcG9uZW50ID0gdGhpcy5hY3RpdmF0ZWQ7XG4gICAgdGhpcy5hY3RpdmF0ZWQgPSBudWxsO1xuICAgIHRoaXMuX2FjdGl2YXRlZFJvdXRlID0gbnVsbDtcbiAgICB0aGlzLmRldGFjaEV2ZW50cy5lbWl0KGNvbXBvbmVudC5pbnN0YW5jZSk7XG4gICAgcmV0dXJuIGNvbXBvbmVudDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxsZWQgd2hlbiB0aGUgYFJvdXRlUmV1c2VTdHJhdGVneWAgaW5zdHJ1Y3RzIHRvIHJlLWF0dGFjaCBhIHByZXZpb3VzbHkgZGV0YWNoZWQgc3VidHJlZVxuICAgKi9cbiAgYXR0YWNoKHJlZjogQ29tcG9uZW50UmVmPGFueT4sIGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSkge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmF0dGFjaCgpIC0gJHtyb3V0ZVRvU3RyaW5nKGFjdGl2YXRlZFJvdXRlKX1gKTtcbiAgICB9XG5cbiAgICB0aGlzLmFjdGl2YXRlZCA9IHJlZjtcblxuICAgIC8vIHJlYXR0YWNoIHRvIENoYW5nZURldGVjdGlvblxuICAgIHRoaXMuYWN0aXZhdGVkLmhvc3RWaWV3Lm1hcmtGb3JDaGVjaygpO1xuICAgIHRoaXMuYWN0aXZhdGVkLmhvc3RWaWV3LnJlYXR0YWNoKCk7XG4gICAgdGhpcy5fYWN0aXZhdGVkUm91dGUgPSBhY3RpdmF0ZWRSb3V0ZTtcbiAgICB0aGlzLm1hcmtBY3RpdmF0ZWRSb3V0ZShhY3RpdmF0ZWRSb3V0ZSk7XG5cbiAgICAvLyB3ZSBoYXZlIGEgY2hpbGQgd2l0aCB0aGUgc2FtZSBuYW1lLCBzbyB3ZSBkb24ndCBmaW5pc2ggdGhlIGJhY2sgbmF2XG4gICAgaWYgKHRoaXMuaXNGaW5hbFBhZ2VSb3V0ZXJPdXRsZXQoKSkge1xuICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5Ll9maW5pc2hCYWNrUGFnZU5hdmlnYXRpb24odGhpcy5mcmFtZSk7XG4gICAgfVxuICAgIHRoaXMuYXR0YWNoRXZlbnRzLmVtaXQocmVmLmluc3RhbmNlKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNGaW5hbFBhZ2VSb3V0ZXJPdXRsZXQoKSB7XG4gICAgbGV0IGNoaWxkcmVuID0gdGhpcy5wYXJlbnRDb250ZXh0cy5nZXRDb250ZXh0KHRoaXMubmFtZSk/LmNoaWxkcmVuO1xuICAgIHdoaWxlIChjaGlsZHJlbikge1xuICAgICAgY29uc3QgY2hpbGRDb250ZXh0ID0gY2hpbGRyZW4uZ2V0Q29udGV4dCh0aGlzLm5hbWUpO1xuICAgICAgaWYgKCFjaGlsZENvbnRleHQgfHwgIWNoaWxkQ29udGV4dC5vdXRsZXQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgICBpZiAoY2hpbGRDb250ZXh0Lm91dGxldCBpbnN0YW5jZW9mIFBhZ2VSb3V0ZXJPdXRsZXQpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgY2hpbGRyZW4gPSBjaGlsZENvbnRleHQuY2hpbGRyZW47XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGxlZCBieSB0aGUgUm91dGVyIHRvIGluc3RhbnRpYXRlIGEgbmV3IGNvbXBvbmVudCBkdXJpbmcgdGhlIGNvbW1pdCBwaGFzZSBvZiBhIG5hdmlnYXRpb24uXG4gICAqIFRoaXMgbWV0aG9kIGluIHR1cm4gaXMgcmVzcG9uc2libGUgZm9yIGNhbGxpbmcgdGhlIGByb3V0ZXJPbkFjdGl2YXRlYCBob29rIG9mIGl0cyBjaGlsZC5cbiAgICovXG4gIEBwcm9maWxlXG4gIGFjdGl2YXRlV2l0aChhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsIHJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgfCBFbnZpcm9ubWVudEluamVjdG9yIHwgbnVsbCk6IHZvaWQge1xuICAgIHRoaXMub3V0bGV0ID0gdGhpcy5vdXRsZXQgfHwgdGhpcy5nZXRPdXRsZXQoYWN0aXZhdGVkUm91dGUuc25hcHNob3QpO1xuICAgIGlmICghdGhpcy5vdXRsZXQpIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJFcnJvcignTm8gb3V0bGV0IGZvdW5kIHJlbGF0aXZlIHRvIGFjdGl2YXRlZCByb3V0ZScpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMub3V0bGV0LmlzTlNFbXB0eU91dGxldCA9IHRoaXMuaXNFbXB0eU91dGxldDtcbiAgICB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kudXBkYXRlT3V0bGV0RnJhbWUodGhpcy5vdXRsZXQsIHRoaXMuZnJhbWUsIHRoaXMuaXNFbXB0eU91dGxldCk7XG5cbiAgICBpZiAodGhpcy5vdXRsZXQgJiYgdGhpcy5vdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2spIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ0N1cnJlbnRseSBpbiBwYWdlIGJhY2sgbmF2aWdhdGlvbiAtIGNvbXBvbmVudCBzaG91bGQgYmUgcmVhdHRhY2hlZCBpbnN0ZWFkIG9mIGFjdGl2YXRlZC4nKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmlzRmluYWxQYWdlUm91dGVyT3V0bGV0KCkpIHtcbiAgICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5Ll9maW5pc2hCYWNrUGFnZU5hdmlnYXRpb24odGhpcy5mcmFtZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coYFBhZ2VSb3V0ZXJPdXRsZXQuYWN0aXZhdGVXaXRoKCkgLSAke3JvdXRlVG9TdHJpbmcoYWN0aXZhdGVkUm91dGUpfWApO1xuICAgIH1cblxuICAgIHRoaXMuX2FjdGl2YXRlZFJvdXRlID0gYWN0aXZhdGVkUm91dGU7XG5cbiAgICB0aGlzLm1hcmtBY3RpdmF0ZWRSb3V0ZShhY3RpdmF0ZWRSb3V0ZSk7XG5cbiAgICB0aGlzLmFjdGl2YXRlT25Hb0ZvcndhcmQoYWN0aXZhdGVkUm91dGUsIHJlc29sdmVyIHx8IHRoaXMuZW52aXJvbm1lbnRJbmplY3Rvcik7XG4gICAgdGhpcy5hY3RpdmF0ZUV2ZW50cy5lbWl0KHRoaXMuYWN0aXZhdGVkLmluc3RhbmNlKTtcbiAgfVxuXG4gIHByaXZhdGUgYWN0aXZhdGVPbkdvRm9yd2FyZChhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsIHJlc29sdmVyT3JJbmplY3RvcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyIHwgRW52aXJvbm1lbnRJbmplY3Rvcik6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdQYWdlUm91dGVyT3V0bGV0LmFjdGl2YXRlKCkgZm9yd2FyZCBuYXZpZ2F0aW9uIC0gJyArICdjcmVhdGUgZGV0YWNoZWQgbG9hZGVyIGluIHRoZSBsb2FkZXIgY29udGFpbmVyJyk7XG4gICAgfVxuXG4gICAgY29uc3QgY29tcG9uZW50ID0gdGhpcy5nZXRDb21wb25lbnRUeXBlKGFjdGl2YXRlZFJvdXRlKTtcbiAgICBjb25zdCBwYWdlID0gdGhpcy5wYWdlRmFjdG9yeSh7XG4gICAgICBpc05hdmlnYXRpb246IHRydWUsXG4gICAgICBjb21wb25lbnRUeXBlOiBjb21wb25lbnQsXG4gICAgfSk7XG4gICAgY29uc3QgbG9jYXRpb24gPSB0aGlzLmxvY2F0aW9uO1xuXG4gICAgY29uc3QgZGVzdHJ1Y3RpYmxlcyA9IG5ldyBTZXQoW1BhZ2VTZXJ2aWNlXSk7XG4gICAgY29uc3QgcGFyZW50SW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHsgcHJvdmlkZTogUGFnZSwgdXNlVmFsdWU6IHBhZ2UgfSxcbiAgICAgICAgeyBwcm92aWRlOiBGcmFtZSwgdXNlVmFsdWU6IHRoaXMuZnJhbWUgfSxcbiAgICAgICAgeyBwcm92aWRlOiBQYWdlUm91dGUsIHVzZVZhbHVlOiBuZXcgUGFnZVJvdXRlKGFjdGl2YXRlZFJvdXRlKSB9LFxuICAgICAgICB7IHByb3ZpZGU6IEFjdGl2YXRlZFJvdXRlLCB1c2VWYWx1ZTogYWN0aXZhdGVkUm91dGUgfSxcbiAgICAgICAgeyBwcm92aWRlOiBDaGlsZHJlbk91dGxldENvbnRleHRzLCB1c2VWYWx1ZTogdGhpcy5wYXJlbnRDb250ZXh0cy5nZXRPckNyZWF0ZUNvbnRleHQodGhpcy5uYW1lKS5jaGlsZHJlbiB9LFxuICAgICAgICB7IHByb3ZpZGU6IFBhZ2VTZXJ2aWNlLCB1c2VDbGFzczogUGFnZVNlcnZpY2UgfSxcbiAgICAgIF0sXG4gICAgICBwYXJlbnQ6IGxvY2F0aW9uLmluamVjdG9yLFxuICAgIH0pO1xuXG4gICAgY29uc3QgaW5qZWN0b3IgPSBuZXcgRGVzdHJ1Y3RpYmxlSW5qZWN0b3IoZGVzdHJ1Y3RpYmxlcywgcGFyZW50SW5qZWN0b3IpO1xuICAgIGxldCBsb2FkZXJSZWY6IENvbXBvbmVudFJlZjxEZXRhY2hlZExvYWRlcj47XG4gICAgaWYgKGlzQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKHJlc29sdmVyT3JJbmplY3RvcikpIHtcbiAgICAgIGNvbnN0IGZhY3RvcnkgPSByZXNvbHZlck9ySW5qZWN0b3IucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoRGV0YWNoZWRMb2FkZXIpO1xuICAgICAgbG9hZGVyUmVmID0gbG9jYXRpb24uY3JlYXRlQ29tcG9uZW50KGZhY3RvcnksIGxvY2F0aW9uLmxlbmd0aCwgaW5qZWN0b3IpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBlbnZpcm9ubWVudEluamVjdG9yID0gcmVzb2x2ZXJPckluamVjdG9yO1xuICAgICAgbG9hZGVyUmVmID0gbG9jYXRpb24uY3JlYXRlQ29tcG9uZW50KERldGFjaGVkTG9hZGVyLCB7IGluZGV4OiBsb2NhdGlvbi5sZW5ndGgsIGluamVjdG9yLCBlbnZpcm9ubWVudEluamVjdG9yIH0pO1xuICAgIH1cbiAgICBsb2FkZXJSZWYub25EZXN0cm95KCgpID0+IGluamVjdG9yLmRlc3Ryb3koKSk7XG4gICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5tYXJrRm9yQ2hlY2soKTtcblxuICAgIHRoaXMuYWN0aXZhdGVkID0gbG9hZGVyUmVmLmluc3RhbmNlLmxvYWRDb21wb25lbnRJbkxvY2F0aW9uKGNvbXBvbmVudCk7XG4gICAgdGhpcy5hY3RpdmF0ZWQuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIHRoaXMubG9hZENvbXBvbmVudEluUGFnZShwYWdlLCB0aGlzLmFjdGl2YXRlZCwgeyBhY3RpdmF0ZWRSb3V0ZSB9KTtcblxuICAgIHRoaXMuYWN0aXZhdGVkW2xvYWRlclJlZlN5bWJvbF0gPSBsb2FkZXJSZWY7XG4gIH1cblxuICBAcHJvZmlsZVxuICBwcml2YXRlIGxvYWRDb21wb25lbnRJblBhZ2UocGFnZTogUGFnZSwgY29tcG9uZW50UmVmOiBDb21wb25lbnRSZWY8YW55PiwgbmF2aWdhdGlvbkNvbnRleHQpOiB2b2lkIHtcbiAgICAvLyBDb21wb25lbnQgbG9hZGVkLiBGaW5kIGl0cyByb290IG5hdGl2ZSB2aWV3LlxuICAgIGNvbnN0IGNvbXBvbmVudFZpZXcgPSBjb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudDtcbiAgICAvLyBSZW1vdmUgaXQgZnJvbSBvcmlnaW5hbCBuYXRpdmUgcGFyZW50LlxuICAgIHRoaXMudmlld1V0aWwucmVtb3ZlQ2hpbGQoY29tcG9uZW50Vmlldy5wYXJlbnQsIGNvbXBvbmVudFZpZXcpO1xuICAgIC8vIEFkZCBpdCB0byB0aGUgbmV3IHBhZ2VcbiAgICB0aGlzLnZpZXdVdGlsLmFwcGVuZENoaWxkKHBhZ2UsIGNvbXBvbmVudFZpZXcpO1xuXG4gICAgbGV0IHRvcEFjdGl2YXRlZFJvdXRlID0gZmluZFRvcEFjdGl2YXRlZFJvdXRlTm9kZUZvck91dGxldCh0aGlzLl9hY3RpdmF0ZWRSb3V0ZS5zbmFwc2hvdCk7XG4gICAgbGV0IG91dGxldEtleSA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5nZXRSb3V0ZUZ1bGxQYXRoKHRvcEFjdGl2YXRlZFJvdXRlKTtcbiAgICBjb25zdCB0aGlzUm91dGVLZXkgPSBvdXRsZXRLZXk7XG4gICAgd2hpbGUgKCF0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuZmluZE91dGxldChvdXRsZXRLZXkpKSB7XG4gICAgICB0b3BBY3RpdmF0ZWRSb3V0ZSA9IHRvcEFjdGl2YXRlZFJvdXRlLnBhcmVudDtcbiAgICAgIGlmICghdG9wQWN0aXZhdGVkUm91dGUpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIG91dGxldCBmb3Igcm91dGU6ICcgKyB0aGlzUm91dGVLZXkpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIG91dGxldEtleSA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5nZXRSb3V0ZUZ1bGxQYXRoKHRvcEFjdGl2YXRlZFJvdXRlKTtcbiAgICB9XG5cbiAgICBjb25zdCBuYXZpZ2F0ZWRGcm9tQ2FsbGJhY2sgPSAoPGFueT5nbG9iYWwpLlpvbmUuY3VycmVudC53cmFwKChhcmdzOiBOYXZpZ2F0ZWREYXRhKSA9PiB7XG4gICAgICBpZiAoYXJncy5pc0JhY2tOYXZpZ2F0aW9uKSB7XG4gICAgICAgIHRoaXMubG9jYXRpb25TdHJhdGVneS5fYmVnaW5CYWNrUGFnZU5hdmlnYXRpb24odGhpcy5mcmFtZSwgb3V0bGV0S2V5KTtcbiAgICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmJhY2sobnVsbCwgdGhpcy5mcmFtZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgLy8gVE9ETzogZXhwZXJpbWVudCB3aXRoIHVzaW5nIE5nWm9uZSBpbnN0ZWFkIG9mIGdsb2JhbCBhYm92ZVxuICAgIC8vIGNvbnN0IG5hdmlnYXRlZEZyb21DYWxsYmFjayA9IChhcmdzOiBOYXZpZ2F0ZWREYXRhKSA9PiB7XG4gICAgLy8gXHRpZiAoYXJncy5pc0JhY2tOYXZpZ2F0aW9uKSB7XG4gICAgLy8gICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgLy8gICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5Ll9iZWdpbkJhY2tQYWdlTmF2aWdhdGlvbih0aGlzLmZyYW1lKTtcbiAgICAvLyAgICAgICB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuYmFjayhudWxsLCB0aGlzLmZyYW1lKTtcbiAgICAvLyAgICAgfSk7XG4gICAgLy8gXHR9XG4gICAgLy8gfTtcblxuICAgIHBhZ2Uub24oUGFnZS5uYXZpZ2F0ZWRGcm9tRXZlbnQsIG5hdmlnYXRlZEZyb21DYWxsYmFjayk7XG4gICAgY29tcG9uZW50UmVmLm9uRGVzdHJveSgoKSA9PiB7XG4gICAgICBpZiAocGFnZSkge1xuICAgICAgICBwYWdlLm9mZihQYWdlLm5hdmlnYXRlZEZyb21FdmVudCwgbmF2aWdhdGVkRnJvbUNhbGxiYWNrKTtcbiAgICAgICAgcGFnZSA9IG51bGw7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCBuYXZPcHRpb25zID0geyAuLi5kZWZhdWx0TmF2T3B0aW9ucywgLi4uKHRoaXMucm91dGVyLmdldEN1cnJlbnROYXZpZ2F0aW9uKCkuZXh0cmFzIHx8IHt9KSB9IGFzIEV4dGVuZGVkTmF2aWdhdGlvbkV4dHJhcztcbiAgICB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuX2JlZ2luUGFnZU5hdmlnYXRpb24odGhpcy5mcmFtZSwgbmF2T3B0aW9ucyk7XG4gICAgY29uc3QgaXNSZXBsYWNlID0gbmF2T3B0aW9ucy5yZXBsYWNlVXJsICYmICFuYXZPcHRpb25zLmNsZWFySGlzdG9yeTtcblxuICAgIGNvbnN0IGN1cnJlbnRSb3V0ZSA9IHRoaXMuYWN0aXZhdGVkUm91dGU7XG4gICAgLy8gQ2xlYXIgcmVmQ2FjaGUgaWYgbmF2aWdhdGlvbiB3aXRoIGNsZWFySGlzdG9yeVxuICAgIGlmIChuYXZPcHRpb25zLmNsZWFySGlzdG9yeSkge1xuICAgICAgdGhpcy5vdXRsZXQub3V0bGV0S2V5cy5mb3JFYWNoKChrZXkpID0+IHRoaXMucm91dGVSZXVzZVN0cmF0ZWd5Lm1hcmtDYWNoZUZvckNsZWFyKGtleSkpO1xuICAgICAgY29uc3Qgd2lwZUNhY2hlID0gY2FsbGFibGVPbmNlKCgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMucG9zdE5hdkZ1bmN0aW9uID09PSB3aXBlQ2FjaGUpIHtcbiAgICAgICAgICB0aGlzLnBvc3ROYXZGdW5jdGlvbiA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMub3V0bGV0ICYmIHRoaXMuYWN0aXZhdGVkUm91dGUgPT09IGN1cnJlbnRSb3V0ZSkge1xuICAgICAgICAgIC8vIHBvdGVudGlhbCBhbHRlcm5hdGl2ZSBmaXggKG9ubHkgZml4IGNoaWxkcmVuIG9mIHRoZSBjdXJyZW50IG91dGxldClcbiAgICAgICAgICAvLyBjb25zdCBuZXN0cyA9IG91dGxldEtleS5zcGxpdCgnLycpO1xuICAgICAgICAgIC8vIHRoaXMub3V0bGV0Lm91dGxldEtleXMuZmlsdGVyKChrKSA9PiBrLnNwbGl0KCcvJykubGVuZ3RoID49IG5lc3RzLmxlbmd0aCkuZm9yRWFjaCgoa2V5KSA9PiB0aGlzLnJvdXRlUmV1c2VTdHJhdGVneS5jbGVhckNhY2hlKGtleSkpO1xuICAgICAgICAgIHRoaXMub3V0bGV0Lm91dGxldEtleXMuZm9yRWFjaCgoa2V5KSA9PiB0aGlzLnJvdXRlUmV1c2VTdHJhdGVneS5jbGVhck1hcmtlZENhY2hlKGtleSkpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMucG9zdE5hdkZ1bmN0aW9uID0gd2lwZUNhY2hlO1xuICAgICAgY29uc3QgY2xlYXJDYWxsYmFjayA9ICgpID0+XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIHdpcGVDYWNoZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgcGFnZS5vbmNlKFBhZ2UubmF2aWdhdGVkVG9FdmVudCwgY2xlYXJDYWxsYmFjayk7XG4gICAgfSBlbHNlIGlmIChuYXZPcHRpb25zLnJlcGxhY2VVcmwpIHtcbiAgICAgIHRoaXMub3V0bGV0Lm91dGxldEtleXMuZm9yRWFjaCgoa2V5KSA9PiB0aGlzLnJvdXRlUmV1c2VTdHJhdGVneS5tYXJrQ2FjaGVGb3JQb3Aoa2V5KSk7XG4gICAgICBjb25zdCBwb3BDYWNoZSA9IGNhbGxhYmxlT25jZSgoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnBvc3ROYXZGdW5jdGlvbiA9PT0gcG9wQ2FjaGUpIHtcbiAgICAgICAgICB0aGlzLnBvc3ROYXZGdW5jdGlvbiA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMub3V0bGV0ICYmIHRoaXMuYWN0aXZhdGVkUm91dGUgPT09IGN1cnJlbnRSb3V0ZSkge1xuICAgICAgICAgIC8vIHBvdGVudGlhbCBhbHRlcm5hdGl2ZSBmaXggKG9ubHkgZml4IGNoaWxkcmVuIG9mIHRoZSBjdXJyZW50IG91dGxldClcbiAgICAgICAgICAvLyBjb25zdCBuZXN0cyA9IG91dGxldEtleS5zcGxpdCgnLycpO1xuICAgICAgICAgIC8vIHRoaXMub3V0bGV0Lm91dGxldEtleXMuZmlsdGVyKChrKSA9PiBrLnNwbGl0KCcvJykubGVuZ3RoID49IG5lc3RzLmxlbmd0aCkuZm9yRWFjaCgoa2V5KSA9PiB0aGlzLnJvdXRlUmV1c2VTdHJhdGVneS5wb3BDYWNoZShrZXkpKTtcbiAgICAgICAgICB0aGlzLm91dGxldC5vdXRsZXRLZXlzLmZvckVhY2goKGtleSkgPT4gdGhpcy5yb3V0ZVJldXNlU3RyYXRlZ3kuY2xlYXJNYXJrZWRDYWNoZShrZXkpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICB0aGlzLnBvc3ROYXZGdW5jdGlvbiA9IHBvcENhY2hlO1xuICAgICAgY29uc3QgY2xlYXJDYWxsYmFjayA9ICgpID0+XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIHBvcENhY2hlKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICBwYWdlLm9uY2UoUGFnZS5uYXZpZ2F0ZWRUb0V2ZW50LCBjbGVhckNhbGxiYWNrKTtcbiAgICB9XG5cbiAgICBjb25zdCBuYXZpZ2F0aW9uRW50cnk6IE5hdmlnYXRpb25FbnRyeSA9IHtcbiAgICAgIGNyZWF0ZSgpIHtcbiAgICAgICAgcmV0dXJuIHBhZ2U7XG4gICAgICB9LFxuICAgICAgY29udGV4dDogbmF2aWdhdGlvbkNvbnRleHQsXG4gICAgICBjbGVhckhpc3Rvcnk6IG5hdk9wdGlvbnMuY2xlYXJIaXN0b3J5LFxuICAgICAgYW5pbWF0ZWQ6IG5hdk9wdGlvbnMuYW5pbWF0ZWQsXG4gICAgICB0cmFuc2l0aW9uOiBuYXZPcHRpb25zLnRyYW5zaXRpb24sXG4gICAgfTtcblxuICAgIGlmIChpc1JlcGxhY2UgJiYgdGhpcy5mcmFtZS5jdXJyZW50UGFnZSkge1xuICAgICAgdGhpcy5mcmFtZS5yZXBsYWNlUGFnZShuYXZpZ2F0aW9uRW50cnkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmZyYW1lLm5hdmlnYXRlKG5hdmlnYXRpb25FbnRyeSk7XG4gICAgfVxuICB9XG5cbiAgLy8gRmluZCBhbmQgbWFyayB0aGUgdG9wIGFjdGl2YXRlZCByb3V0ZSBhcyBhbiBhY3RpdmF0ZWQgb25lLlxuICAvLyBJbiBucy1sb2NhdGlvbi1zdHJhdGVneSB3ZSBhcmUgcmV1c2luZyBjb21wb25lbnRzIG9ubHkgaWYgdGhlaXIgY29ycmVzcG9uaW5nIHJvdXRlc1xuICAvLyBhcmUgbWFya2VkIGFzIGFjdGl2YXRlZCBmcm9tIHRoaXMgbWV0aG9kLlxuICBwcml2YXRlIG1hcmtBY3RpdmF0ZWRSb3V0ZShhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUpIHtcbiAgICBjb25zdCBxdWV1ZSA9IFtdO1xuICAgIHF1ZXVlLnB1c2goYWN0aXZhdGVkUm91dGUuc25hcHNob3QpO1xuICAgIGxldCBjdXJyZW50Um91dGUgPSBxdWV1ZS5zaGlmdCgpO1xuXG4gICAgd2hpbGUgKGN1cnJlbnRSb3V0ZSkge1xuICAgICAgY3VycmVudFJvdXRlLmNoaWxkcmVuLmZvckVhY2goKGNoaWxkUm91dGUpID0+IHtcbiAgICAgICAgcXVldWUucHVzaChjaGlsZFJvdXRlKTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB0b3BBY3RpdmF0ZWRSb3V0ZSA9IGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQoY3VycmVudFJvdXRlKTtcbiAgICAgIGNvbnN0IG91dGxldEtleSA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5nZXRSb3V0ZUZ1bGxQYXRoKHRvcEFjdGl2YXRlZFJvdXRlKTtcbiAgICAgIGNvbnN0IG91dGxldCA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5maW5kT3V0bGV0KG91dGxldEtleSwgdG9wQWN0aXZhdGVkUm91dGUpO1xuXG4gICAgICBpZiAob3V0bGV0ICYmIG91dGxldC5mcmFtZXMubGVuZ3RoKSB7XG4gICAgICAgIHRvcEFjdGl2YXRlZFJvdXRlW3BhZ2VSb3V0ZXJBY3RpdmF0ZWRTeW1ib2xdID0gdHJ1ZTtcbiAgICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdBY3RpdmF0ZWQgcm91dGUgbWFya2VkIGFzIHBhZ2U6ICcgKyByb3V0ZVRvU3RyaW5nKHRvcEFjdGl2YXRlZFJvdXRlKSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY3VycmVudFJvdXRlID0gcXVldWUuc2hpZnQoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldENvbXBvbmVudFR5cGUoYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlKTogVHlwZTxhbnk+IHtcbiAgICByZXR1cm4gYWN0aXZhdGVkUm91dGUucm91dGVDb25maWcuY29tcG9uZW50IHx8IGFjdGl2YXRlZFJvdXRlLmNvbXBvbmVudDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0T3V0bGV0KGFjdGl2YXRlZFJvdXRlU25hcHNob3Q6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBPdXRsZXQge1xuICAgIGNvbnN0IHRvcEFjdGl2YXRlZFJvdXRlID0gZmluZFRvcEFjdGl2YXRlZFJvdXRlTm9kZUZvck91dGxldChhY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTtcbiAgICBjb25zdCBvdXRsZXRLZXkgPSB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuZ2V0Um91dGVGdWxsUGF0aCh0b3BBY3RpdmF0ZWRSb3V0ZSk7XG4gICAgbGV0IG91dGxldCA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5maW5kT3V0bGV0KG91dGxldEtleSwgdG9wQWN0aXZhdGVkUm91dGUpO1xuXG4gICAgLy8gTmFtZWQgbGF6eSBsb2FkZWQgb3V0bGV0LlxuICAgIGlmICghb3V0bGV0ICYmIHRoaXMuaXNFbXB0eU91dGxldCkge1xuICAgICAgY29uc3QgcGFyZW50T3V0bGV0S2V5ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmdldFJvdXRlRnVsbFBhdGgodG9wQWN0aXZhdGVkUm91dGUucGFyZW50KTtcbiAgICAgIG91dGxldCA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5maW5kT3V0bGV0KHBhcmVudE91dGxldEtleSwgdG9wQWN0aXZhdGVkUm91dGUucGFyZW50KTtcblxuICAgICAgaWYgKG91dGxldCkge1xuICAgICAgICBvdXRsZXQub3V0bGV0S2V5cy5wdXNoKG91dGxldEtleSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG91dGxldDtcbiAgfVxufVxuIl19