import { Injectable } from '@angular/core';
import { NativeScriptDebug } from '../../trace';
import { NSLocationStrategy } from './ns-location-strategy';
import { destroyComponentRef, findTopActivatedRouteNodeForOutlet, pageRouterActivatedSymbol } from './page-router-outlet-utils';
import * as i0 from "@angular/core";
import * as i1 from "./ns-location-strategy";
const getSnapshotKey = function (snapshot) {
    return snapshot.pathFromRoot.join('->');
};
/**
 * Detached state cache
 */
class DetachedStateCache {
    constructor() {
        this.cache = new Array();
    }
    get length() {
        return this.cache.length;
    }
    push(cacheItem) {
        this.cache.push(cacheItem);
    }
    pop() {
        return this.cache.pop();
    }
    peek() {
        return this.cache[this.cache.length - 1];
    }
    clear() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`DetachedStateCache.clear() ${this.cache.length} items will be destroyed`);
        }
        while (this.cache.length > 0) {
            const state = this.cache.pop().state;
            if (!state.componentRef) {
                throw new Error('No componentRef found in DetachedRouteHandle');
            }
            destroyComponentRef(state.componentRef);
        }
    }
    markCurrentForClear() {
        for (const item of this.cache) {
            item.markedForDeletion = true;
        }
    }
    clearMarked() {
        // try to preserve same order as .clear()
        for (let i = this.cache.length - 1; i >= 0; i--) {
            const cacheItem = this.cache[i];
            if (cacheItem.markedForDeletion) {
                const state = cacheItem.state;
                if (!state.componentRef) {
                    throw new Error('No componentRef found in DetachedRouteHandle');
                }
                destroyComponentRef(state.componentRef);
                this.cache.splice(i, 1);
            }
        }
    }
    clearModalCache() {
        let removedItemsCount = 0;
        const hasModalPages = this.cache.some((cacheItem) => {
            return cacheItem.isModal;
        });
        if (hasModalPages) {
            let modalCacheCleared = false;
            while (!modalCacheCleared) {
                const cacheItem = this.peek();
                const state = cacheItem.state;
                if (!state.componentRef) {
                    throw new Error('No componentRef found in DetachedRouteHandle');
                }
                destroyComponentRef(state.componentRef);
                if (cacheItem.isModal) {
                    modalCacheCleared = true;
                }
                this.pop();
                removedItemsCount++;
            }
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`DetachedStateCache.clearModalCache() ${removedItemsCount} items will be destroyed`);
        }
    }
}
/**
 * Detaches subtrees loaded inside PageRouterOutlet in forward navigation
 * and reattaches them on back.
 * Reuses routes as long as their route config is the same.
 */
class NSRouteReuseStrategy {
    constructor(location) {
        this.location = location;
        this.cacheByOutlet = {};
    }
    shouldDetach(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const { outlet } = this.findValidOutletAndKey(route);
        const key = getSnapshotKey(route);
        let isPageActivated = false;
        let tmp = route;
        while (!(isPageActivated = tmp[pageRouterActivatedSymbol]) && tmp.parent) {
            tmp = tmp.parent;
        }
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        let shouldDetach = outlet && !isBack && isPageActivated;
        if (outlet) {
            if (outlet.parent && !outlet.parent.shouldDetach) {
                shouldDetach = false;
            }
            outlet.shouldDetach = shouldDetach;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldDetach isBack: ${isBack} key: ${key} result: ${shouldDetach}`);
        }
        return shouldDetach;
    }
    findValidOutletAndKey(targetRoute) {
        let route = targetRoute;
        const routeOutletKey = this.location.getRouteFullPath(route);
        let outletKey = routeOutletKey;
        let outlet = this.location.findOutlet(outletKey, route);
        while (!outlet) {
            if (!route.parent) {
                return { outlet: null, outletKey: routeOutletKey };
            }
            route = route.parent;
            outletKey = this.location.getRouteFullPath(route);
            outlet = this.location.findOutlet(outletKey, route);
        }
        if (outlet) {
            while (!outlet.outletKeys.includes(outletKey)) {
                if (!route.parent) {
                    NativeScriptDebug.routeReuseStrategyLog(`Could not find valid outlet key for route: ${targetRoute}.`);
                    return { outlet, outletKey: routeOutletKey };
                }
                route = route.parent;
                outletKey = this.location.getRouteFullPath(route);
            }
        }
        return { outlet, outletKey };
    }
    shouldAttach(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const { outlet, outletKey } = this.findValidOutletAndKey(route);
        const cache = this.cacheByOutlet[outletKey];
        if (!cache) {
            return false;
        }
        const key = getSnapshotKey(route);
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        const shouldAttach = isBack && cache.peek()?.key === key;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldAttach isBack: ${isBack} key: ${key} result: ${shouldAttach}`);
        }
        if (outlet) {
            outlet.shouldDetach = true;
        }
        return shouldAttach;
    }
    store(route, state) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const key = getSnapshotKey(route);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`store key: ${key}, state: ${state}`);
        }
        const { outletKey } = this.findValidOutletAndKey(route);
        // tslint:disable-next-line:max-line-length
        const cache = (this.cacheByOutlet[outletKey] = this.cacheByOutlet[outletKey] || new DetachedStateCache());
        if (state) {
            let isModal = false;
            if (this.location._modalNavigationDepth > 0) {
                isModal = true;
            }
            cache.push({ key, state, isModal });
        }
        else {
            const topItem = cache.peek();
            if (topItem.key === key) {
                cache.pop();
                if (!cache.length) {
                    delete this.cacheByOutlet[outletKey];
                }
            }
            else {
                throw new Error("Trying to pop from DetachedStateCache but keys don't match. " + `expected: ${topItem.key} actual: ${key}`);
            }
        }
    }
    retrieve(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const { outlet, outletKey } = this.findValidOutletAndKey(route);
        const cache = this.cacheByOutlet[outletKey];
        if (!cache) {
            return null;
        }
        const key = getSnapshotKey(route);
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        const cachedItem = cache.peek();
        let state = null;
        if (isBack && cachedItem && cachedItem.key === key) {
            state = cachedItem.state;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`retrieved isBack: ${isBack} key: ${key} state: ${state}`);
        }
        return state;
    }
    shouldReuseRoute(future, curr) {
        const shouldReuse = future.routeConfig === curr.routeConfig;
        if (shouldReuse && curr && curr[pageRouterActivatedSymbol]) {
            // When reusing route - copy the pageRouterActivated to the new snapshot
            // It's needed in shouldDetach to determine if the route should be detached.
            future[pageRouterActivatedSymbol] = curr[pageRouterActivatedSymbol];
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldReuseRoute result: ${shouldReuse}`);
        }
        return shouldReuse;
    }
    clearCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clear();
        }
    }
    markCacheForClear(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.markCurrentForClear();
        }
    }
    popCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            if (cache.peek()) {
                const state = cache.pop()?.state;
                if (state?.componentRef) {
                    destroyComponentRef(state?.componentRef);
                }
            }
        }
    }
    markCacheForPop(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            const item = cache.peek();
            if (item) {
                item.markedForDeletion = true;
            }
        }
    }
    clearMarkedCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clearMarked();
        }
    }
    clearModalCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clearModalCache();
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: NSRouteReuseStrategy, deps: [{ token: i1.NSLocationStrategy }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: NSRouteReuseStrategy }); }
}
export { NSRouteReuseStrategy };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: NSRouteReuseStrategy, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.NSLocationStrategy }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnMtcm91dGUtcmV1c2Utc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvbGVnYWN5L3JvdXRlci9ucy1yb3V0ZS1yZXVzZS1zdHJhdGVneS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzNDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNoRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsa0NBQWtDLEVBQUUseUJBQXlCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQzs7O0FBU2hJLE1BQU0sY0FBYyxHQUFHLFVBQVUsUUFBZ0M7SUFDL0QsT0FBTyxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMxQyxDQUFDLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQU0sa0JBQWtCO0lBQXhCO1FBQ1UsVUFBSyxHQUFHLElBQUksS0FBSyxFQUFhLENBQUM7SUFzRnpDLENBQUM7SUFwRkMsSUFBVyxNQUFNO1FBQ2YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztJQUMzQixDQUFDO0lBRU0sSUFBSSxDQUFDLFNBQW9CO1FBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFTSxHQUFHO1FBQ1IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFTSxJQUFJO1FBQ1QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFFTSxLQUFLO1FBQ1Ys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SUFDSCxDQUFDO0lBRUQsZUFBZSxDQUFDLFNBQWlCO1FBQy9CLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFNUMsSUFBSSxLQUFLLEVBQUU7WUFDVCxLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7U0FDekI7SUFDSCxDQUFDOzhHQXROVSxvQkFBb0I7a0hBQXBCLG9CQUFvQjs7U0FBcEIsb0JBQW9COzJGQUFwQixvQkFBb0I7a0JBRGhDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZVJldXNlU3RyYXRlZ3ksIEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIERldGFjaGVkUm91dGVIYW5kbGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuXG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREZWJ1ZyB9IGZyb20gJy4uLy4uL3RyYWNlJztcbmltcG9ydCB7IE5TTG9jYXRpb25TdHJhdGVneSB9IGZyb20gJy4vbnMtbG9jYXRpb24tc3RyYXRlZ3knO1xuaW1wb3J0IHsgZGVzdHJveUNvbXBvbmVudFJlZiwgZmluZFRvcEFjdGl2YXRlZFJvdXRlTm9kZUZvck91dGxldCwgcGFnZVJvdXRlckFjdGl2YXRlZFN5bWJvbCB9IGZyb20gJy4vcGFnZS1yb3V0ZXItb3V0bGV0LXV0aWxzJztcblxuaW50ZXJmYWNlIENhY2hlSXRlbSB7XG4gIGtleTogc3RyaW5nO1xuICBzdGF0ZTogRGV0YWNoZWRSb3V0ZUhhbmRsZTtcbiAgaXNNb2RhbDogYm9vbGVhbjtcbiAgbWFya2VkRm9yRGVsZXRpb24/OiBib29sZWFuO1xufVxuXG5jb25zdCBnZXRTbmFwc2hvdEtleSA9IGZ1bmN0aW9uIChzbmFwc2hvdDogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IHN0cmluZyB7XG4gIHJldHVybiBzbmFwc2hvdC5wYXRoRnJvbVJvb3Quam9pbignLT4nKTtcbn07XG5cbi8qKlxuICogRGV0YWNoZWQgc3RhdGUgY2FjaGVcbiAqL1xuY2xhc3MgRGV0YWNoZWRTdGF0ZUNhY2hlIHtcbiAgcHJpdmF0ZSBjYWNoZSA9IG5ldyBBcnJheTxDYWNoZUl0ZW0+KCk7XG5cbiAgcHVibGljIGdldCBsZW5ndGgoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZS5sZW5ndGg7XG4gIH1cblxuICBwdWJsaWMgcHVzaChjYWNoZUl0ZW06IENhY2hlSXRlbSkge1xuICAgIHRoaXMuY2FjaGUucHVzaChjYWNoZUl0ZW0pO1xuICB9XG5cbiAgcHVibGljIHBvcCgpOiBDYWNoZUl0ZW0ge1xuICAgIHJldHVybiB0aGlzLmNhY2hlLnBvcCgpO1xuICB9XG5cbiAgcHVibGljIHBlZWsoKTogQ2FjaGVJdGVtIHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZVt0aGlzLmNhY2hlLmxlbmd0aCAtIDFdO1xuICB9XG5cbiAgcHVibGljIGNsZWFyKCkge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBEZXRhY2hlZFN0YXRlQ2FjaGUuY2xlYXIoKSAke3RoaXMuY2FjaGUubGVuZ3RofSBpdGVtcyB3aWxsIGJlIGRlc3Ryb3llZGApO1xuICAgIH1cblxuICAgIHdoaWxlICh0aGlzLmNhY2hlLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHN0YXRlID0gPGFueT50aGlzLmNhY2hlLnBvcCgpLnN0YXRlO1xuICAgICAgaWYgKCFzdGF0ZS5jb21wb25lbnRSZWYpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBjb21wb25lbnRSZWYgZm91bmQgaW4gRGV0YWNoZWRSb3V0ZUhhbmRsZScpO1xuICAgICAgfVxuXG4gICAgICBkZXN0cm95Q29tcG9uZW50UmVmKHN0YXRlLmNvbXBvbmVudFJlZik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIG1hcmtDdXJyZW50Rm9yQ2xlYXIoKSB7XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIHRoaXMuY2FjaGUpIHtcbiAgICAgIGl0ZW0ubWFya2VkRm9yRGVsZXRpb24gPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjbGVhck1hcmtlZCgpIHtcbiAgICAvLyB0cnkgdG8gcHJlc2VydmUgc2FtZSBvcmRlciBhcyAuY2xlYXIoKVxuICAgIGZvciAobGV0IGkgPSB0aGlzLmNhY2hlLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBjb25zdCBjYWNoZUl0ZW0gPSB0aGlzLmNhY2hlW2ldO1xuICAgICAgaWYgKGNhY2hlSXRlbS5tYXJrZWRGb3JEZWxldGlvbikge1xuICAgICAgICBjb25zdCBzdGF0ZSA9IDxhbnk+Y2FjaGVJdGVtLnN0YXRlO1xuICAgICAgICBpZiAoIXN0YXRlLmNvbXBvbmVudFJlZikge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gY29tcG9uZW50UmVmIGZvdW5kIGluIERldGFjaGVkUm91dGVIYW5kbGUnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlc3Ryb3lDb21wb25lbnRSZWYoc3RhdGUuY29tcG9uZW50UmVmKTtcbiAgICAgICAgdGhpcy5jYWNoZS5zcGxpY2UoaSwgMSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNsZWFyTW9kYWxDYWNoZSgpIHtcbiAgICBsZXQgcmVtb3ZlZEl0ZW1zQ291bnQgPSAwO1xuICAgIGNvbnN0IGhhc01vZGFsUGFnZXMgPSB0aGlzLmNhY2hlLnNvbWUoKGNhY2hlSXRlbSkgPT4ge1xuICAgICAgcmV0dXJuIGNhY2hlSXRlbS5pc01vZGFsO1xuICAgIH0pO1xuXG4gICAgaWYgKGhhc01vZGFsUGFnZXMpIHtcbiAgICAgIGxldCBtb2RhbENhY2hlQ2xlYXJlZCA9IGZhbHNlO1xuXG4gICAgICB3aGlsZSAoIW1vZGFsQ2FjaGVDbGVhcmVkKSB7XG4gICAgICAgIGNvbnN0IGNhY2hlSXRlbSA9IHRoaXMucGVlaygpO1xuICAgICAgICBjb25zdCBzdGF0ZSA9IDxhbnk+Y2FjaGVJdGVtLnN0YXRlO1xuXG4gICAgICAgIGlmICghc3RhdGUuY29tcG9uZW50UmVmKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBjb21wb25lbnRSZWYgZm91bmQgaW4gRGV0YWNoZWRSb3V0ZUhhbmRsZScpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVzdHJveUNvbXBvbmVudFJlZihzdGF0ZS5jb21wb25lbnRSZWYpO1xuICAgICAgICBpZiAoY2FjaGVJdGVtLmlzTW9kYWwpIHtcbiAgICAgICAgICBtb2RhbENhY2hlQ2xlYXJlZCA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnBvcCgpO1xuICAgICAgICByZW1vdmVkSXRlbXNDb3VudCsrO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBEZXRhY2hlZFN0YXRlQ2FjaGUuY2xlYXJNb2RhbENhY2hlKCkgJHtyZW1vdmVkSXRlbXNDb3VudH0gaXRlbXMgd2lsbCBiZSBkZXN0cm95ZWRgKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBEZXRhY2hlcyBzdWJ0cmVlcyBsb2FkZWQgaW5zaWRlIFBhZ2VSb3V0ZXJPdXRsZXQgaW4gZm9yd2FyZCBuYXZpZ2F0aW9uXG4gKiBhbmQgcmVhdHRhY2hlcyB0aGVtIG9uIGJhY2suXG4gKiBSZXVzZXMgcm91dGVzIGFzIGxvbmcgYXMgdGhlaXIgcm91dGUgY29uZmlnIGlzIHRoZSBzYW1lLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTlNSb3V0ZVJldXNlU3RyYXRlZ3kgaW1wbGVtZW50cyBSb3V0ZVJldXNlU3RyYXRlZ3kge1xuICBwcml2YXRlIGNhY2hlQnlPdXRsZXQ6IHsgW2tleTogc3RyaW5nXTogRGV0YWNoZWRTdGF0ZUNhY2hlIH0gPSB7fTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxvY2F0aW9uOiBOU0xvY2F0aW9uU3RyYXRlZ3kpIHt9XG5cbiAgc2hvdWxkRGV0YWNoKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG4gICAgcm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KHJvdXRlKTtcblxuICAgIGNvbnN0IHsgb3V0bGV0IH0gPSB0aGlzLmZpbmRWYWxpZE91dGxldEFuZEtleShyb3V0ZSk7XG4gICAgY29uc3Qga2V5ID0gZ2V0U25hcHNob3RLZXkocm91dGUpO1xuXG4gICAgbGV0IGlzUGFnZUFjdGl2YXRlZCA9IGZhbHNlO1xuICAgIGxldCB0bXAgPSByb3V0ZTtcbiAgICB3aGlsZSAoIShpc1BhZ2VBY3RpdmF0ZWQgPSB0bXBbcGFnZVJvdXRlckFjdGl2YXRlZFN5bWJvbF0pICYmIHRtcC5wYXJlbnQpIHtcbiAgICAgIHRtcCA9IHRtcC5wYXJlbnQ7XG4gICAgfVxuICAgIGNvbnN0IGlzQmFjayA9IG91dGxldCA/IG91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjayA6IGZhbHNlO1xuICAgIGxldCBzaG91bGREZXRhY2ggPSBvdXRsZXQgJiYgIWlzQmFjayAmJiBpc1BhZ2VBY3RpdmF0ZWQ7XG5cbiAgICBpZiAob3V0bGV0KSB7XG4gICAgICBpZiAob3V0bGV0LnBhcmVudCAmJiAhb3V0bGV0LnBhcmVudC5zaG91bGREZXRhY2gpIHtcbiAgICAgICAgc2hvdWxkRGV0YWNoID0gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIG91dGxldC5zaG91bGREZXRhY2ggPSBzaG91bGREZXRhY2g7XG4gICAgfVxuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYHNob3VsZERldGFjaCBpc0JhY2s6ICR7aXNCYWNrfSBrZXk6ICR7a2V5fSByZXN1bHQ6ICR7c2hvdWxkRGV0YWNofWApO1xuICAgIH1cblxuICAgIHJldHVybiBzaG91bGREZXRhY2g7XG4gIH1cbiAgcHJvdGVjdGVkIGZpbmRWYWxpZE91dGxldEFuZEtleSh0YXJnZXRSb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCkge1xuICAgIGxldCByb3V0ZSA9IHRhcmdldFJvdXRlO1xuICAgIGNvbnN0IHJvdXRlT3V0bGV0S2V5ID0gdGhpcy5sb2NhdGlvbi5nZXRSb3V0ZUZ1bGxQYXRoKHJvdXRlKTtcbiAgICBsZXQgb3V0bGV0S2V5ID0gcm91dGVPdXRsZXRLZXk7XG4gICAgbGV0IG91dGxldCA9IHRoaXMubG9jYXRpb24uZmluZE91dGxldChvdXRsZXRLZXksIHJvdXRlKTtcbiAgICB3aGlsZSAoIW91dGxldCkge1xuICAgICAgaWYgKCFyb3V0ZS5wYXJlbnQpIHtcbiAgICAgICAgcmV0dXJuIHsgb3V0bGV0OiBudWxsLCBvdXRsZXRLZXk6IHJvdXRlT3V0bGV0S2V5IH07XG4gICAgICB9XG4gICAgICByb3V0ZSA9IHJvdXRlLnBhcmVudDtcbiAgICAgIG91dGxldEtleSA9IHRoaXMubG9jYXRpb24uZ2V0Um91dGVGdWxsUGF0aChyb3V0ZSk7XG4gICAgICBvdXRsZXQgPSB0aGlzLmxvY2F0aW9uLmZpbmRPdXRsZXQob3V0bGV0S2V5LCByb3V0ZSk7XG4gICAgfVxuXG4gICAgaWYgKG91dGxldCkge1xuICAgICAgd2hpbGUgKCFvdXRsZXQub3V0bGV0S2V5cy5pbmNsdWRlcyhvdXRsZXRLZXkpKSB7XG4gICAgICAgIGlmICghcm91dGUucGFyZW50KSB7XG4gICAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBDb3VsZCBub3QgZmluZCB2YWxpZCBvdXRsZXQga2V5IGZvciByb3V0ZTogJHt0YXJnZXRSb3V0ZX0uYCk7XG4gICAgICAgICAgcmV0dXJuIHsgb3V0bGV0LCBvdXRsZXRLZXk6IHJvdXRlT3V0bGV0S2V5IH07XG4gICAgICAgIH1cbiAgICAgICAgcm91dGUgPSByb3V0ZS5wYXJlbnQ7XG4gICAgICAgIG91dGxldEtleSA9IHRoaXMubG9jYXRpb24uZ2V0Um91dGVGdWxsUGF0aChyb3V0ZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgb3V0bGV0LCBvdXRsZXRLZXkgfTtcbiAgfVxuXG4gIHNob3VsZEF0dGFjaChyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IGJvb2xlYW4ge1xuICAgIHJvdXRlID0gZmluZFRvcEFjdGl2YXRlZFJvdXRlTm9kZUZvck91dGxldChyb3V0ZSk7XG5cbiAgICBjb25zdCB7IG91dGxldCwgb3V0bGV0S2V5IH0gPSB0aGlzLmZpbmRWYWxpZE91dGxldEFuZEtleShyb3V0ZSk7XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XTtcbiAgICBpZiAoIWNhY2hlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3Qga2V5ID0gZ2V0U25hcHNob3RLZXkocm91dGUpO1xuICAgIGNvbnN0IGlzQmFjayA9IG91dGxldCA/IG91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjayA6IGZhbHNlO1xuICAgIGNvbnN0IHNob3VsZEF0dGFjaCA9IGlzQmFjayAmJiBjYWNoZS5wZWVrKCk/LmtleSA9PT0ga2V5O1xuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYHNob3VsZEF0dGFjaCBpc0JhY2s6ICR7aXNCYWNrfSBrZXk6ICR7a2V5fSByZXN1bHQ6ICR7c2hvdWxkQXR0YWNofWApO1xuICAgIH1cblxuICAgIGlmIChvdXRsZXQpIHtcbiAgICAgIG91dGxldC5zaG91bGREZXRhY2ggPSB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiBzaG91bGRBdHRhY2g7XG4gIH1cblxuICBzdG9yZShyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgc3RhdGU6IERldGFjaGVkUm91dGVIYW5kbGUpOiB2b2lkIHtcbiAgICByb3V0ZSA9IGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQocm91dGUpO1xuXG4gICAgY29uc3Qga2V5ID0gZ2V0U25hcHNob3RLZXkocm91dGUpO1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBzdG9yZSBrZXk6ICR7a2V5fSwgc3RhdGU6ICR7c3RhdGV9YCk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBvdXRsZXRLZXkgfSA9IHRoaXMuZmluZFZhbGlkT3V0bGV0QW5kS2V5KHJvdXRlKTtcblxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICBjb25zdCBjYWNoZSA9ICh0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XSA9IHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldIHx8IG5ldyBEZXRhY2hlZFN0YXRlQ2FjaGUoKSk7XG5cbiAgICBpZiAoc3RhdGUpIHtcbiAgICAgIGxldCBpc01vZGFsID0gZmFsc2U7XG4gICAgICBpZiAodGhpcy5sb2NhdGlvbi5fbW9kYWxOYXZpZ2F0aW9uRGVwdGggPiAwKSB7XG4gICAgICAgIGlzTW9kYWwgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBjYWNoZS5wdXNoKHsga2V5LCBzdGF0ZSwgaXNNb2RhbCB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgdG9wSXRlbSA9IGNhY2hlLnBlZWsoKTtcbiAgICAgIGlmICh0b3BJdGVtLmtleSA9PT0ga2V5KSB7XG4gICAgICAgIGNhY2hlLnBvcCgpO1xuXG4gICAgICAgIGlmICghY2FjaGUubGVuZ3RoKSB7XG4gICAgICAgICAgZGVsZXRlIHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUcnlpbmcgdG8gcG9wIGZyb20gRGV0YWNoZWRTdGF0ZUNhY2hlIGJ1dCBrZXlzIGRvbid0IG1hdGNoLiBcIiArIGBleHBlY3RlZDogJHt0b3BJdGVtLmtleX0gYWN0dWFsOiAke2tleX1gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXRyaWV2ZShyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IERldGFjaGVkUm91dGVIYW5kbGUgfCBudWxsIHtcbiAgICByb3V0ZSA9IGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQocm91dGUpO1xuXG4gICAgY29uc3QgeyBvdXRsZXQsIG91dGxldEtleSB9ID0gdGhpcy5maW5kVmFsaWRPdXRsZXRBbmRLZXkocm91dGUpO1xuICAgIGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG4gICAgaWYgKCFjYWNoZSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3Qga2V5ID0gZ2V0U25hcHNob3RLZXkocm91dGUpO1xuICAgIGNvbnN0IGlzQmFjayA9IG91dGxldCA/IG91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjayA6IGZhbHNlO1xuICAgIGNvbnN0IGNhY2hlZEl0ZW0gPSBjYWNoZS5wZWVrKCk7XG5cbiAgICBsZXQgc3RhdGUgPSBudWxsO1xuICAgIGlmIChpc0JhY2sgJiYgY2FjaGVkSXRlbSAmJiBjYWNoZWRJdGVtLmtleSA9PT0ga2V5KSB7XG4gICAgICBzdGF0ZSA9IGNhY2hlZEl0ZW0uc3RhdGU7XG4gICAgfVxuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYHJldHJpZXZlZCBpc0JhY2s6ICR7aXNCYWNrfSBrZXk6ICR7a2V5fSBzdGF0ZTogJHtzdGF0ZX1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3RhdGU7XG4gIH1cblxuICBzaG91bGRSZXVzZVJvdXRlKGZ1dHVyZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgY3VycjogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHNob3VsZFJldXNlID0gZnV0dXJlLnJvdXRlQ29uZmlnID09PSBjdXJyLnJvdXRlQ29uZmlnO1xuXG4gICAgaWYgKHNob3VsZFJldXNlICYmIGN1cnIgJiYgY3VycltwYWdlUm91dGVyQWN0aXZhdGVkU3ltYm9sXSkge1xuICAgICAgLy8gV2hlbiByZXVzaW5nIHJvdXRlIC0gY29weSB0aGUgcGFnZVJvdXRlckFjdGl2YXRlZCB0byB0aGUgbmV3IHNuYXBzaG90XG4gICAgICAvLyBJdCdzIG5lZWRlZCBpbiBzaG91bGREZXRhY2ggdG8gZGV0ZXJtaW5lIGlmIHRoZSByb3V0ZSBzaG91bGQgYmUgZGV0YWNoZWQuXG4gICAgICBmdXR1cmVbcGFnZVJvdXRlckFjdGl2YXRlZFN5bWJvbF0gPSBjdXJyW3BhZ2VSb3V0ZXJBY3RpdmF0ZWRTeW1ib2xdO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBzaG91bGRSZXVzZVJvdXRlIHJlc3VsdDogJHtzaG91bGRSZXVzZX1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2hvdWxkUmV1c2U7XG4gIH1cblxuICBjbGVhckNhY2hlKG91dGxldEtleTogc3RyaW5nKSB7XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XTtcblxuICAgIGlmIChjYWNoZSkge1xuICAgICAgY2FjaGUuY2xlYXIoKTtcbiAgICB9XG4gIH1cblxuICBtYXJrQ2FjaGVGb3JDbGVhcihvdXRsZXRLZXk6IHN0cmluZykge1xuICAgIGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG5cbiAgICBpZiAoY2FjaGUpIHtcbiAgICAgIGNhY2hlLm1hcmtDdXJyZW50Rm9yQ2xlYXIoKTtcbiAgICB9XG4gIH1cblxuICBwb3BDYWNoZShvdXRsZXRLZXk6IHN0cmluZykge1xuICAgIGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG5cbiAgICBpZiAoY2FjaGUpIHtcbiAgICAgIGlmIChjYWNoZS5wZWVrKCkpIHtcbiAgICAgICAgY29uc3Qgc3RhdGU6IGFueSA9IGNhY2hlLnBvcCgpPy5zdGF0ZTtcbiAgICAgICAgaWYgKHN0YXRlPy5jb21wb25lbnRSZWYpIHtcbiAgICAgICAgICBkZXN0cm95Q29tcG9uZW50UmVmKHN0YXRlPy5jb21wb25lbnRSZWYpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbWFya0NhY2hlRm9yUG9wKG91dGxldEtleTogc3RyaW5nKSB7XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XTtcblxuICAgIGlmIChjYWNoZSkge1xuICAgICAgY29uc3QgaXRlbSA9IGNhY2hlLnBlZWsoKTtcbiAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgIGl0ZW0ubWFya2VkRm9yRGVsZXRpb24gPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNsZWFyTWFya2VkQ2FjaGUob3V0bGV0S2V5OiBzdHJpbmcpIHtcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldO1xuXG4gICAgaWYgKGNhY2hlKSB7XG4gICAgICBjYWNoZS5jbGVhck1hcmtlZCgpO1xuICAgIH1cbiAgfVxuXG4gIGNsZWFyTW9kYWxDYWNoZShvdXRsZXRLZXk6IHN0cmluZykge1xuICAgIGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG5cbiAgICBpZiAoY2FjaGUpIHtcbiAgICAgIGNhY2hlLmNsZWFyTW9kYWxDYWNoZSgpO1xuICAgIH1cbiAgfVxufVxuIl19