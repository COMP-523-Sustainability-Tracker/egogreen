import { ApplicationRef, ComponentFactoryResolver, Injectable, Injector, NgZone } from '@angular/core';
import { Application, ContentView, Frame } from '@nativescript/core';
import { Subject } from 'rxjs';
import { AppHostAsyncView, AppHostView } from '../../app-host-view';
import { ComponentPortal } from '../../cdk/portal/common';
import { NativeScriptDomPortalOutlet } from '../../cdk/portal/nsdom-portal-outlet';
import { once } from '../../utils/general';
import { NgViewRef } from '../../view-refs';
import { NSLocationStrategy } from '../router/ns-location-strategy';
import * as i0 from "@angular/core";
import * as i1 from "../router/ns-location-strategy";
export class ModalDialogParams {
    constructor(context = {}, closeCallback) {
        this.context = context;
        this.closeCallback = closeCallback;
    }
}
class ModalDialogService {
    constructor(location, zone, appRef, defaultInjector) {
        this.location = location;
        this.zone = zone;
        this.appRef = appRef;
        this.defaultInjector = defaultInjector;
    }
    /**
     * Emits anytime a modal is closed with the ModalDialogParams which were injected into the component which is now closing.
     * For example, can be used to wire up Rx flows outside the scope of just the component being handled.
     */
    get closed$() {
        if (!this._closed$) {
            this._closed$ = new Subject();
        }
        return this._closed$;
    }
    showModal(type, options = {}) {
        // if (!options.viewContainerRef) {
        //   throw new Error('No viewContainerRef: ' + 'Make sure you pass viewContainerRef in ModalDialogOptions.');
        // }
        let parentView = options.viewContainerRef?.element.nativeElement || Application.getRootView();
        if (options.target) {
            parentView = options.target;
        }
        if ((parentView instanceof AppHostView || parentView instanceof AppHostAsyncView) && parentView.ngAppRoot) {
            parentView = parentView.ngAppRoot;
        }
        // _ngDialogRoot is the first child of the previously detached proxy.
        // It should have 'viewController' (iOS) or '_dialogFragment' (Android) available for
        // presenting future modal views.
        if (parentView._ngDialogRoot) {
            parentView = parentView._ngDialogRoot;
        }
        // resolve from particular module (moduleRef)
        // or from same module as parentView (viewContainerRef)
        const componentInjector = options.moduleRef?.injector || options.viewContainerRef?.injector || this.defaultInjector;
        const resolver = componentInjector.get(ComponentFactoryResolver);
        let frame = parentView;
        if (!(parentView instanceof Frame)) {
            frame = (parentView.page && parentView.page.frame) || Frame.topmost();
        }
        this.location?._beginModalNavigation(frame);
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                try {
                    this._showDialog({
                        ...options,
                        containerRef: options.viewContainerRef,
                        injector: componentInjector,
                        context: options.context,
                        doneCallback: resolve,
                        parentView,
                        resolver,
                        type,
                    });
                }
                catch (err) {
                    reject(err);
                }
            }, 10);
        });
    }
    _showDialog(options) {
        let componentViewRef;
        let detachedLoaderRef;
        let portalOutlet;
        const closeCallback = once(async (...args) => {
            options.doneCallback.apply(undefined, args);
            if (componentViewRef) {
                componentViewRef.firstNativeLikeView.closeModal();
                const params = this.openedModalParams.pop();
                if (this._closed$) {
                    this._closed$.next(params);
                }
                await this.location._closeModalNavigation();
                if (detachedLoaderRef || portalOutlet) {
                    this.zone.run(() => {
                        portalOutlet?.dispose();
                        detachedLoaderRef?.instance.detectChanges();
                        detachedLoaderRef?.destroy();
                    });
                }
            }
        });
        const modalParams = new ModalDialogParams(options.context, closeCallback);
        if (!this.openedModalParams) {
            this.openedModalParams = [];
        }
        this.openedModalParams.push(modalParams);
        const childInjector = Injector.create({
            providers: [{ provide: ModalDialogParams, useValue: modalParams }],
            parent: options.injector,
        });
        this.zone.run(() => {
            // if we ever support templates in the old API
            // if(options.templateRef) {
            //     const detachedFactory = options.resolver.resolveComponentFactory(DetachedLoader);
            //     if(options.attachToContainerRef) {
            //         detachedLoaderRef = options.attachToContainerRef.createComponent(detachedFactory, 0, childInjector, null);
            //     } else {
            //         detachedLoaderRef = detachedFactory.create(childInjector); // this DetachedLoader is **completely** detached
            //         this.appRef.attachView(detachedLoaderRef.hostView); // we attach it to the applicationRef, so it becomes a "root" view in angular's hierarchy
            //     }
            //     detachedLoaderRef.changeDetectorRef.detectChanges(); // force a change detection
            //     detachedLoaderRef.instance.createTemplatePortal(options.templateRef);
            // }
            const targetView = new ContentView();
            const portal = new ComponentPortal(options.type);
            portalOutlet = new NativeScriptDomPortalOutlet(targetView, options.resolver, this.appRef, childInjector);
            const componentRef = portalOutlet.attach(portal);
            componentRef.changeDetectorRef.detectChanges();
            componentViewRef = new NgViewRef(componentRef);
            if (options.useContextAsComponentProps && options.context) {
                for (const key in options.context) {
                    componentViewRef.ref.instance[key] = options.context[key];
                }
            }
            if (componentViewRef !== componentRef.location.nativeElement) {
                componentRef.location.nativeElement._ngDialogRoot = componentViewRef.firstNativeLikeView;
            }
            // if we don't detach the view from its parent, ios gets mad
            componentViewRef.detachNativeLikeView();
            options.parentView.showModal(componentViewRef.firstNativeLikeView, { ...options, closeCallback });
        });
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: ModalDialogService, deps: [{ token: i1.NSLocationStrategy }, { token: i0.NgZone }, { token: i0.ApplicationRef }, { token: i0.Injector }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: ModalDialogService }); }
}
export { ModalDialogService };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: ModalDialogService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.NSLocationStrategy }, { type: i0.NgZone }, { type: i0.ApplicationRef }, { type: i0.Injector }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9ncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2FuZ3VsYXIvc3JjL2xpYi9sZWdhY3kvZGlyZWN0aXZlcy9kaWFsb2dzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsd0JBQXdCLEVBQWdCLFVBQVUsRUFBRSxRQUFRLEVBQWUsTUFBTSxFQUEwQixNQUFNLGVBQWUsQ0FBQztBQUMxSixPQUFPLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQW9DLE1BQU0sb0JBQW9CLENBQUM7QUFDdkcsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFcEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzFELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ25GLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDNUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7OztBQStCcEUsTUFBTSxPQUFPLGlCQUFpQjtJQUM1QixZQUFtQixVQUFlLEVBQUUsRUFBUyxhQUErQjtRQUF6RCxZQUFPLEdBQVAsT0FBTyxDQUFVO1FBQVMsa0JBQWEsR0FBYixhQUFhLENBQWtCO0lBQUcsQ0FBQztDQUNqRjtBQUVELE1BQ2Esa0JBQWtCO0lBUzdCLFlBQW9CLFFBQTRCLEVBQVUsSUFBWSxFQUFVLE1BQXNCLEVBQVUsZUFBeUI7UUFBckgsYUFBUSxHQUFSLFFBQVEsQ0FBb0I7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBZ0I7UUFB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QyxDQUFDO1FBQ3BHLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs4R0E1SVUsa0JBQWtCO2tIQUFsQixrQkFBa0I7O1NBQWxCLGtCQUFrQjsyRkFBbEIsa0JBQWtCO2tCQUQ5QixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwbGljYXRpb25SZWYsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBJbmplY3RhYmxlLCBJbmplY3RvciwgTmdNb2R1bGVSZWYsIE5nWm9uZSwgVHlwZSwgVmlld0NvbnRhaW5lclJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQXBwbGljYXRpb24sIENvbnRlbnRWaWV3LCBGcmFtZSwgU2hvd01vZGFsT3B0aW9ucywgVmlldywgVmlld0Jhc2UgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQXBwSG9zdEFzeW5jVmlldywgQXBwSG9zdFZpZXcgfSBmcm9tICcuLi8uLi9hcHAtaG9zdC12aWV3JztcbmltcG9ydCB7IERldGFjaGVkTG9hZGVyIH0gZnJvbSAnLi4vLi4vY2RrL2RldGFjaGVkLWxvYWRlcic7XG5pbXBvcnQgeyBDb21wb25lbnRQb3J0YWwgfSBmcm9tICcuLi8uLi9jZGsvcG9ydGFsL2NvbW1vbic7XG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQgfSBmcm9tICcuLi8uLi9jZGsvcG9ydGFsL25zZG9tLXBvcnRhbC1vdXRsZXQnO1xuaW1wb3J0IHsgb25jZSB9IGZyb20gJy4uLy4uL3V0aWxzL2dlbmVyYWwnO1xuaW1wb3J0IHsgTmdWaWV3UmVmIH0gZnJvbSAnLi4vLi4vdmlldy1yZWZzJztcbmltcG9ydCB7IE5TTG9jYXRpb25TdHJhdGVneSB9IGZyb20gJy4uL3JvdXRlci9ucy1sb2NhdGlvbi1zdHJhdGVneSc7XG5cbmV4cG9ydCB0eXBlIEJhc2VTaG93TW9kYWxPcHRpb25zID0gUGljazxTaG93TW9kYWxPcHRpb25zLCBFeGNsdWRlPGtleW9mIFNob3dNb2RhbE9wdGlvbnMsICdjbG9zZUNhbGxiYWNrJyB8ICdjb250ZXh0Jz4+O1xuXG5leHBvcnQgaW50ZXJmYWNlIE1vZGFsRGlhbG9nT3B0aW9ucyBleHRlbmRzIEJhc2VTaG93TW9kYWxPcHRpb25zIHtcbiAgY29udGV4dD86IGFueTtcbiAgdmlld0NvbnRhaW5lclJlZj86IFZpZXdDb250YWluZXJSZWY7XG4gIG1vZHVsZVJlZj86IE5nTW9kdWxlUmVmPGFueT47XG4gIHRhcmdldD86IFZpZXc7XG4gIC8qKlxuICAgKiBVc2UgY29udGV4dCBkYXRhIGFzIGNvbXBvbmVudCBpbnN0YW5jZSBwcm9wZXJ0aWVzXG4gICAqL1xuICB1c2VDb250ZXh0QXNDb21wb25lbnRQcm9wcz86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2hvd0RpYWxvZ09wdGlvbnMgZXh0ZW5kcyBNb2RhbERpYWxvZ09wdGlvbnMge1xuICBjb250YWluZXJSZWY/OiBWaWV3Q29udGFpbmVyUmVmO1xuICAvKipcbiAgICogd2hpY2ggY29udGFpbmVyIHRvIGF0dGFjaCB0aGUgY2hhbmdlIGRldGVjdGlvblxuICAgKiBpZiBub3Qgc3BlY2lmaWVkLCBhdHRhY2hlcyB0byB0aGUgQXBwbGljYXRpb25SZWYgKHJlY29tbWVuZGVkKVxuICAgKi9cbiAgYXR0YWNoVG9Db250YWluZXJSZWY/OiBWaWV3Q29udGFpbmVyUmVmO1xuICBpbmplY3RvcjogSW5qZWN0b3I7XG4gIGNvbnRleHQ6IGFueTtcbiAgZG9uZUNhbGxiYWNrO1xuICBwYWdlRmFjdG9yeT86IGFueTtcbiAgcGFyZW50VmlldzogVmlld0Jhc2U7XG4gIHJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI7XG4gIHR5cGU6IFR5cGU8YW55Pjtcbn1cblxuZXhwb3J0IGNsYXNzIE1vZGFsRGlhbG9nUGFyYW1zIHtcbiAgY29uc3RydWN0b3IocHVibGljIGNvbnRleHQ6IGFueSA9IHt9LCBwdWJsaWMgY2xvc2VDYWxsYmFjazogKC4uLmFyZ3MpID0+IGFueSkge31cbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE1vZGFsRGlhbG9nU2VydmljZSB7XG4gIC8qKlxuICAgKiBBbnkgb3BlbmVkIE1vZGFsRGlhbG9nUGFyYW1zIGluIG9yZGVyIG9mIHdoZW4gdGhleSB3ZXJlIG9wZW5lZCAoTW9zdCByZWNlbnQgb24gdG9wKS5cbiAgICogVGhpcyBjYW4gYmUgdXNlZCB3aGVuIHlvdSBuZWVkIGFjY2VzcyB0byBNb2RhbERpYWxvZ1BhcmFtcyBvdXRzaWRlIG9mIHRoZSBjb21wb25lbnQgd2hpY2ggaGFkIHRoZW0gaW5qZWN0ZWQuXG4gICAqIEVhY2ggaXMgcG9wcGVkIG9mZiBhcyBtb2RhbHMgYXJlIGNsb3NlZC5cbiAgICovXG4gIG9wZW5lZE1vZGFsUGFyYW1zOiBBcnJheTxNb2RhbERpYWxvZ1BhcmFtcz47XG4gIF9jbG9zZWQkOiBTdWJqZWN0PE1vZGFsRGlhbG9nUGFyYW1zPjtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxvY2F0aW9uOiBOU0xvY2F0aW9uU3RyYXRlZ3ksIHByaXZhdGUgem9uZTogTmdab25lLCBwcml2YXRlIGFwcFJlZjogQXBwbGljYXRpb25SZWYsIHByaXZhdGUgZGVmYXVsdEluamVjdG9yOiBJbmplY3Rvcikge31cblxuICAvKipcbiAgICogRW1pdHMgYW55dGltZSBhIG1vZGFsIGlzIGNsb3NlZCB3aXRoIHRoZSBNb2RhbERpYWxvZ1BhcmFtcyB3aGljaCB3ZXJlIGluamVjdGVkIGludG8gdGhlIGNvbXBvbmVudCB3aGljaCBpcyBub3cgY2xvc2luZy5cbiAgICogRm9yIGV4YW1wbGUsIGNhbiBiZSB1c2VkIHRvIHdpcmUgdXAgUnggZmxvd3Mgb3V0c2lkZSB0aGUgc2NvcGUgb2YganVzdCB0aGUgY29tcG9uZW50IGJlaW5nIGhhbmRsZWQuXG4gICAqL1xuICBnZXQgY2xvc2VkJCgpIHtcbiAgICBpZiAoIXRoaXMuX2Nsb3NlZCQpIHtcbiAgICAgIHRoaXMuX2Nsb3NlZCQgPSBuZXcgU3ViamVjdCgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fY2xvc2VkJDtcbiAgfVxuXG4gIHB1YmxpYyBzaG93TW9kYWwodHlwZTogVHlwZTxhbnk+LCBvcHRpb25zOiBNb2RhbERpYWxvZ09wdGlvbnMgPSB7fSk6IFByb21pc2U8YW55PiB7XG4gICAgLy8gaWYgKCFvcHRpb25zLnZpZXdDb250YWluZXJSZWYpIHtcbiAgICAvLyAgIHRocm93IG5ldyBFcnJvcignTm8gdmlld0NvbnRhaW5lclJlZjogJyArICdNYWtlIHN1cmUgeW91IHBhc3Mgdmlld0NvbnRhaW5lclJlZiBpbiBNb2RhbERpYWxvZ09wdGlvbnMuJyk7XG4gICAgLy8gfVxuXG4gICAgbGV0IHBhcmVudFZpZXcgPSBvcHRpb25zLnZpZXdDb250YWluZXJSZWY/LmVsZW1lbnQubmF0aXZlRWxlbWVudCB8fCBBcHBsaWNhdGlvbi5nZXRSb290VmlldygpO1xuICAgIGlmIChvcHRpb25zLnRhcmdldCkge1xuICAgICAgcGFyZW50VmlldyA9IG9wdGlvbnMudGFyZ2V0O1xuICAgIH1cblxuICAgIGlmICgocGFyZW50VmlldyBpbnN0YW5jZW9mIEFwcEhvc3RWaWV3IHx8IHBhcmVudFZpZXcgaW5zdGFuY2VvZiBBcHBIb3N0QXN5bmNWaWV3KSAmJiBwYXJlbnRWaWV3Lm5nQXBwUm9vdCkge1xuICAgICAgcGFyZW50VmlldyA9IHBhcmVudFZpZXcubmdBcHBSb290O1xuICAgIH1cblxuICAgIC8vIF9uZ0RpYWxvZ1Jvb3QgaXMgdGhlIGZpcnN0IGNoaWxkIG9mIHRoZSBwcmV2aW91c2x5IGRldGFjaGVkIHByb3h5LlxuICAgIC8vIEl0IHNob3VsZCBoYXZlICd2aWV3Q29udHJvbGxlcicgKGlPUykgb3IgJ19kaWFsb2dGcmFnbWVudCcgKEFuZHJvaWQpIGF2YWlsYWJsZSBmb3JcbiAgICAvLyBwcmVzZW50aW5nIGZ1dHVyZSBtb2RhbCB2aWV3cy5cbiAgICBpZiAocGFyZW50Vmlldy5fbmdEaWFsb2dSb290KSB7XG4gICAgICBwYXJlbnRWaWV3ID0gcGFyZW50Vmlldy5fbmdEaWFsb2dSb290O1xuICAgIH1cblxuICAgIC8vIHJlc29sdmUgZnJvbSBwYXJ0aWN1bGFyIG1vZHVsZSAobW9kdWxlUmVmKVxuICAgIC8vIG9yIGZyb20gc2FtZSBtb2R1bGUgYXMgcGFyZW50VmlldyAodmlld0NvbnRhaW5lclJlZilcbiAgICBjb25zdCBjb21wb25lbnRJbmplY3RvciA9IG9wdGlvbnMubW9kdWxlUmVmPy5pbmplY3RvciB8fCBvcHRpb25zLnZpZXdDb250YWluZXJSZWY/LmluamVjdG9yIHx8IHRoaXMuZGVmYXVsdEluamVjdG9yO1xuICAgIGNvbnN0IHJlc29sdmVyID0gY29tcG9uZW50SW5qZWN0b3IuZ2V0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcik7XG5cbiAgICBsZXQgZnJhbWUgPSBwYXJlbnRWaWV3O1xuICAgIGlmICghKHBhcmVudFZpZXcgaW5zdGFuY2VvZiBGcmFtZSkpIHtcbiAgICAgIGZyYW1lID0gKHBhcmVudFZpZXcucGFnZSAmJiBwYXJlbnRWaWV3LnBhZ2UuZnJhbWUpIHx8IEZyYW1lLnRvcG1vc3QoKTtcbiAgICB9XG5cbiAgICB0aGlzLmxvY2F0aW9uPy5fYmVnaW5Nb2RhbE5hdmlnYXRpb24oZnJhbWUpO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHRoaXMuX3Nob3dEaWFsb2coe1xuICAgICAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgICAgICAgIGNvbnRhaW5lclJlZjogb3B0aW9ucy52aWV3Q29udGFpbmVyUmVmLFxuICAgICAgICAgICAgaW5qZWN0b3I6IGNvbXBvbmVudEluamVjdG9yLFxuICAgICAgICAgICAgY29udGV4dDogb3B0aW9ucy5jb250ZXh0LFxuICAgICAgICAgICAgZG9uZUNhbGxiYWNrOiByZXNvbHZlLFxuICAgICAgICAgICAgcGFyZW50VmlldyxcbiAgICAgICAgICAgIHJlc29sdmVyLFxuICAgICAgICAgICAgdHlwZSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH1cbiAgICAgIH0sIDEwKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX3Nob3dEaWFsb2cob3B0aW9uczogU2hvd0RpYWxvZ09wdGlvbnMpOiB2b2lkIHtcbiAgICBsZXQgY29tcG9uZW50Vmlld1JlZjogTmdWaWV3UmVmPHVua25vd24+O1xuICAgIGxldCBkZXRhY2hlZExvYWRlclJlZjogQ29tcG9uZW50UmVmPERldGFjaGVkTG9hZGVyPjtcbiAgICBsZXQgcG9ydGFsT3V0bGV0OiBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQ7XG5cbiAgICBjb25zdCBjbG9zZUNhbGxiYWNrID0gb25jZShhc3luYyAoLi4uYXJncykgPT4ge1xuICAgICAgb3B0aW9ucy5kb25lQ2FsbGJhY2suYXBwbHkodW5kZWZpbmVkLCBhcmdzKTtcbiAgICAgIGlmIChjb21wb25lbnRWaWV3UmVmKSB7XG4gICAgICAgIGNvbXBvbmVudFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldy5jbG9zZU1vZGFsKCk7XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMub3BlbmVkTW9kYWxQYXJhbXMucG9wKCk7XG4gICAgICAgIGlmICh0aGlzLl9jbG9zZWQkKSB7XG4gICAgICAgICAgdGhpcy5fY2xvc2VkJC5uZXh0KHBhcmFtcyk7XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgdGhpcy5sb2NhdGlvbi5fY2xvc2VNb2RhbE5hdmlnYXRpb24oKTtcbiAgICAgICAgaWYgKGRldGFjaGVkTG9hZGVyUmVmIHx8IHBvcnRhbE91dGxldCkge1xuICAgICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgcG9ydGFsT3V0bGV0Py5kaXNwb3NlKCk7XG4gICAgICAgICAgICBkZXRhY2hlZExvYWRlclJlZj8uaW5zdGFuY2UuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgICAgICAgZGV0YWNoZWRMb2FkZXJSZWY/LmRlc3Ryb3koKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgbW9kYWxQYXJhbXMgPSBuZXcgTW9kYWxEaWFsb2dQYXJhbXMob3B0aW9ucy5jb250ZXh0LCBjbG9zZUNhbGxiYWNrKTtcbiAgICBpZiAoIXRoaXMub3BlbmVkTW9kYWxQYXJhbXMpIHtcbiAgICAgIHRoaXMub3BlbmVkTW9kYWxQYXJhbXMgPSBbXTtcbiAgICB9XG4gICAgdGhpcy5vcGVuZWRNb2RhbFBhcmFtcy5wdXNoKG1vZGFsUGFyYW1zKTtcblxuICAgIGNvbnN0IGNoaWxkSW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgcHJvdmlkZXJzOiBbeyBwcm92aWRlOiBNb2RhbERpYWxvZ1BhcmFtcywgdXNlVmFsdWU6IG1vZGFsUGFyYW1zIH1dLFxuICAgICAgcGFyZW50OiBvcHRpb25zLmluamVjdG9yLFxuICAgIH0pO1xuICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgLy8gaWYgd2UgZXZlciBzdXBwb3J0IHRlbXBsYXRlcyBpbiB0aGUgb2xkIEFQSVxuICAgICAgLy8gaWYob3B0aW9ucy50ZW1wbGF0ZVJlZikge1xuICAgICAgLy8gICAgIGNvbnN0IGRldGFjaGVkRmFjdG9yeSA9IG9wdGlvbnMucmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoRGV0YWNoZWRMb2FkZXIpO1xuICAgICAgLy8gICAgIGlmKG9wdGlvbnMuYXR0YWNoVG9Db250YWluZXJSZWYpIHtcbiAgICAgIC8vICAgICAgICAgZGV0YWNoZWRMb2FkZXJSZWYgPSBvcHRpb25zLmF0dGFjaFRvQ29udGFpbmVyUmVmLmNyZWF0ZUNvbXBvbmVudChkZXRhY2hlZEZhY3RvcnksIDAsIGNoaWxkSW5qZWN0b3IsIG51bGwpO1xuICAgICAgLy8gICAgIH0gZWxzZSB7XG4gICAgICAvLyAgICAgICAgIGRldGFjaGVkTG9hZGVyUmVmID0gZGV0YWNoZWRGYWN0b3J5LmNyZWF0ZShjaGlsZEluamVjdG9yKTsgLy8gdGhpcyBEZXRhY2hlZExvYWRlciBpcyAqKmNvbXBsZXRlbHkqKiBkZXRhY2hlZFxuICAgICAgLy8gICAgICAgICB0aGlzLmFwcFJlZi5hdHRhY2hWaWV3KGRldGFjaGVkTG9hZGVyUmVmLmhvc3RWaWV3KTsgLy8gd2UgYXR0YWNoIGl0IHRvIHRoZSBhcHBsaWNhdGlvblJlZiwgc28gaXQgYmVjb21lcyBhIFwicm9vdFwiIHZpZXcgaW4gYW5ndWxhcidzIGhpZXJhcmNoeVxuICAgICAgLy8gICAgIH1cbiAgICAgIC8vICAgICBkZXRhY2hlZExvYWRlclJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7IC8vIGZvcmNlIGEgY2hhbmdlIGRldGVjdGlvblxuICAgICAgLy8gICAgIGRldGFjaGVkTG9hZGVyUmVmLmluc3RhbmNlLmNyZWF0ZVRlbXBsYXRlUG9ydGFsKG9wdGlvbnMudGVtcGxhdGVSZWYpO1xuICAgICAgLy8gfVxuICAgICAgY29uc3QgdGFyZ2V0VmlldyA9IG5ldyBDb250ZW50VmlldygpO1xuICAgICAgY29uc3QgcG9ydGFsID0gbmV3IENvbXBvbmVudFBvcnRhbChvcHRpb25zLnR5cGUpO1xuICAgICAgcG9ydGFsT3V0bGV0ID0gbmV3IE5hdGl2ZVNjcmlwdERvbVBvcnRhbE91dGxldCh0YXJnZXRWaWV3LCBvcHRpb25zLnJlc29sdmVyLCB0aGlzLmFwcFJlZiwgY2hpbGRJbmplY3Rvcik7XG4gICAgICBjb25zdCBjb21wb25lbnRSZWYgPSBwb3J0YWxPdXRsZXQuYXR0YWNoKHBvcnRhbCk7XG4gICAgICBjb21wb25lbnRSZWYuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgY29tcG9uZW50Vmlld1JlZiA9IG5ldyBOZ1ZpZXdSZWYoY29tcG9uZW50UmVmKTtcbiAgICAgIGlmIChvcHRpb25zLnVzZUNvbnRleHRBc0NvbXBvbmVudFByb3BzICYmIG9wdGlvbnMuY29udGV4dCkge1xuICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBvcHRpb25zLmNvbnRleHQpIHtcbiAgICAgICAgICAoPENvbXBvbmVudFJlZjxhbnk+PmNvbXBvbmVudFZpZXdSZWYucmVmKS5pbnN0YW5jZVtrZXldID0gb3B0aW9ucy5jb250ZXh0W2tleV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChjb21wb25lbnRWaWV3UmVmICE9PSBjb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudCkge1xuICAgICAgICBjb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudC5fbmdEaWFsb2dSb290ID0gY29tcG9uZW50Vmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3O1xuICAgICAgfVxuICAgICAgLy8gaWYgd2UgZG9uJ3QgZGV0YWNoIHRoZSB2aWV3IGZyb20gaXRzIHBhcmVudCwgaW9zIGdldHMgbWFkXG4gICAgICBjb21wb25lbnRWaWV3UmVmLmRldGFjaE5hdGl2ZUxpa2VWaWV3KCk7XG4gICAgICBvcHRpb25zLnBhcmVudFZpZXcuc2hvd01vZGFsKGNvbXBvbmVudFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldywgeyAuLi5vcHRpb25zLCBjbG9zZUNhbGxiYWNrIH0pO1xuICAgIH0pO1xuICB9XG59XG4iXX0=