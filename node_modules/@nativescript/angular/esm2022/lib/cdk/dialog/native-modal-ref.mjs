import { __decorate, __metadata, __param } from "tslib";
import { ApplicationRef, ComponentFactoryResolver, Injector, Optional } from '@angular/core';
import { Application, ContentView, Frame } from '@nativescript/core';
import { fromEvent, Subject } from 'rxjs';
import { take } from 'rxjs/operators';
import { AppHostAsyncView, AppHostView } from '../../app-host-view';
import { NSLocationStrategy } from '../../legacy/router/ns-location-strategy';
import { once } from '../../utils/general';
import { NgViewRef } from '../../view-refs';
import { DetachedLoader } from '../detached-loader';
import { NativeScriptDomPortalOutlet } from '../portal/nsdom-portal-outlet';
import { NativeDialogConfig } from './dialog-config';
let NativeModalRef = class NativeModalRef {
    constructor(_config, _injector, location) {
        this._config = _config;
        this._injector = _injector;
        this.location = location;
        this.stateChanged = new Subject();
        this.onDismiss = new Subject();
        this._isDismissed = false;
        let parentView = this._config.viewContainerRef?.element.nativeElement || Application.getRootView();
        if ((parentView instanceof AppHostView || parentView instanceof AppHostAsyncView) && parentView.ngAppRoot) {
            parentView = parentView.ngAppRoot;
        }
        // _ngDialogRoot is the first child of the previously detached proxy.
        // It should have 'viewController' (iOS) or '_dialogFragment' (Android) available for
        // presenting future modal views.
        while (parentView._modal || parentView._ngDialogRoot) {
            parentView = parentView._modal || parentView._ngDialogRoot;
        }
        this.parentView = parentView;
        this._closeCallback = once(async () => {
            this.stateChanged.next({ state: 'closing' });
            if (!this._isDismissed) {
                this.modalViewRef.firstNativeLikeView?.closeModal();
            }
            await this.location?._closeModalNavigation();
            // this.detachedLoaderRef?.destroy();
            if (this.modalViewRef?.firstNativeLikeView.isLoaded) {
                fromEvent(this.modalViewRef.firstNativeLikeView, 'unloaded')
                    .pipe(take(1))
                    .subscribe(() => this.stateChanged.next({ state: 'closed' }));
            }
            else {
                this.stateChanged.next({ state: 'closed' });
            }
        });
    }
    _generateDetachedContainer(vcRef) {
        const detachedFactory = (this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver)).resolveComponentFactory(DetachedLoader);
        if (vcRef) {
            this.detachedLoaderRef = vcRef.createComponent(detachedFactory);
        }
        else {
            this.detachedLoaderRef = detachedFactory.create(this._config.viewContainerRef?.injector || this._injector);
            this._injector.get(ApplicationRef).attachView(this.detachedLoaderRef.hostView);
        }
        this.detachedLoaderRef.changeDetectorRef.detectChanges();
    }
    attachTemplatePortal(portal) {
        this.startModalNavigation();
        const vcRef = portal.viewContainerRef || this._config.viewContainerRef;
        this._generateDetachedContainer(vcRef);
        portal.viewContainerRef = this.detachedLoaderRef.instance.vc;
        const targetView = new ContentView();
        this.portalOutlet = new NativeScriptDomPortalOutlet(targetView, this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver), this._injector.get(ApplicationRef), this._injector);
        const templateRef = this.portalOutlet.attach(portal);
        this.modalViewRef = new NgViewRef(templateRef);
        this.modalViewRef.firstNativeLikeView['__ng_modal_id__'] = this._id;
        // if we don't detach the view from its parent, ios gets mad
        this.modalViewRef.detachNativeLikeView();
        const userOptions = this._config.nativeOptions || {};
        this.parentView.showModal(this.modalViewRef.firstNativeLikeView, {
            context: null,
            ...userOptions,
            closeCallback: async () => {
                await this.location?._closeModalNavigation();
                this.onDismiss.next();
                this.onDismiss.complete();
            },
            cancelable: !this._config.disableClose,
        });
        //   if (this.modalView !== templateRef.rootNodes[0]) {
        //     componentRef.location.nativeElement._ngDialogRoot = this.modalView;
        //   }
        return templateRef;
    }
    attachComponentPortal(portal) {
        this.startModalNavigation();
        const targetView = new ContentView();
        this.portalOutlet = new NativeScriptDomPortalOutlet(targetView, this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver), this._injector.get(ApplicationRef), this._injector);
        const componentRef = this.portalOutlet.attach(portal);
        componentRef.changeDetectorRef.detectChanges();
        this.modalViewRef = new NgViewRef(componentRef);
        if (this.modalViewRef.firstNativeLikeView !== this.modalViewRef.view) {
            this.modalViewRef.view._ngDialogRoot = this.modalViewRef.firstNativeLikeView;
        }
        this.modalViewRef.firstNativeLikeView['__ng_modal_id__'] = this._id;
        // if we don't detach the view from its parent, ios gets mad
        this.modalViewRef.detachNativeLikeView();
        const userOptions = this._config.nativeOptions || {};
        this.parentView.showModal(this.modalViewRef.firstNativeLikeView, {
            context: null,
            ...userOptions,
            closeCallback: async () => {
                this._isDismissed = true;
                this._closeCallback(); // close callback can only be called once, so we call it here to setup the exit events
                this.onDismiss.next();
                this.onDismiss.complete();
            },
            cancelable: !this._config.disableClose,
        });
        return componentRef;
    }
    _startExitAnimation() {
        this._closeCallback();
    }
    dispose() {
        this.portalOutlet.dispose();
    }
    startModalNavigation() {
        const frame = this.parentView instanceof Frame ? this.parentView : this.parentView?.page?.frame || Frame.topmost();
        this.location?._beginModalNavigation(frame);
    }
};
NativeModalRef = __decorate([
    __param(2, Optional()),
    __metadata("design:paramtypes", [NativeDialogConfig, Injector, NSLocationStrategy])
], NativeModalRef);
export { NativeModalRef };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlLW1vZGFsLXJlZi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2FuZ3VsYXIvc3JjL2xpYi9jZGsvZGlhbG9nL25hdGl2ZS1tb2RhbC1yZWYudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsd0JBQXdCLEVBQWlDLFFBQVEsRUFBRSxRQUFRLEVBQW9CLE1BQU0sZUFBZSxDQUFDO0FBQzlJLE9BQU8sRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBUSxNQUFNLG9CQUFvQixDQUFDO0FBQzNFLE9BQU8sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDcEUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDOUUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFcEQsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDNUUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFckQsSUFBYSxjQUFjLEdBQTNCLE1BQWEsY0FBYztJQWF6QixZQUFvQixPQUEyQixFQUFVLFNBQW1CLEVBQWMsUUFBcUM7UUFBM0csWUFBTyxHQUFQLE9BQU8sQ0FBb0I7UUFBVSxjQUFTLEdBQVQsU0FBUyxDQUFVO1FBQXNCLGFBQVEsR0FBUixRQUFRLENBQXFCO1FBWC9ILGlCQUFZLEdBQUcsSUFBSSxPQUFP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QixFQUFxQixRQUFRLEVBQWlDLGtCQUFrQjtHQWJwSCxjQUFjLENBZ0kxQjtTQWhJWSxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwbGljYXRpb25SZWYsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBFbWJlZGRlZFZpZXdSZWYsIEluamVjdG9yLCBPcHRpb25hbCwgVmlld0NvbnRhaW5lclJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQXBwbGljYXRpb24sIENvbnRlbnRWaWV3LCBGcmFtZSwgVmlldyB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBcHBIb3N0QXN5bmNWaWV3LCBBcHBIb3N0VmlldyB9IGZyb20gJy4uLy4uL2FwcC1ob3N0LXZpZXcnO1xuaW1wb3J0IHsgTlNMb2NhdGlvblN0cmF0ZWd5IH0gZnJvbSAnLi4vLi4vbGVnYWN5L3JvdXRlci9ucy1sb2NhdGlvbi1zdHJhdGVneSc7XG5pbXBvcnQgeyBvbmNlIH0gZnJvbSAnLi4vLi4vdXRpbHMvZ2VuZXJhbCc7XG5pbXBvcnQgeyBOZ1ZpZXdSZWYgfSBmcm9tICcuLi8uLi92aWV3LXJlZnMnO1xuaW1wb3J0IHsgRGV0YWNoZWRMb2FkZXIgfSBmcm9tICcuLi9kZXRhY2hlZC1sb2FkZXInO1xuaW1wb3J0IHsgQ29tcG9uZW50UG9ydGFsLCBUZW1wbGF0ZVBvcnRhbCB9IGZyb20gJy4uL3BvcnRhbC9jb21tb24nO1xuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RG9tUG9ydGFsT3V0bGV0IH0gZnJvbSAnLi4vcG9ydGFsL25zZG9tLXBvcnRhbC1vdXRsZXQnO1xuaW1wb3J0IHsgTmF0aXZlRGlhbG9nQ29uZmlnIH0gZnJvbSAnLi9kaWFsb2ctY29uZmlnJztcblxuZXhwb3J0IGNsYXNzIE5hdGl2ZU1vZGFsUmVmIHtcbiAgX2lkOiBzdHJpbmc7XG4gIHN0YXRlQ2hhbmdlZCA9IG5ldyBTdWJqZWN0PHsgc3RhdGU6ICdvcGVuZWQnIHwgJ2Nsb3NlZCcgfCAnY2xvc2luZycgfT4oKTtcbiAgb25EaXNtaXNzID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICBwYXJlbnRWaWV3OiBWaWV3O1xuICBwb3J0YWxPdXRsZXQ6IE5hdGl2ZVNjcmlwdERvbVBvcnRhbE91dGxldDtcbiAgZGV0YWNoZWRMb2FkZXJSZWY6IENvbXBvbmVudFJlZjxEZXRhY2hlZExvYWRlcj47XG4gIG1vZGFsVmlld1JlZjogTmdWaWV3UmVmPGFueT47XG5cbiAgcHJpdmF0ZSBfY2xvc2VDYWxsYmFjazogKCkgPT4gdm9pZDtcbiAgcHJpdmF0ZSBfaXNEaXNtaXNzZWQgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9jb25maWc6IE5hdGl2ZURpYWxvZ0NvbmZpZywgcHJpdmF0ZSBfaW5qZWN0b3I6IEluamVjdG9yLCBAT3B0aW9uYWwoKSBwcml2YXRlIGxvY2F0aW9uPzogTlNMb2NhdGlvblN0cmF0ZWd5KSB7XG4gICAgbGV0IHBhcmVudFZpZXcgPSB0aGlzLl9jb25maWcudmlld0NvbnRhaW5lclJlZj8uZWxlbWVudC5uYXRpdmVFbGVtZW50IHx8IEFwcGxpY2F0aW9uLmdldFJvb3RWaWV3KCk7XG5cbiAgICBpZiAoKHBhcmVudFZpZXcgaW5zdGFuY2VvZiBBcHBIb3N0VmlldyB8fCBwYXJlbnRWaWV3IGluc3RhbmNlb2YgQXBwSG9zdEFzeW5jVmlldykgJiYgcGFyZW50Vmlldy5uZ0FwcFJvb3QpIHtcbiAgICAgIHBhcmVudFZpZXcgPSBwYXJlbnRWaWV3Lm5nQXBwUm9vdDtcbiAgICB9XG5cbiAgICAvLyBfbmdEaWFsb2dSb290IGlzIHRoZSBmaXJzdCBjaGlsZCBvZiB0aGUgcHJldmlvdXNseSBkZXRhY2hlZCBwcm94eS5cbiAgICAvLyBJdCBzaG91bGQgaGF2ZSAndmlld0NvbnRyb2xsZXInIChpT1MpIG9yICdfZGlhbG9nRnJhZ21lbnQnIChBbmRyb2lkKSBhdmFpbGFibGUgZm9yXG4gICAgLy8gcHJlc2VudGluZyBmdXR1cmUgbW9kYWwgdmlld3MuXG4gICAgd2hpbGUgKHBhcmVudFZpZXcuX21vZGFsIHx8IHBhcmVudFZpZXcuX25nRGlhbG9nUm9vdCkge1xuICAgICAgcGFyZW50VmlldyA9IHBhcmVudFZpZXcuX21vZGFsIHx8IHBhcmVudFZpZXcuX25nRGlhbG9nUm9vdDtcbiAgICB9XG4gICAgdGhpcy5wYXJlbnRWaWV3ID0gcGFyZW50VmlldztcblxuICAgIHRoaXMuX2Nsb3NlQ2FsbGJhY2sgPSBvbmNlKGFzeW5jICgpID0+IHtcbiAgICAgIHRoaXMuc3RhdGVDaGFuZ2VkLm5leHQoeyBzdGF0ZTogJ2Nsb3NpbmcnIH0pO1xuICAgICAgaWYgKCF0aGlzLl9pc0Rpc21pc3NlZCkge1xuICAgICAgICB0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3Py5jbG9zZU1vZGFsKCk7XG4gICAgICB9XG4gICAgICBhd2FpdCB0aGlzLmxvY2F0aW9uPy5fY2xvc2VNb2RhbE5hdmlnYXRpb24oKTtcbiAgICAgIC8vIHRoaXMuZGV0YWNoZWRMb2FkZXJSZWY/LmRlc3Ryb3koKTtcbiAgICAgIGlmICh0aGlzLm1vZGFsVmlld1JlZj8uZmlyc3ROYXRpdmVMaWtlVmlldy5pc0xvYWRlZCkge1xuICAgICAgICBmcm9tRXZlbnQodGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldywgJ3VubG9hZGVkJylcbiAgICAgICAgICAucGlwZSh0YWtlKDEpKVxuICAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5zdGF0ZUNoYW5nZWQubmV4dCh7IHN0YXRlOiAnY2xvc2VkJyB9KSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnN0YXRlQ2hhbmdlZC5uZXh0KHsgc3RhdGU6ICdjbG9zZWQnIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgX2dlbmVyYXRlRGV0YWNoZWRDb250YWluZXIodmNSZWY/OiBWaWV3Q29udGFpbmVyUmVmKSB7XG4gICAgY29uc3QgZGV0YWNoZWRGYWN0b3J5ID0gKHRoaXMuX2NvbmZpZy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgfHwgdGhpcy5faW5qZWN0b3IuZ2V0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcikpLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KERldGFjaGVkTG9hZGVyKTtcbiAgICBpZiAodmNSZWYpIHtcbiAgICAgIHRoaXMuZGV0YWNoZWRMb2FkZXJSZWYgPSB2Y1JlZi5jcmVhdGVDb21wb25lbnQoZGV0YWNoZWRGYWN0b3J5KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kZXRhY2hlZExvYWRlclJlZiA9IGRldGFjaGVkRmFjdG9yeS5jcmVhdGUodGhpcy5fY29uZmlnLnZpZXdDb250YWluZXJSZWY/LmluamVjdG9yIHx8IHRoaXMuX2luamVjdG9yKTtcbiAgICAgIHRoaXMuX2luamVjdG9yLmdldChBcHBsaWNhdGlvblJlZikuYXR0YWNoVmlldyh0aGlzLmRldGFjaGVkTG9hZGVyUmVmLmhvc3RWaWV3KTtcbiAgICB9XG4gICAgdGhpcy5kZXRhY2hlZExvYWRlclJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBhdHRhY2hUZW1wbGF0ZVBvcnRhbDxUPihwb3J0YWw6IFRlbXBsYXRlUG9ydGFsPFQ+KTogRW1iZWRkZWRWaWV3UmVmPFQ+IHtcbiAgICB0aGlzLnN0YXJ0TW9kYWxOYXZpZ2F0aW9uKCk7XG4gICAgY29uc3QgdmNSZWYgPSBwb3J0YWwudmlld0NvbnRhaW5lclJlZiB8fCB0aGlzLl9jb25maWcudmlld0NvbnRhaW5lclJlZjtcbiAgICB0aGlzLl9nZW5lcmF0ZURldGFjaGVkQ29udGFpbmVyKHZjUmVmKTtcbiAgICBwb3J0YWwudmlld0NvbnRhaW5lclJlZiA9IHRoaXMuZGV0YWNoZWRMb2FkZXJSZWYuaW5zdGFuY2UudmM7XG4gICAgY29uc3QgdGFyZ2V0VmlldyA9IG5ldyBDb250ZW50VmlldygpO1xuICAgIHRoaXMucG9ydGFsT3V0bGV0ID0gbmV3IE5hdGl2ZVNjcmlwdERvbVBvcnRhbE91dGxldCh0YXJnZXRWaWV3LCB0aGlzLl9jb25maWcuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyIHx8IHRoaXMuX2luamVjdG9yLmdldChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpLCB0aGlzLl9pbmplY3Rvci5nZXQoQXBwbGljYXRpb25SZWYpLCB0aGlzLl9pbmplY3Rvcik7XG4gICAgY29uc3QgdGVtcGxhdGVSZWYgPSB0aGlzLnBvcnRhbE91dGxldC5hdHRhY2gocG9ydGFsKTtcbiAgICB0aGlzLm1vZGFsVmlld1JlZiA9IG5ldyBOZ1ZpZXdSZWYodGVtcGxhdGVSZWYpO1xuICAgIHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXdbJ19fbmdfbW9kYWxfaWRfXyddID0gdGhpcy5faWQ7XG4gICAgLy8gaWYgd2UgZG9uJ3QgZGV0YWNoIHRoZSB2aWV3IGZyb20gaXRzIHBhcmVudCwgaW9zIGdldHMgbWFkXG4gICAgdGhpcy5tb2RhbFZpZXdSZWYuZGV0YWNoTmF0aXZlTGlrZVZpZXcoKTtcblxuICAgIGNvbnN0IHVzZXJPcHRpb25zID0gdGhpcy5fY29uZmlnLm5hdGl2ZU9wdGlvbnMgfHwge307XG4gICAgdGhpcy5wYXJlbnRWaWV3LnNob3dNb2RhbCh0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3LCB7XG4gICAgICBjb250ZXh0OiBudWxsLFxuICAgICAgLi4udXNlck9wdGlvbnMsXG4gICAgICBjbG9zZUNhbGxiYWNrOiBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMubG9jYXRpb24/Ll9jbG9zZU1vZGFsTmF2aWdhdGlvbigpO1xuICAgICAgICB0aGlzLm9uRGlzbWlzcy5uZXh0KCk7XG4gICAgICAgIHRoaXMub25EaXNtaXNzLmNvbXBsZXRlKCk7XG4gICAgICB9LFxuICAgICAgY2FuY2VsYWJsZTogIXRoaXMuX2NvbmZpZy5kaXNhYmxlQ2xvc2UsXG4gICAgfSk7XG4gICAgLy8gICBpZiAodGhpcy5tb2RhbFZpZXcgIT09IHRlbXBsYXRlUmVmLnJvb3ROb2Rlc1swXSkge1xuICAgIC8vICAgICBjb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudC5fbmdEaWFsb2dSb290ID0gdGhpcy5tb2RhbFZpZXc7XG4gICAgLy8gICB9XG4gICAgcmV0dXJuIHRlbXBsYXRlUmVmO1xuICB9XG5cbiAgYXR0YWNoQ29tcG9uZW50UG9ydGFsPFQ+KHBvcnRhbDogQ29tcG9uZW50UG9ydGFsPFQ+KTogQ29tcG9uZW50UmVmPFQ+IHtcbiAgICB0aGlzLnN0YXJ0TW9kYWxOYXZpZ2F0aW9uKCk7XG5cbiAgICBjb25zdCB0YXJnZXRWaWV3ID0gbmV3IENvbnRlbnRWaWV3KCk7XG4gICAgdGhpcy5wb3J0YWxPdXRsZXQgPSBuZXcgTmF0aXZlU2NyaXB0RG9tUG9ydGFsT3V0bGV0KHRhcmdldFZpZXcsIHRoaXMuX2NvbmZpZy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgfHwgdGhpcy5faW5qZWN0b3IuZ2V0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciksIHRoaXMuX2luamVjdG9yLmdldChBcHBsaWNhdGlvblJlZiksIHRoaXMuX2luamVjdG9yKTtcbiAgICBjb25zdCBjb21wb25lbnRSZWYgPSB0aGlzLnBvcnRhbE91dGxldC5hdHRhY2gocG9ydGFsKTtcbiAgICBjb21wb25lbnRSZWYuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIHRoaXMubW9kYWxWaWV3UmVmID0gbmV3IE5nVmlld1JlZihjb21wb25lbnRSZWYpO1xuICAgIGlmICh0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3ICE9PSB0aGlzLm1vZGFsVmlld1JlZi52aWV3KSB7XG4gICAgICAoPGFueT50aGlzLm1vZGFsVmlld1JlZi52aWV3KS5fbmdEaWFsb2dSb290ID0gdGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldztcbiAgICB9XG4gICAgdGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlld1snX19uZ19tb2RhbF9pZF9fJ10gPSB0aGlzLl9pZDtcbiAgICAvLyBpZiB3ZSBkb24ndCBkZXRhY2ggdGhlIHZpZXcgZnJvbSBpdHMgcGFyZW50LCBpb3MgZ2V0cyBtYWRcbiAgICB0aGlzLm1vZGFsVmlld1JlZi5kZXRhY2hOYXRpdmVMaWtlVmlldygpO1xuXG4gICAgY29uc3QgdXNlck9wdGlvbnMgPSB0aGlzLl9jb25maWcubmF0aXZlT3B0aW9ucyB8fCB7fTtcbiAgICB0aGlzLnBhcmVudFZpZXcuc2hvd01vZGFsKHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXcsIHtcbiAgICAgIGNvbnRleHQ6IG51bGwsXG4gICAgICAuLi51c2VyT3B0aW9ucyxcbiAgICAgIGNsb3NlQ2FsbGJhY2s6IGFzeW5jICgpID0+IHtcbiAgICAgICAgdGhpcy5faXNEaXNtaXNzZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLl9jbG9zZUNhbGxiYWNrKCk7IC8vIGNsb3NlIGNhbGxiYWNrIGNhbiBvbmx5IGJlIGNhbGxlZCBvbmNlLCBzbyB3ZSBjYWxsIGl0IGhlcmUgdG8gc2V0dXAgdGhlIGV4aXQgZXZlbnRzXG4gICAgICAgIHRoaXMub25EaXNtaXNzLm5leHQoKTtcbiAgICAgICAgdGhpcy5vbkRpc21pc3MuY29tcGxldGUoKTtcbiAgICAgIH0sXG4gICAgICBjYW5jZWxhYmxlOiAhdGhpcy5fY29uZmlnLmRpc2FibGVDbG9zZSxcbiAgICB9KTtcbiAgICByZXR1cm4gY29tcG9uZW50UmVmO1xuICB9XG5cbiAgX3N0YXJ0RXhpdEFuaW1hdGlvbigpIHtcbiAgICB0aGlzLl9jbG9zZUNhbGxiYWNrKCk7XG4gIH1cblxuICBkaXNwb3NlKCkge1xuICAgIHRoaXMucG9ydGFsT3V0bGV0LmRpc3Bvc2UoKTtcbiAgfVxuICBwcml2YXRlIHN0YXJ0TW9kYWxOYXZpZ2F0aW9uKCkge1xuICAgIGNvbnN0IGZyYW1lID0gdGhpcy5wYXJlbnRWaWV3IGluc3RhbmNlb2YgRnJhbWUgPyB0aGlzLnBhcmVudFZpZXcgOiB0aGlzLnBhcmVudFZpZXc/LnBhZ2U/LmZyYW1lIHx8IEZyYW1lLnRvcG1vc3QoKTtcblxuICAgIHRoaXMubG9jYXRpb24/Ll9iZWdpbk1vZGFsTmF2aWdhdGlvbihmcmFtZSk7XG4gIH1cbn1cbiJdfQ==